<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>不客观和非爱情</title>
    <link href="/2024/12/28/%E4%B8%8D%E5%AE%A2%E8%A7%82%E5%92%8C%E9%9D%9E%E7%88%B1%E6%83%85/"/>
    <url>/2024/12/28/%E4%B8%8D%E5%AE%A2%E8%A7%82%E5%92%8C%E9%9D%9E%E7%88%B1%E6%83%85/</url>
    
    <content type="html"><![CDATA[<span id="more"></span><h1 id="不客观和非爱情">不客观和非爱情</h1><p><em>“一无所知的人也就一无所爱，什么都不做的人也就什么都不懂。什么都不懂的人是没有价值的。懂得事理的人也懂得爱、观察、发现……对事物本质了解得越多，也就越钟爱……设想所有水果和草莓同时成熟得人，对葡萄一无所知。”</em></p><p>如果成熟的果实才是甘甜的，那么青涩是不是毫无意义？不懂得事理、懵懂的时期，值得纪念吗？</p><p>灵动的眼神，清澈的声音，活跃的表情，身上总是香香。我对她心怀爱慕，却羞于启齿。</p><p>我的第一次爱慕也是最后一次爱慕始于我懵懂的初中时期，说是爱慕未免有些言重，更说明白一点就是小孩子对美好事物的感知、尝试吧。暂不提其中多多少少的曲折，只是宽度这段关系便横跨我的中学和大学两端，占据了我少年到青年的全部过程。从两米的距离拉长到一千一百公里，从单一的时刻错分成日日夜夜。我本人时常容易激起强烈兴趣，熊熊自我燃烧，而后这烈火又会飞速下降衰退。但这份不知名的感情从起始寄生在稚嫩的个体里，循环缠绕，蜷缩又舒张，如同一棵坚韧的植物，在春天和冬天螺旋往复，不断死去又复生。</p><p>初中那时我和她是同班同学，但不似寻常故事一见钟情。入学时我还未配眼镜，小学时隐隐约约就有些近视的感觉了，但我身材瘦小加上成绩不错便总被安排在前排位置，也惧怕被父母批评，虽说黑板边角细细微微字痕还是看不清晰，也没提过近视的事情。</p><p>不凑巧的是，升学那天我是最后晚到教室的，后门进入一眼看去座位上已经全是人了，扫视一圈看到最后几排有几个空位没想太多就入座了，同桌和后桌同是女生。这对我来说是一个挑战，从更小到初中，被长辈“夸奖”最多的就是内向、安静，作为一个男孩缺少一些阳光和活力，但最终也没弄懂是怎么养成。表面毫不在意，但暗地里我早就竖起耳朵听着同桌和后桌来回讲话嬉笑，心中也悄悄的笑。等到上课我才知道我的近视已经成为无法忽略的问题了。从我所在的倒数第二排到看向黑板，全是黑黑白白的斑点，惨兮兮，看不清一点字痕。第二天我就去配对眼镜了，从此就多了一个新的固定装扮。</p><p>我和她第一次相识是英语课的问答，或是某一次换桌后的邻座，或是数学题的讨教，但记忆中总找不到一个精确的端点。后来我才知道，我和她第一次的交集就在开学的那天，她帮助老师统计学生信息，唯独缺少我迟来的那份。她早早记下我的名字，我却毫无印象，于是我如偿还般不断地在人生铭刻，心底留下缺口，将她填充。我对爱的认识很浅，或者说对爱没有概念。无论是起起落落书写的此刻还是过去，我始终觉得我并不懂爱是什么，也看过一些书籍，但更加疑惑。现在回想起来很多事都已经模糊了，甚至当时那份感情、那份潮湿又炙热的幻想也记不清了。就像一个个默默的夏天，让人想起的时候就已经过去，那时闷热但心动，现在却只是汗流。</p><p>中学时期印象深刻的事情不多，心中浮现的总是反反复复的几件，但总模模糊糊的记不清晰，像梦后醒来一样，在现实和现实之上，间隔着一层薄薄的水，偶尔波浪浮动，可幸运记起的那些事情像是真实的又像是美好的幻想，让人恼火。</p><p>我和她都尤为喜爱初二时的英语老师，她在课上严肃认真，但私下却总是微笑，很是让人安心，教导起来耐心又仔细，帮助我搭建了很不错的英语基础。另一方面，这位严肃、严格、严厉的老师也很喜欢我和她，班上两个课代表便是我俩了，她时常叫我俩回答或者帮忙讲解问题，还将我们分为一组同学，坐在一起，一男一女。这让我对她更有好感。但当时却是不知，只觉得那时心中欣喜难言，直让内怯的人更讲不出话来。我和她各饰一角，演绎课本中的对话，我站在讲台不敢面向下方的同学，但更不敢看她的眼睛，她则大大方方、坦坦荡荡。虽然觉得尴尬，但每每英语课前我心中暗暗总有些期待，小小的两人组合让我窃喜，觉得有些特殊，有些契合。我从这平淡中也能尝出甜蜜。这次也会提问的吧？又能和她一起了？她也一定是这样想的吧？</p><p>我还记得我们做同桌的时候。我对她心中极为好奇和仰慕，但现实中反而不敢靠近，离她远远的，仿若靠近便是玷污和伤害。记得有次她问我数学题目，我在角落扫了一眼呜呼吐出几个不连贯的句子，便不再加以回应。当时只觉紧张又羞赧，我不敢去看她的表情，但想来定是十分困惑吧，当时羞于追问，现在也无处问询了。</p><p>抱有极大的好奇，我慢慢、远远、悄悄地靠近。仔细想想那时候，一切就像是被规定的推着向前，没有自我的想法，只是每天照常的生活着、学习中，突然之间就注意到另一个个体，此前她与其他人毫无不同，但恰在某一时刻就突然变得生动了、活泼了，仿佛一下拉近了许多，好像整个世界多了一些除了自己之外的东西，增加了许多生机。原来他人也和自己一样有趣。于是自一个小小的个体封闭的内心，枝芽伸出，以此为契机、养料慢慢地生长。对于那时来看，这份感情说是爱未免太过隆重，分为喜欢似也不妥，更多的也许是成长中对外界的好奇或者说渴望一个知己，希望了解，希望被了解。</p><p>也正如我想要的，她的存在满足了我的一切需要，替换了长久陪伴我的影子。我和她关系的进步是在初三时期。要分班了。团聚时我不能鼓起的勇气，在离散后反而从全身各处涌现，我和她表白了。在周末的傍晚或是下午，诉以衷肠。</p><p>她说她想要遇到和她默契的人，我自是不满足条件的。对一个只有课上公共必要的交流，私下却毫不了解的人，何谈默契与否？我默默将“默契”一词记录心中，仍怀揣着些美好的幻想。让人开心的是，这是我们交流的伊始，我那时自视不说甚高也是很高，中二也有几分幼稚的浪漫。结果是我们之间无话不谈。家庭问题，学业问题，处于青春时期的我们异质却又统一。升入高中我们进入不同学校，但关系并未远离，一经放假便兴奋的拿起手机，看看，听听，那些她所在，所经历的环境和事情。虽然从未亲身经历，但仅看着那些文字，相思、喜悦就要溢出心头。</p><p>但情况却愈是急转直下。对我来说，我以为我们足够了解了，每天不间断的聊天，也有了默契和心照不宣。我说：这就是喜欢吧，但可惜的是，对她来说不是。我们关系的破碎就以此为基础，现在想来不过无聊的争论，但那时却是万分紧急、性命攸关。我迫切地想要寻求我内心向往的恋情和虚荣，而她回应以我冷静。反讽的是，我们一边怀揣着不同的认知，一边更加依靠对方的支撑。</p><p>我的恋情是失败的。</p><p>如果这错综复杂的关系也如同寻常故事一般，以暗恋为始，只一个人在角落暗自欢喜，最后又以暗恋消散为终，那也算得上一段青春的美谈。但这一切逐渐超出两人能控制的边界，慢慢地沉入幼小年龄无法感知的深度，我只是懵懂着就做出了决定，做了想做和不想做的事情，做对了或者做错了。对她也是同样吧。我不断地向她逼近，不再满足于仍隔着一层的关系，而她则是略有懊恼地委婉回绝。自我最起始没有按捺住孤独，向她伸出感知的触角时，一切的恶果就已埋下。一如那没能送出的木簪，我削削打磨，留下的却只有木屑和刀痕。我们两个人的丝线相互缠绕，传输着一言一语，思想交融，但也形成一个厚茧，让我们变得与外界分离，与其他一切遮上一团迷雾，阻挡着各自真实的视线，各自宽慰愚弄自己，视而也不见。我们仍挣扎着靠近，一边倾诉着心声，一边又狂躁地激起矛盾。就仿佛互相寄生着，我们之间的距离越来越近，但也越来越难以呼吸。也许这失败有许多因素，但当时只是争辩着、震怒着，然后坠落、眼泪、破碎。回想起来，很多事情、很多感情都难以理解，但对于那时来讲，都是呕心沥血的拥抱、真真切切的伤害罢。</p><p>之所以说我的恋情是失败的，并非是说我们的结果是分开。失败，因为这段漫长顽固的关系带给我、我们的有青春的欢喜和倾诉，但更多的是疼痛，它以一种无法洞察的形式伴随我们自身的生长，奠定了对恋爱、对人生的态度。我不够平庸，不甘心落得泯然众人的下场，所以不能像轻易地拿起那样轻易放下，切断后又纠缠；我不够出色，不能像手执火剑的天使，扫清面前、未来的障碍，所以维持不了这段关系长久完整，纠缠后又切断。也许我并不懂责任和尊重，只是固执地追求一个结果，不间断不考虑地靠近和逼迫，于是那一切就类似于控制、占有一般，侵蚀她的自由，以及我的自由。而我置身其中，深陷泥潭，进退不得。仿佛有一个暗中蛰伏的魔鬼将我的灵魂分割，其中一部分脱离我的躯壳，却牢牢的被困在她的身体里，于是有一种令人痴迷的魔力，驱使着我忍受空虚和饥饿，不断追赶和徘徊。</p><p>迷离月影，捉月水中。我和她分分合合有过许多次，高中是最高亢也是矛盾最激烈的时期。归根结底，我们对于爱的理解不同，对于人际关系的认识不同。这本身没什么坏的，但当我们靠得太近，纠缠太深，这便化成一条无形的绳索，拆绕两人的脖颈，无情地将其挂在绞刑台，若是挣扎不舍，越是痛苦窒息。即使如此，这绳索也让人如此着迷，不舍离开。</p><p>结束无声无息地降临于寂静和分离。于是我真正明白了默契的含义。在我们最终背道而驰后，我落入了虚无主义的深渊，但这又好像一种救赎，获得了内心的平静，我失去了一些感知，但也不再挣扎、痛苦。我仍然内心空洞，无力却已无需去填充，她面无表情地离开，找到新的寄托。回忆起来，那些时光就好像多年前阳台洒落的阳光，闪耀着光芒，但陈旧、模糊，又似一条粘稠又甜蜜的河，不断流动在我的身体，沉溺的灵魂在其中滚动起伏。我竭力回想，仍记不起她的样貌、话语。欢喜、悔恨、不甘、迷恋，都已逝去，存留于我身体的只有一种来自过去的回响，一种朦朦的感觉。夜晚仍照旧降临，熟悉的名称和身影却偶尔在梦中才有所接触。只是闲暇时候，幻象般的记忆还是会闪回，那时我们同坐在一间教室，余光是黑板上未抹净的白晕，我张嘴说着什么，周围有陌生的同学身影晃动，窗外透来几缕夕阳的光。</p><p>灵动的眼神，清澈的声音，活跃的表情，身上总是香香的。我对她心怀爱慕，却难以启齿。</p>]]></content>
    
    
    <categories>
      
      <category>随笔</category>
      
    </categories>
    
    
    <tags>
      
      <tag>回忆</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>孤夜山行</title>
    <link href="/2024/12/08/%E5%AD%A4%E5%A4%9C%E5%B1%B1%E8%A1%8C/"/>
    <url>/2024/12/08/%E5%AD%A4%E5%A4%9C%E5%B1%B1%E8%A1%8C/</url>
    
    <content type="html"><![CDATA[<span id="more"></span><center>孤夜山行</center><center>繁云絮雨萦孤月，淡雾疏星隐夜明。</center><center>寂坐幽岩山欲语，徒归空路影虚行。</center>]]></content>
    
    
    <categories>
      
      <category>诗词</category>
      
    </categories>
    
    
    <tags>
      
      <tag>七绝</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mengzi-t5微调古诗生成模型</title>
    <link href="/2024/12/08/mengzi-t5%E5%BE%AE%E8%B0%83%E5%8F%A4%E8%AF%97%E7%94%9F%E6%88%90%E6%A8%A1%E5%9E%8B/"/>
    <url>/2024/12/08/mengzi-t5%E5%BE%AE%E8%B0%83%E5%8F%A4%E8%AF%97%E7%94%9F%E6%88%90%E6%A8%A1%E5%9E%8B/</url>
    
    <content type="html"><![CDATA[<span id="more"></span><h3 id="mengzi-t5预训练模型">mengzi-t5预训练模型</h3><p>首先在huggingface下载mengzi-t5-base模型以便后续训练。因为huggingface在国内下载速度较慢，可以使用代理下载，或者直接下载到本地再上传到服务器。这里使用<ahref="https://www.hf-mirror.com">镜像网站</a>下载。<br /><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">!curl -L -O https://hf-mirror.com/Langboat/mengzi-t5-base/resolve/main/pytorch_model.bin?download=True<br>!curl -L -O https://hf-mirror.com/Langboat/mengzi-t5-base/resolve/main/config.json?download=true<br>!curl -L -O https://hf-mirror.com/Langboat/mengzi-t5-base/resolve/main/spiece.vocab?download=true<br>!curl -L -O https://hf-mirror.com/Langboat/mengzi-t5-base/resolve/main/spiece.model?download=true<br></code></pre></td></tr></table></figure></p><h3 id="数据准备">数据准备</h3><h4 id="数据集下载">数据集下载</h4><p>这里的数据是使用<ahref="https://github.com/chinese-poetry/chinese-poetry">chinese-poetry</a>收集的唐诗宋词，由于飞桨平台已经内置该数据集，所以我们只需添加进来就可以了，这里是解压缩数据。<br /><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">!unzip -n ./data/data70759/poems_json.zip<br></code></pre></td></tr></table></figure></p><h4 id="数据处理">数据处理</h4><p>由于数据集中的诗词是繁体，使用chinese-converter库将繁体转换为简体。<br /><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">!pip install chinese-converter<br></code></pre></td></tr></table></figure></p><p>导入库。<br /><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">import</span> urllib.request<br><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br><span class="hljs-comment"># from tqdm.notebook import tqdm</span><br><span class="hljs-keyword">import</span> chinese_converter  <span class="hljs-comment"># 繁体到简体需要</span><br><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><br><span class="hljs-comment"># IS_TEST_FLOW = True</span><br>IS_TEST_FLOW = <span class="hljs-literal">False</span><br></code></pre></td></tr></table></figure></p><p>使用IS_TEST_FLOW作为测试和训练的标志，如果是测试则只处理少量数据。<br />数据集格式为json，每个json文件有1000首诗，格式如下：<br /><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">[</span><br>  <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;author&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;太宗皇帝&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;paragraphs&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>      <span class="hljs-string">&quot;秦川雄帝宅，函谷壯皇居。&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-string">&quot;綺殿千尋起，離宮百雉餘。&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-string">&quot;連甍遙接漢，飛觀迥凌虛。&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-string">&quot;雲日隱層闕，風煙出綺疎。&quot;</span><br>    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;note&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;帝京篇十首 一&quot;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">]</span><br></code></pre></td></tr></table></figure></p><p>处理json文件，创建df_list列表，每个元素是一个dataframe，最后使用pd.concat合并。<br /><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python">POEM_CONTENT = &#123;<br>    <span class="hljs-string">&#x27;tang&#x27;</span>: &#123;<br>        <span class="hljs-string">&#x27;total&#x27;</span>: <span class="hljs-number">58</span>,<br>        <span class="hljs-string">&#x27;pattern&#x27;</span>: <span class="hljs-string">&quot;./poems_json/poet.tang.&#123;0&#125;.json&quot;</span><br>    &#125;,<br>    <span class="hljs-string">&#x27;song&#x27;</span>: &#123;<br>        <span class="hljs-string">&#x27;total&#x27;</span>: <span class="hljs-number">255</span>,<br>        <span class="hljs-string">&#x27;pattern&#x27;</span>: <span class="hljs-string">&quot;./poems_json/poet.song.&#123;0&#125;.json&quot;</span><br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_poems</span>(<span class="hljs-params">is_test=<span class="hljs-literal">True</span>, verbose=<span class="hljs-literal">True</span></span>):<br>  df_list = []<br>  <span class="hljs-keyword">for</span> dynasty <span class="hljs-keyword">in</span> POEM_CONTENT:<br>    size = <span class="hljs-number">3</span> <span class="hljs-keyword">if</span> is_test <span class="hljs-keyword">else</span> POEM_CONTENT[dynasty][<span class="hljs-string">&#x27;total&#x27;</span>]<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(size):<br>      url = POEM_CONTENT[dynasty][<span class="hljs-string">&#x27;pattern&#x27;</span>].<span class="hljs-built_in">format</span>(i * <span class="hljs-number">1000</span>)<br>      <span class="hljs-keyword">if</span> verbose:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;load <span class="hljs-subst">&#123;url&#125;</span> now&quot;</span>)<br>      df_list.append(pd.read_json(url))<br>  <span class="hljs-keyword">return</span> pd.concat(df_list)<br></code></pre></td></tr></table></figure></p><p>使用df.apply将繁体转换为简体。<br /><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python">df = get_poems(is_test=IS_TEST_FLOW, verbose=<span class="hljs-literal">True</span>)<br>df[<span class="hljs-string">&#x27;concat_paragraphs&#x27;</span>] = [<span class="hljs-string">&#x27;&#x27;</span>.join(<span class="hljs-built_in">map</span>(<span class="hljs-built_in">str</span>, l)) <span class="hljs-keyword">for</span> l <span class="hljs-keyword">in</span> df[<span class="hljs-string">&#x27;paragraphs&#x27;</span>]]<br>df = df[[<span class="hljs-string">&#x27;author&#x27;</span>, <span class="hljs-string">&#x27;title&#x27;</span>, <span class="hljs-string">&#x27;concat_paragraphs&#x27;</span>]]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">convert_schinese</span>(<span class="hljs-params">tchinese</span>):<br>  <span class="hljs-keyword">return</span> chinese_converter.to_simplified(tchinese)<br><br>df[<span class="hljs-string">&#x27;s_content&#x27;</span>] = df.apply(<span class="hljs-keyword">lambda</span> row: convert_schinese(<span class="hljs-string">&#x27;&#x27;</span>.join(row.concat_paragraphs)), axis=<span class="hljs-number">1</span>)<br>df[<span class="hljs-string">&#x27;s_title&#x27;</span>] = df.apply(<span class="hljs-keyword">lambda</span> row: convert_schinese(<span class="hljs-string">&#x27;&#x27;</span>.join(row.title)), axis=<span class="hljs-number">1</span>)<br>df[<span class="hljs-string">&#x27;s_author&#x27;</span>] = df.apply(<span class="hljs-keyword">lambda</span> row: convert_schinese(<span class="hljs-string">&#x27;&#x27;</span>.join(row.author)), axis=<span class="hljs-number">1</span>)<br><br>my_df = df<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;my_df size&quot;</span>, <span class="hljs-built_in">len</span>(my_df))<br></code></pre></td></tr></table></figure></p><p>创建trim函数，替换掉一些特殊字符，限制作者、标题、内容的长度。<br /><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python">MAX_AUTHOR_CHAR = <span class="hljs-number">4</span><br>MAX_TITLE_CHAR = <span class="hljs-number">12</span><br>MIN_CONTENT_CHAR = <span class="hljs-number">20</span><br>MAX_CONTENT_CHAR = <span class="hljs-number">32</span><br>BAD_TOKENS = <span class="hljs-string">&quot; ()[]《》（）□&#123;&#125;abcdefgxyz一&quot;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">trim_author_fn</span>(<span class="hljs-params">row</span>):<br>  <span class="hljs-keyword">return</span> row.s_author[:MAX_AUTHOR_CHAR]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">trim_title_fn</span>(<span class="hljs-params">row</span>):<br>  trimed_title = row.s_title[:MAX_TITLE_CHAR]<br>  <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> BAD_TOKENS:<br>    trimed_title = trimed_title.replace(b, <span class="hljs-string">&quot;&quot;</span>)<br>  <span class="hljs-keyword">return</span> trimed_title<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">trim_content_fn</span>(<span class="hljs-params">row</span>):<br>  trimed_content = row.s_content[:MAX_CONTENT_CHAR]<br>  <span class="hljs-comment"># # End with a period to avoid partial ending to confuse model</span><br>  <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> BAD_TOKENS:<br>    trimed_content = trimed_content.replace(b, <span class="hljs-string">&quot;&quot;</span>)<br>  last_period = trimed_content.rfind(<span class="hljs-string">&quot;。&quot;</span>)<br>  <span class="hljs-keyword">return</span> trimed_content[:last_period+<span class="hljs-number">1</span>]<br>  <span class="hljs-comment"># return trimed_content</span><br><br><span class="hljs-comment"># Trim the size, a soft copy to avoid the view/copy conflict warning</span><br>my_df[<span class="hljs-string">&#x27;s_author_trim&#x27;</span>] = my_df.copy().apply(trim_author_fn, axis=<span class="hljs-number">1</span>)<br>my_df[<span class="hljs-string">&#x27;s_title_trim&#x27;</span>] = my_df.copy().apply(trim_title_fn, axis=<span class="hljs-number">1</span>)<br>my_df[<span class="hljs-string">&#x27;s_content_trim&#x27;</span>] = my_df.copy().apply(trim_content_fn, axis=<span class="hljs-number">1</span>)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;my_df size&quot;</span>, <span class="hljs-built_in">len</span>(my_df))<br></code></pre></td></tr></table></figure></p><p>过滤掉一些无效数据，比如标题为空、内容太短、无正文等。<br /><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Title cannot be empty</span><br>empty_title_mask = (my_df[<span class="hljs-string">&#x27;s_title_trim&#x27;</span>].<span class="hljs-built_in">str</span>.<span class="hljs-built_in">len</span>() == <span class="hljs-number">0</span>)<br>too_short_cotent_mask = (my_df[<span class="hljs-string">&#x27;s_content_trim&#x27;</span>].<span class="hljs-built_in">str</span>.<span class="hljs-built_in">len</span>() &lt;= MIN_CONTENT_CHAR)<br>invalid_mask = ((<span class="hljs-string">&#x27;无正文&#x27;</span> == my_df[<span class="hljs-string">&#x27;s_content_trim&#x27;</span>]) | (<span class="hljs-string">&#x27;无正文&#x27;</span> == my_df[<span class="hljs-string">&#x27;s_author_trim&#x27;</span>]))<br>too_short_mask =  empty_title_mask | too_short_cotent_mask | invalid_mask<br><span class="hljs-comment"># filtered_my_df = my_df.loc[too_short_mask]</span><br><span class="hljs-comment"># filtered_my_df</span><br><br>my_df = my_df.loc[~too_short_mask][[<br>  <span class="hljs-string">&#x27;s_author_trim&#x27;</span>, <span class="hljs-string">&#x27;s_title_trim&#x27;</span>, <span class="hljs-string">&#x27;s_content_trim&#x27;</span>]]<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;my_df size&quot;</span>, <span class="hljs-built_in">len</span>(my_df))<br></code></pre></td></tr></table></figure></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> re<br>result_dict = &#123;<br>    <span class="hljs-string">&#x27;s_author_trim&#x27;</span>: [],<br>    <span class="hljs-string">&#x27;s_title_trim&#x27;</span>: [],<br>    <span class="hljs-string">&#x27;s_content_trim&#x27;</span>: [],<br>&#125;<br><span class="hljs-keyword">for</span> i, row <span class="hljs-keyword">in</span> my_df.iterrows():<br>  c = row[<span class="hljs-string">&#x27;s_content_trim&#x27;</span>]<br>  snippets = <span class="hljs-built_in">list</span>(re.split(<span class="hljs-string">&#x27;，|。|？&#x27;</span>, c))<br>  lens = [<span class="hljs-built_in">len</span>(s) <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> snippets <span class="hljs-keyword">if</span> s.strip() != <span class="hljs-string">&#x27;&#x27;</span>]<br>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">max</span>(lens) != <span class="hljs-built_in">min</span>(lens) <span class="hljs-keyword">or</span> <span class="hljs-built_in">max</span>(lens) <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> [<span class="hljs-number">5</span>, <span class="hljs-number">7</span>]:<br>    <span class="hljs-keyword">continue</span><br>  result_dict[<span class="hljs-string">&#x27;s_author_trim&#x27;</span>].append(row[<span class="hljs-string">&#x27;s_author_trim&#x27;</span>])<br>  result_dict[<span class="hljs-string">&#x27;s_title_trim&#x27;</span>].append(row[<span class="hljs-string">&#x27;s_title_trim&#x27;</span>])<br>  result_dict[<span class="hljs-string">&#x27;s_content_trim&#x27;</span>].append(c)<br><span class="hljs-comment"># print(&quot;get rid of &quot;, sum(bad_items))</span><br>my_df = pd.DataFrame(data=result_dict)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;left&quot;</span>, <span class="hljs-built_in">len</span>(my_df))<br></code></pre></td></tr></table></figure><h4 id="构建数据集">构建数据集</h4><p>构建数据集，包括source_text和target_text。<br /><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python">AUTHOR_PROMPT = <span class="hljs-string">&quot;模仿：&quot;</span><br>TITLE_PROMPT = <span class="hljs-string">&quot;作诗：&quot;</span><br>EOS_TOKEN = <span class="hljs-string">&#x27;&lt;/s&gt;&#x27;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">build_dataset_df</span>(<span class="hljs-params">df, include_author=<span class="hljs-literal">True</span></span>):<br>  dfc = df.copy()<br>  <span class="hljs-keyword">if</span> include_author:<br>    dfc[<span class="hljs-string">&#x27;source_text&#x27;</span>] = TITLE_PROMPT + df[<span class="hljs-string">&#x27;s_title_trim&#x27;</span>] + EOS_TOKEN + AUTHOR_PROMPT + df[<span class="hljs-string">&#x27;s_author_trim&#x27;</span>]<br>  <span class="hljs-keyword">else</span>:<br>    dfc[<span class="hljs-string">&#x27;source_text&#x27;</span>] = TITLE_PROMPT + df[<span class="hljs-string">&#x27;s_title_trim&#x27;</span>]<br>  dfc[<span class="hljs-string">&#x27;target_text&#x27;</span>] = df[<span class="hljs-string">&#x27;s_content_trim&#x27;</span>]<br>  dfc = dfc[[<span class="hljs-string">&#x27;source_text&#x27;</span>, <span class="hljs-string">&#x27;target_text&#x27;</span>]]<br>  <span class="hljs-keyword">return</span> dfc<br></code></pre></td></tr></table></figure></p><p>带有作者的数据集。<br /><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">df_author_title_content = build_dataset_df(my_df, <span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure></p><p>不带作者的数据集。<br /><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">df_title_content = build_dataset_df(my_df, <span class="hljs-literal">False</span>)<br></code></pre></td></tr></table></figure></p><p>合并数据集。<br /><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">merged_df = pd.concat([df_author_title_content, df_title_content])<br>merged_df = merged_df.sample(frac=<span class="hljs-number">1.</span>)<br></code></pre></td></tr></table></figure> 这里的frac=1.表示打乱数据集。</p><h3 id="训练">训练</h3><p>安装一下torch, simplet5等必要库。<br /><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">!pip install torch<br>!pip install simplet5<br>import torch<br>from simplet5 import SimpleT5<br>from transformers import T5Tokenizer, T5ForConditionalGeneration<br></code></pre></td></tr></table></figure></p><h4 id="定义模型">定义模型</h4><p>定义模型类，继承SimpleT5，加载mengzi-t5-base模型。<br /><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python">torch.cuda.empty_cache()<br><br><span class="hljs-comment"># 指定本地模型路径</span><br><span class="hljs-comment"># local_model_path = &quot;./mengzi_t5_base&quot;</span><br>local_model_path = <span class="hljs-string">&quot;./MengziT5_base&quot;</span><br><br><span class="hljs-comment"># 定义 extra_ids 数量</span><br>extra_ids = <span class="hljs-number">100</span><br><br><span class="hljs-comment"># 创建包含所有 extra_ids 的特殊标记列表</span><br>additional_special_tokens = [<span class="hljs-string">f&quot;&lt;extra_id_<span class="hljs-subst">&#123;i&#125;</span>&gt;&quot;</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(extra_ids)]<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MengziSimpleT5</span>(<span class="hljs-title class_ inherited__">SimpleT5</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:<br>    <span class="hljs-built_in">super</span>().__init__()<br>    <span class="hljs-variable language_">self</span>.device = torch.device(<span class="hljs-string">&quot;cuda&quot;</span>)<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">load_my_model</span>(<span class="hljs-params">self, use_gpu: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">True</span></span>):<br>    <span class="hljs-comment"># self.tokenizer = T5Tokenizer.from_pretrained(local_model_path,</span><br>    <span class="hljs-comment"># extra_ids=extra_ids,</span><br>    <span class="hljs-comment"># additional_special_tokens=additional_special_tokens)</span><br>    <span class="hljs-variable language_">self</span>.tokenizer = T5Tokenizer.from_pretrained(local_model_path)<br>    <span class="hljs-variable language_">self</span>.model = T5ForConditionalGeneration.from_pretrained(local_model_path)<br><br>model = MengziSimpleT5()<br>model.load_my_model()<br>model.model = model.model.to(<span class="hljs-string">&#x27;cuda&#x27;</span>)<br></code></pre></td></tr></table></figure></p><h4 id="划分数据集">划分数据集</h4><p>将数据集以0.98, 0.02的比例划分为训练集和验证集。 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> train_test_split<br>merged_df = merged_df.sample(frac=<span class="hljs-number">1</span>) <span class="hljs-comment"># Shuffle</span><br>train_df, eval_df = train_test_split(merged_df, test_size=<span class="hljs-number">0.02</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;train&quot;</span>, <span class="hljs-built_in">len</span>(train_df), <span class="hljs-string">&quot;eval&quot;</span>, <span class="hljs-built_in">len</span>(eval_df))<br></code></pre></td></tr></table></figure></p><h4 id="训练模型">训练模型</h4><p>训练模型，使用train_df训练，eval_df验证。<br /><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">model.train(train_df=train_df,<br>            eval_df=eval_df,<br>            source_max_token_len=(<span class="hljs-built_in">len</span>(TITLE_PROMPT) + MAX_TITLE_CHAR +  <span class="hljs-number">1</span> + <span class="hljs-built_in">len</span>(AUTHOR_PROMPT) + MAX_AUTHOR_CHAR),<br>            target_max_token_len=MAX_CONTENT_CHAR,<br>            batch_size=<span class="hljs-number">256</span>,<br>            max_epochs=<span class="hljs-number">5</span>,<br>            use_gpu=<span class="hljs-literal">True</span>,<br>            outputdir=<span class="hljs-string">&quot;./Models/t5-poem-v2.1&quot;</span>)<br></code></pre></td></tr></table></figure></p><h4 id="测试模型">测试模型</h4><p>使用模型生成诗词。<br /><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">poem</span>(<span class="hljs-params">title_str, opt_author=<span class="hljs-literal">None</span>, model=model,</span><br><span class="hljs-params">         is_input_traditional_chinese=<span class="hljs-literal">False</span>,</span><br><span class="hljs-params">         num_beams=<span class="hljs-number">2</span></span>):<br>  model.model = model.model.to(<span class="hljs-string">&#x27;cuda&#x27;</span>)<br>  <span class="hljs-keyword">if</span> opt_author:<br>    in_request = TITLE_PROMPT + title_str[:MAX_TITLE_CHAR] + EOS_TOKEN + AUTHOR_PROMPT + opt_author[:MAX_AUTHOR_CHAR]<br>  <span class="hljs-keyword">else</span>:<br>    in_request = TITLE_PROMPT + title_str[:MAX_TITLE_CHAR]<br>  <span class="hljs-keyword">if</span> is_input_traditional_chinese:<br>    in_request = chinese_converter.to_simplified(in_request)<br>  out = model.predict(in_request,<br>                      max_length=MAX_CONTENT_CHAR,<br>                      num_beams=num_beams)[<span class="hljs-number">0</span>].replace(<span class="hljs-string">&quot;,&quot;</span>, <span class="hljs-string">&quot;，&quot;</span>)<br>  <span class="hljs-keyword">if</span> is_input_traditional_chinese:<br>    out = chinese_converter.to_traditional(out)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;標題： <span class="hljs-subst">&#123;in_request.replace(<span class="hljs-string">&#x27;&lt;/s&gt;&#x27;</span>, <span class="hljs-string">&#x27; &#x27;</span>)&#125;</span>\n詩歌： <span class="hljs-subst">&#123;out&#125;</span>&quot;</span>)<br>  <span class="hljs-keyword">else</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;标题： <span class="hljs-subst">&#123;in_request.replace(<span class="hljs-string">&#x27;&lt;/s&gt;&#x27;</span>, <span class="hljs-string">&#x27; &#x27;</span>)&#125;</span>\n诗歌： <span class="hljs-subst">&#123;out&#125;</span>&quot;</span>)<br></code></pre></td></tr></table></figure></p><p>测试模型。<br /><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">for</span> title <span class="hljs-keyword">in</span> [<span class="hljs-string">&#x27;秋思&#x27;</span>, <span class="hljs-string">&quot;百花&quot;</span>, <span class="hljs-string">&#x27;佳人有约&#x27;</span>]:<br>  <span class="hljs-comment"># Empty author means general style</span><br>  <span class="hljs-keyword">for</span> author <span class="hljs-keyword">in</span> [<span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">&quot;杜甫&quot;</span>, <span class="hljs-string">&quot;李白&quot;</span>, <span class="hljs-string">&quot;李清照&quot;</span>, <span class="hljs-string">&quot;苏轼&quot;</span>]:<br>    poem(title, author)<br>  <span class="hljs-built_in">print</span>()<br></code></pre></td></tr></table></figure></p><p>使用不同的num_beams测试模型。<br /><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">for</span> title <span class="hljs-keyword">in</span> [<span class="hljs-string">&#x27;冬雪&#x27;</span>]:<br>  <span class="hljs-keyword">for</span> author <span class="hljs-keyword">in</span>  [<span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">&quot;杜甫&quot;</span>]:<br>    <span class="hljs-keyword">for</span> num_beams <span class="hljs-keyword">in</span> (<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">10</span>, <span class="hljs-number">20</span>, <span class="hljs-number">50</span>, <span class="hljs-number">100</span>, <span class="hljs-number">200</span>):<br>      <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;num beams: <span class="hljs-subst">&#123;num_beams&#125;</span>&quot;</span>)<br>      poem(title, author, num_beams=num_beams)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-&quot;</span>*<span class="hljs-number">80</span>)<br></code></pre></td></tr></table></figure></p><h3 id="使用模型">使用模型</h3><p>使用模型生成诗词。<br /><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> LogitsProcessor<br><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> LogitsProcessorList<br><br><span class="hljs-comment"># 具体代码</span><br><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">from</span> simplet5 <span class="hljs-keyword">import</span> SimpleT5<br><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> T5Tokenizer, T5ForConditionalGeneration<br><span class="hljs-keyword">import</span> chinese_converter<br><br>MODEL_PATH = <span class="hljs-string">&quot;./Models/t5-poem-v2.1/simplet5-epoch-4-train-loss-3.4329-val-loss-3.4315&quot;</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">PoemModel</span>(<span class="hljs-title class_ inherited__">SimpleT5</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:<br>    <span class="hljs-built_in">super</span>().__init__()<br>    <span class="hljs-variable language_">self</span>.device = torch.device(<span class="hljs-string">&quot;cuda&quot;</span>)<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">load_my_model</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-variable language_">self</span>.tokenizer = T5Tokenizer.from_pretrained(MODEL_PATH)<br>    <span class="hljs-variable language_">self</span>.model = T5ForConditionalGeneration.from_pretrained(MODEL_PATH)<br></code></pre></td></tr></table></figure></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 有一些预先设定参数</span><br>AUTHOR_PROMPT = <span class="hljs-string">&quot;模仿：&quot;</span><br>TITLE_PROMPT = <span class="hljs-string">&quot;作诗：&quot;</span><br>EOS_TOKEN = <span class="hljs-string">&#x27;&lt;/s&gt;&#x27;</span><br><br>poem_model = PoemModel()<br>poem_model.load_my_model()<br>poem_model.model = poem_model.model.to(<span class="hljs-string">&#x27;cuda&#x27;</span>)<br><br>MAX_AUTHOR_CHAR = <span class="hljs-number">4</span><br>MAX_TITLE_CHAR = <span class="hljs-number">12</span><br>MIN_CONTENT_CHAR = <span class="hljs-number">10</span><br>MAX_CONTENT_CHAR = <span class="hljs-number">64</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">poem</span>(<span class="hljs-params">title_str, opt_author=<span class="hljs-literal">None</span>, model=poem_model,</span><br><span class="hljs-params">         is_input_traditional_chinese=<span class="hljs-literal">False</span>,</span><br><span class="hljs-params">         num_beams=<span class="hljs-number">100</span></span>):<br>  model.model = model.model.to(<span class="hljs-string">&#x27;cuda&#x27;</span>)<br>  <span class="hljs-keyword">if</span> opt_author:<br>    in_request = TITLE_PROMPT + title_str[:MAX_TITLE_CHAR] + EOS_TOKEN + AUTHOR_PROMPT + opt_author[:MAX_AUTHOR_CHAR]<br>  <span class="hljs-keyword">else</span>:<br>    in_request = TITLE_PROMPT + title_str[:MAX_TITLE_CHAR]<br>  <span class="hljs-keyword">if</span> is_input_traditional_chinese:<br>    in_request = chinese_converter.to_simplified(in_request)<br>  out = model.predict(in_request,<br>                      max_length=MAX_CONTENT_CHAR,<br>                      num_beams=num_beams)[<span class="hljs-number">0</span>].replace(<span class="hljs-string">&quot;,&quot;</span>, <span class="hljs-string">&quot;，&quot;</span>)<br>                      <span class="hljs-comment"># logits_processor=LogitsProcessorList([rhyme_processor]))[0].replace(&quot;,&quot;, &quot;，&quot;)</span><br><br>  <br>  <span class="hljs-keyword">if</span> is_input_traditional_chinese:<br>    out = chinese_converter.to_traditional(out)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;標題： <span class="hljs-subst">&#123;in_request.replace(<span class="hljs-string">&#x27;&lt;/s&gt;&#x27;</span>, <span class="hljs-string">&#x27; &#x27;</span>)&#125;</span>\n詩歌： <span class="hljs-subst">&#123;out&#125;</span>&quot;</span>)<br>  <span class="hljs-keyword">else</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;标题： <span class="hljs-subst">&#123;in_request.replace(<span class="hljs-string">&#x27;&lt;/s&gt;&#x27;</span>, <span class="hljs-string">&#x27; &#x27;</span>)&#125;</span>\n诗歌： <span class="hljs-subst">&#123;out&#125;</span>&quot;</span>)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">for</span> title <span class="hljs-keyword">in</span> [<span class="hljs-string">&#x27;秋思&#x27;</span>, <span class="hljs-string">&#x27;佳人&#x27;</span>, <span class="hljs-string">&#x27;相思&#x27;</span>,<span class="hljs-string">&quot;幽梦&quot;</span>]:<br>  <span class="hljs-comment"># Empty author means general style</span><br>  <span class="hljs-keyword">for</span> author <span class="hljs-keyword">in</span> [<span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">&quot;杜甫&quot;</span>, <span class="hljs-string">&quot;李白&quot;</span>, <span class="hljs-string">&quot;李清照&quot;</span>, <span class="hljs-string">&quot;苏轼&quot;</span>]:<br>    poem(title, author)<br>  <span class="hljs-built_in">print</span>()<br></code></pre></td></tr></table></figure><h3 id="结论">结论</h3><p>微调mengzi-t5模型，使用唐诗宋词数据集训练了古诗生成模型，实现古诗生成。</p><p>slide见<ahref="https://github.com/symcreg/poem_generate/blob/main/slide.pptx">这里</a>。<br />实现效果在<ahref="https://github.com/symcreg/poem_generate/blob/main/presentation.mp4">这里</a>。<br />github地址：<ahref="https://github.com/symcreg/poem_generate">poem_generate</a><br />飞桨地址：<ahref="https://aistudio.baidu.com/projectdetail/8620151">test</a><br />主要参考（抄）了<ahref="https://github.com/hululuzhu/chinese-ai-writing-share">chinese-ai-writing-share</a></p><h3 id="参考">参考</h3><ol start="0" type="1"><li><a href="https://aistudio.baidu.com/overview">aistudio</a></li><li><ahref="https://github.com/chinese-poetry/chinese-poetry">chinese-poetry</a><br /></li><li><a href="https://hf-mirror.com">hf-mirror</a><br /></li><li><ahref="https://github.com/hululuzhu/chinese-ai-writing-share">chinese-ai-writing-share</a><br /></li><li><ahref="https://github.com/wangjiezju1988/aichpoem">aichpoem</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>机器学习</category>
      
    </categories>
    
    
    <tags>
      
      <tag>模型训练</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>随笔记梦</title>
    <link href="/2024/11/26/%E9%9A%8F%E7%AC%94%E8%AE%B0%E6%A2%A6/"/>
    <url>/2024/11/26/%E9%9A%8F%E7%AC%94%E8%AE%B0%E6%A2%A6/</url>
    
    <content type="html"><![CDATA[<h1 id="随笔记梦">随笔记梦</h1><p>霎时天摇地动，乾翻坤覆，六合迫临，四野俱寂。日及天心，耀光极明，若金虹贯空，若烈焰腾舞，五色斑斓，七彩绚烂，万象为之失辉。余心振荡不怡，魂惊魄散，神骇思移，恍惚兮若行至云端，缥缈兮如坠入乱流；迷离兮若踏及夜明，惶惑兮如置身于幻海茫茫。悚怛而起，余已涕泪满面。</p><p>梦者，真伪难辨；迷途，虚实莫测。天旋地转间，觉一切如镜中花，水中月，虽近在咫尺，却不可触。怔然滞目，心中寂寂。</p><h2 id="section">2024-11-30</h2><p>清风拂面，细雨如织。凄凄芳草，曳曳江荻。转眄无聚，步履无依。徙倚彷徨，洎乎幽苑。门阍轻掩，玉砌呈前。方至其间，见珠帘翠影，闻琴瑟悠悠。音符清丽，芳影翩翩。却听耳畔幽幽轻叹：“歧路兮莫徘徊，迷途兮何眷恋？君至此，奈所何？此生已矣，来世再续。”语毕，愁云蔽日，悲雨霏霏。弦断琴残，珠泪纵流。余顾盼身侧，空余烟波。萧萧风雨，独自凄凄。九天浩浩，无以容此身；宙宇茫茫，无以载此心。</p><p>于是天摇地动，乾翻坤覆，六合迫临，四野俱寂。日及天心，耀光极明，若金虹贯空，若烈焰腾舞，五色斑斓，七彩绚烂，万象失辉，应星不煜。余心振荡不怡兮，身战栗而局躅。魂惊魄摇，神骇精移，恍惚兮若行至云端，缥缈兮如坠入乱流；迷离兮若踏及夜明，惶惑兮如置身于幻海茫茫。镜中花碎，水底月沉。悚怛而起，余已涕泪满面。怔然滞目，心中寂寂。</p>]]></content>
    
    
    <categories>
      
      <category>随笔</category>
      
    </categories>
    
    
    <tags>
      
      <tag>记梦</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>月堕阳升</title>
    <link href="/2024/11/24/%E6%9C%88%E5%A0%95%E9%98%B3%E5%8D%87/"/>
    <url>/2024/11/24/%E6%9C%88%E5%A0%95%E9%98%B3%E5%8D%87/</url>
    
    <content type="html"><![CDATA[<span id="more"></span><center>月堕阳升</center><center>瞑夜昇晨晓，垂珠染霁虹。</center><center>新芽抽嫩柳，宿鸟望春风。</center><center>幽梦遗窗冷，残灯泣室空。</center><center>吟蛙愁月堕，舞燕盼阳升。</center>]]></content>
    
    
    <categories>
      
      <category>诗词</category>
      
    </categories>
    
    
    <tags>
      
      <tag>五律</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>逐影随波</title>
    <link href="/2024/11/23/%E9%80%90%E5%BD%B1%E9%9A%8F%E6%B3%A2/"/>
    <url>/2024/11/23/%E9%80%90%E5%BD%B1%E9%9A%8F%E6%B3%A2/</url>
    
    <content type="html"><![CDATA[<span id="more"></span><center>逐影随波</center><center>去雁急逐影，浮萍任系波。</center><center>喧台常众和，何日静独歌？</center>]]></content>
    
    
    <categories>
      
      <category>诗词</category>
      
    </categories>
    
    
    <tags>
      
      <tag>五绝</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>旧梦新寒</title>
    <link href="/2024/11/22/%E6%97%A7%E6%A2%A6%E6%96%B0%E5%AF%92/"/>
    <url>/2024/11/22/%E6%97%A7%E6%A2%A6%E6%96%B0%E5%AF%92/</url>
    
    <content type="html"><![CDATA[<span id="more"></span><center>旧梦新寒</center><center>几缕云烟散，一支孤叶来。</center><center>新寒侵旧梦，寂月隐空台。</center>]]></content>
    
    
    <categories>
      
      <category>诗词</category>
      
    </categories>
    
    
    <tags>
      
      <tag>五绝</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>诗词格律</title>
    <link href="/2024/11/22/%E8%AF%97%E8%AF%8D%E6%A0%BC%E5%BE%8B/"/>
    <url>/2024/11/22/%E8%AF%97%E8%AF%8D%E6%A0%BC%E5%BE%8B/</url>
    
    <content type="html"><![CDATA[<span id="more"></span><h2 id="诗的类别">诗的类别</h2><p>诗可以分为古诗、律诗、绝句三种。古诗、律诗、绝句又各分为五言、七言。五言就是每句五个字，七言就是每句七个字。</p><p>古体诗时按照古代的诗体来写的，没有一定的标准，可以说，凡是不受近体格律舒服的，都是古体诗。古体诗除了押韵之外不受任何格律的束缚，这是一种半自由体的诗。</p><p>近体诗以律诗为代表。律诗的韵、平仄、对仗都有许多讲究。有以下四个特点：<br />* 每首限定八句；<br />* 押平声韵；<br />* 每句的平仄都有规定；<br />* 每篇必须有对仗，对仗的位置也有规定。</p><p>超过八句的律诗，称为长律，长律也时近体诗。</p><p>绝句比律诗的字数少一半，即四句一首。</p><h2 id="律诗的韵">律诗的韵</h2><p>古人写律诗，时严格依照韵书来押韵的。在韵书里，平声分为上平声、下平声。平声字多，所以分为两卷，等于说平声上卷，平声下卷，没有别的意思。<br />上平声15韵：<br />　一东二冬三江四支五微六鱼七虞八齐九佳十灰十一真十二文十三元十四寒十五删</p><p>下平声15韵：<br />　一先二萧三肴四豪五歌六麻七阳八庚九青十蒸十一尤十二侵十三覃十三盐十五咸</p><p>东冬等字都只是韵的代表字。</p><p>五律第一句多数时不押韵的；七律第一句，多数是押韵的。由于第一句押韵与否是自由的，所以第一句的韵脚也可以不太严格，用邻近的韵也行。今天我们如果也写律诗，就不必拘泥古人的诗韵。不但首句用邻韵，就是其他的韵脚用邻韵，只要朗诵起来谐和，都是可以的。</p><h2 id="律诗的平仄">律诗的平仄</h2><p>平仄，这是律诗中最重要的因素。律诗的平仄规则，一直应用到后代的词曲。我们讲诗词的格律，主要就是讲平仄。</p><h3 id="一五律的平仄">（一）五律的平仄</h3><h4 id="仄起式">（1）仄起式</h4><h5 id="基本式">1 基本式</h5><p>仄仄平平仄，平平仄仄平。<br />平平平仄仄，仄仄仄平平。<br />仄仄平平仄，平平仄仄平。<br />平平平仄仄，仄仄仄平平。</p><h5 id="变式">2 变式</h5><p>将1的首句改为仄仄仄平平，其余不变即是仄起变式。<br />仄仄仄平平，平平仄仄平。<br />平平平仄仄，仄仄仄平平。<br />仄仄平平仄，平平仄仄平。<br />平平平仄仄，仄仄仄平平。</p><h4 id="平起式">（2）平起式</h4><h5 id="基本式-1">1 基本式</h5><p>平平平仄仄，仄仄仄平平。<br />仄仄平平仄，平平仄仄平。<br />平平平仄仄，仄仄仄平平。<br />仄仄平平仄，平平仄仄平。</p><h5 id="变式-1">2 变式</h5><p>将1的首句改为平平仄仄平，其余不变即是平起变式，但这种情况较少。<br />平平仄仄平，仄仄仄平平。<br />仄仄平平仄，平平仄仄平。<br />平平平仄仄，仄仄仄平平。<br />仄仄平平仄，平平仄仄平。</p><h3 id="二七律的平仄">（二）七律的平仄</h3><p>七律是五律的扩展，扩展的办法是在五字句的上面加一个两字的头。仄上加平，平上加仄。</p><h4 id="平仄脚">平仄脚</h4><p>五言仄起仄收： o o 仄仄平平仄<br />七言平起仄收：平平仄仄平平仄</p><h4 id="仄平脚">仄平脚</h4><p>五言平起平收： o o 平平仄仄平<br />七言仄起平收：仄仄平平仄仄平</p><h4 id="仄仄脚">仄仄脚</h4><p>五言平起仄收： o o 平平平仄仄<br />七言仄起仄收：仄仄平平平仄仄</p><h4 id="平平脚">平平脚</h4><p>五言仄起平收： o o 仄仄仄平平<br />七言平起平收：平平仄仄仄平平</p><p>由这四种类型的平仄错综变化，可以换成七律的四种格式。其实只有两种基本格式，其余两种不过在基本格式的基础上稍有变化罢了。</p><h4 id="仄起式-1">（1）仄起式</h4><h5 id="基本式-2">1 基本式</h5><p>仄仄平平仄仄平，平平仄仄仄平平。<br />平平仄仄平平仄，仄仄平平仄仄平。<br />仄仄平平平仄仄，平平仄仄仄平平。<br />平平仄仄平平仄，仄仄平平仄仄平。</p><h5 id="变式-2">2 变式</h5><p>第一句改为仄仄平平平仄仄，其余不变。<br />仄仄平平平仄仄，平平仄仄仄平平。<br />平平仄仄平平仄，仄仄平平仄仄平。<br />仄仄平平平仄仄，平平仄仄仄平平。<br />平平仄仄平平仄，仄仄平平仄仄平。</p><h4 id="平起式-1">（2）平起式</h4><h5 id="基本式-3">1 基本式</h5><p>平平仄仄仄平平，仄仄平平仄仄平。<br />仄仄平平平仄仄，平平仄仄仄平平。<br />平平仄仄平平仄，仄仄平平仄仄平。<br />仄仄平平平仄仄，平平仄仄仄平平。</p><h5 id="变式-3">2 变式</h5><p>第一句改为平平仄仄平平仄，其余不变。<br />平平仄仄平平仄，仄仄平平仄仄平。<br />仄仄平平平仄仄，平平仄仄仄平平。<br />平平仄仄平平仄，仄仄平平仄仄平。<br />仄仄平平平仄仄，平平仄仄仄平平。</p><h3 id="三粘对">（三）粘对</h3><p>对，就是平对仄，仄对平。也就是上文所说的：在对句中，平仄是对立的。五律的"对"，只有两副对联的形式，即：<br />（1 ）仄仄平平仄，平平仄仄平。<br />（2 ）平平平仄仄，仄仄仄平平。</p><p>七律的"对"，也只有两副对联的形式，即： （1）平平仄仄平平仄，仄仄平平仄仄平。<br />（2 ）仄仄平平平仄仄，平平仄仄仄平平。</p><p>如果首句用韵，则首联的平仄就不是完全对立的。由于韵脚的限制，也只能这样办.。这样，五律的首联成为：<br />（1 ）仄仄仄平平，平平仄仄平。或者是：<br />（2 ）平平仄仄平，仄仄仄平平。<br />七律的首联成为：<br />（1 ）平平仄仄仄平平，仄仄平平仄仄平。或者是：<br />（2 ）仄仄平平仄仄平，平平仄仄仄平平。</p><p>粘，就是平粘平，仄粘仄；后联出句第二字的平仄要跟前联对句第二字相一致。具体说来，要使第三句跟第二句相粘，第五句跟第四句相粘，第七句跟第六句相粘。<br />违反了粘的规则，叫做失粘；违反了对的规则，叫做失对。</p><h3 id="四孤平">（四）孤平</h3><p>孤平是律诗（包括长律、律绝）的大忌，所以诗人们在写律诗的时候，注意避免孤平。在词曲中用到同类句子的时候，也注意避免孤平。</p><p>在五言"平平仄仄平"这个句型中，第一字必须用平声；如果用了仄声字，就是犯了孤平。因为除了韵脚之外，只剩一个平声字了。七言是五言的扩展，所以在"仄仄平平仄仄平"这个句型中，第三字如果用了仄声，也叫犯孤平。</p><h3 id="五特定的一种平仄格式">（五）特定的一种平仄格式</h3><p>在五言"平平平仄仄"这个句型中，可以使用另一个格式，就是"平平仄平仄"；七言是五言的扩展，所以在七言"仄仄平平平仄仄"这个句型中，也可以使用另一个格式，就是"仄仄平平仄平仄"。这种格式的特点是：五言第三四两字的平仄互换位置，七言第五六两字的平仄互换位置。注意：在这种情况下，五言第一字、七言第三字必须用平声，不再是可平可仄的了。</p><h3 id="六拗救">（六）拗救</h3><p>凡平仄不依常格的句子，叫做拗句。律诗中如果多用拗句，就变成了古风式的律诗。前面一字用拗，后面还必须用"救"。所谓"救"，就是补偿。一般说来，前面该用平声的地方用了仄声，后面必须在适当的位置上补偿一个平声。下面的三种情况是比较常见的：<br />（a）在该用"平平仄仄平"的地方，第一字用了仄声，第三字补偿一个平声，以免犯孤平。这样就变成了"仄平平仄平"。七言则是由"仄仄平平仄仄平"换成"仄仄仄平平仄平"。这是本句自救。<br />（b）在该用"仄仄平平仄"的地方，第四字用了仄声（或三四两字都用了仄声），就在对句的第三字改用了平声来补偿。这样就成为"仄仄平仄仄，平平平仄平"。七言则成为"平平仄仄平仄仄，仄仄平平平仄平"。这是对句相救。<br />（c）在该用"仄仄平平仄"的地方，第四字没有用仄声，只是第三字用了仄声。七言则是第五字用了仄声。这是半拗，可救可不救，和（a ）（b ）的严格性稍有不同。</p><p>诗人们在运用（a ）的同时，常常在出句用（b ）或（c）。这样既构成本句自救，又构成对句相救。</p><h2 id="律诗的对仗">律诗的对仗</h2><p>词的分类是对仗的基础。古代诗人们在应用对仗时所分的词类，和今天语法上所分的词类大同小异，不过当时诗人们并没有给它们起一些语法术语罢了。依照律诗的对仗概括起来，词大约可以分为下列的九类：<br />1、名词 2、形容词 3、数词（数目字）4、颜色词 5、方位词6、动词 7、副词8、虚词 9、代词<br />同类的词相为对仗。我们应该特别注意四点：<br />（a ）数目自成一类，"孤""半"等字也算是数目。<br />（b ）颜色自成一类。<br />（c ）方位自成一类，主要是"东""西""南""北"等字。这三类词很少跟别的词相对。（d ）不及物动词常常跟形容词相对。<br />连绵字只能跟连绵字相对。连绵字当中又再分为名词连绵字（鸳鸯、鹦鹉等）。不同词性的连绵字一般还是不能相对。<br />专名只能与专名相对，最好是人名对人名，地名对地名。</p><p>古人把律诗的第一二两句叫做首联，第三四两句叫做颔联，第五六两句叫做颈联，第七八两句叫做尾联。对仗一般用在颔联和颈联，即第三四句和第五六句。首联的对仗是可用可不用的。首联用了对仗，并不因此减少中两联的对仗。</p>]]></content>
    
    
    <categories>
      
      <category>诗词</category>
      
    </categories>
    
    
    <tags>
      
      <tag>格律</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>experiment of socket</title>
    <link href="/2024/11/21/experiment-of-socket/"/>
    <url>/2024/11/21/experiment-of-socket/</url>
    
    <content type="html"><![CDATA[<span id="more"></span><p>Sincerely recommend read this article on my <ahref="https://symcreg.github.io/2024/11/21/experiment-of-socket/">Blog</a>,the Blog will have a better reading experience.</p><p>And the code is on my <ahref="https://github.com/symcreg/experiment_socket">Github</a></p><h3 id="a.-the-experiment-purpose">A. The experiment purpose</h3><p>two computer hosts as server and client communicate with eachother.<br />With socket programmning respectively with TCP and UDP, realize thefollowing application:<br />1. client reads a line of characters (data) from its keyboard and sendsdata to server<br />2. server receives the data<br />3. server converts lowercase letters to uppercase letters , and sendsthe data to client<br />4. client receives the data and displays line on its screen</p><figure><img src="/img/experiment-of-socket/process.png" alt="process" /><figcaption aria-hidden="true">process</figcaption></figure><h3 id="b.-materials">B. Materials</h3><p>Hardware: Lenovo Legion R7000<br />Software: Windows11, Ubuntu18.04, Clion, Pycharm,VMware Workstation,c++, python<br />Network Configuration: Bridge Mode between virtual machine and physicalmachine</p><h3 id="c.-procedure">C. Procedure</h3><h4id="first-we-need-to-figure-out-the-ip-address-of-the-server-and-client.">0.First, we need to figure out the IP address of the server andclient.</h4><p>In windows, we can use 'ipconfig' to get the IP address of the serverand client while in linux, we can use ifconfig to get the IP address ofthe server and client.(In this experiment, the server is the physicalmachine and the client is the virtual machine, and the network mode isbridge mode)</p><p><img src="/img/experiment-of-socket/ipconfig.png"alt="ipconfig" /><br /><img src="/img/experiment-of-socket/ifconfig.png" alt="ifconfig" /></p><p>in this experiment, the IP address of the server is:10.136.12.124</p><p>and the IP address of the client is: 192.168.58.130</p><p>we choose 8080 as the port of the server.</p><p>use ping to check the connection between the server and theclient.</p><figure><img src="/img/experiment-of-socket/ping.png" alt="ping" /><figcaption aria-hidden="true">ping</figcaption></figure><p>if the ping is successful, we can start the socket programming.</p><h4 id="server-side">1. Server side</h4><h5 id="create-a-socket-with-the-socket-system-call.">1.1. Create asocket with the socket() system call.</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c++">WORD version = <span class="hljs-built_in">MAKEWORD</span>(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>);<br>WSADATA data;<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">WSAStartup</span>(version, &amp;data) != <span class="hljs-number">0</span>) &#123;<br>    std::cerr &lt;&lt; <span class="hljs-string">&quot;Failed to start WSA&quot;</span> &lt;&lt; std::endl;<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>&#125;<br><span class="hljs-keyword">this</span>-&gt;port_ = port;<br><span class="hljs-comment">//protocol: 0 means TCP, 1 means UDP</span><br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>-&gt;protocol_ == <span class="hljs-number">0</span>)&#123;<br>    <span class="hljs-keyword">this</span>-&gt;server_fd_ = <span class="hljs-built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);<br>&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>-&gt;protocol_ == <span class="hljs-number">1</span>)&#123;<br>    <span class="hljs-keyword">this</span>-&gt;server_fd_ = <span class="hljs-built_in">socket</span>(AF_INET, SOCK_DGRAM, <span class="hljs-number">0</span>);<br>&#125;<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>-&gt;server_fd_ == <span class="hljs-number">-1</span>) &#123;<br>    std::cerr &lt;&lt; <span class="hljs-string">&quot;Failed to create socket&quot;</span> &lt;&lt; std::endl;<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-keyword">this</span>-&gt;server_addr_.sin_family = AF_INET; <span class="hljs-comment">//sin means socket internet</span><br><span class="hljs-keyword">this</span>-&gt;server_addr_.sin_addr.s_addr = INADDR_ANY;<br><span class="hljs-keyword">this</span>-&gt;server_addr_.sin_port = <span class="hljs-built_in">htons</span>(<span class="hljs-keyword">this</span>-&gt;port_);<br><br></code></pre></td></tr></table></figure><p>we set the verstion of the socket to 2.2, and start the WSA, thencreate a socket with the socket() system call. We can choose theprotocol of the socket, 0 means TCP, 1 means UDP.</p><p>parameters of the socket() system call:<br />- domain: AF_INET(ipv4), AF_INET6, AF_UNIX, AF_UNSPEC<br />- type: SOCK_STREAM(tcp), SOCK_DGRAM(udp), SOCK_RAW,SOCK_SEQPACKET<br />- protocol: 0 means auto choose the protocol</p><p>Then we set the server address, the family is AF_INET, the address isINADDR_ANY, and the port is the port we choose(8080).</p><p>fd means file descriptor, which is an integer that is used to accessthe socket.</p><h5id="bind-the-socket-to-an-address-using-the-bind-system-call.-for-a-server-socket-on-the-internet-an-address-consists-of-a-port-number-on-the-host-machine.">1.2.Bind the socket to an address using the bind() system call. For a serversocket on the Internet, an address consists of a port number on the hostmachine.</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">this</span>-&gt;server_addr_.sin_family = AF_INET; <span class="hljs-comment">//sin means socket internet</span><br><span class="hljs-keyword">this</span>-&gt;server_addr_.sin_addr.s_addr = INADDR_ANY;<br><span class="hljs-keyword">this</span>-&gt;server_addr_.sin_port = <span class="hljs-built_in">htons</span>(<span class="hljs-keyword">this</span>-&gt;port_);<br><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">bind</span>(<span class="hljs-keyword">this</span>-&gt;server_fd_, (<span class="hljs-keyword">struct</span> sockaddr *) &amp;<span class="hljs-keyword">this</span>-&gt;server_addr_, <span class="hljs-built_in">sizeof</span>(<span class="hljs-keyword">this</span>-&gt;server_addr_)) &lt; <span class="hljs-number">0</span>) &#123;<br>    std::cerr &lt;&lt; <span class="hljs-string">&quot;Failed to bind socket&quot;</span> &lt;&lt; std::endl;<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-keyword">this</span>-&gt;client_addr_len_ = <span class="hljs-built_in">sizeof</span>(<span class="hljs-keyword">this</span>-&gt;client_addr_);<br></code></pre></td></tr></table></figure><p>we set the server address again, then bind the socket to the addresswe set before. If the bind() system call fails, we will exit theprogram.</p><h5 id="listen-for-connections-with-the-listen-system-call.">1.3. Listenfor connections with the listen() system call.</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>-&gt;protocol_ == <span class="hljs-number">0</span>) &#123;<br>    std::cout &lt;&lt; <span class="hljs-string">&quot;[TCP]&quot;</span> &lt;&lt; std::endl;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">listen</span>(<span class="hljs-keyword">this</span>-&gt;server_fd_, <span class="hljs-number">10</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;Failed to listen&quot;</span> &lt;&lt; std::endl;<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>-&gt;protocol_ == <span class="hljs-number">1</span>)&#123;<br>    std::cout &lt;&lt; <span class="hljs-string">&quot;[UDP]&quot;</span> &lt;&lt; std::endl;<br>&#125;<br>std::cout &lt;&lt; <span class="hljs-string">&quot;Server started on port &quot;</span> &lt;&lt; <span class="hljs-keyword">this</span>-&gt;port_ &lt;&lt; std::endl;<br></code></pre></td></tr></table></figure><p>if the protocol is TCP, we will listen for connections with thelisten() system call, the second parameter is the maximum length of thequeue of pending connections, if the queue is full, the client will berefused to connect.</p><p>if the protocol is UDP, we will just print "[UDP]" because UDP isconnectionless.</p><h5id="accept-a-connection-with-the-accept-system-call.-this-call-typically-blocks-until-a-client-connects-with-the-server.">1.4.Accept a connection with the accept() system call. This call typicallyblocks until a client connects with the server.</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>-&gt;protocol_ == <span class="hljs-number">1</span>)&#123;<br>    std::cerr &lt;&lt; <span class="hljs-string">&quot;UDP does not support accept&quot;</span> &lt;&lt; std::endl;<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>&#125;<br><span class="hljs-keyword">this</span>-&gt;client_fd_ = ::<span class="hljs-built_in">accept</span>(<span class="hljs-keyword">this</span>-&gt;server_fd_, (<span class="hljs-keyword">struct</span> sockaddr *) &amp;<span class="hljs-keyword">this</span>-&gt;client_addr_, &amp;<span class="hljs-keyword">this</span>-&gt;client_addr_len_);<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>-&gt;client_fd_ &lt; <span class="hljs-number">0</span>) &#123;<br>    std::cerr &lt;&lt; <span class="hljs-string">&quot;Failed to accept client&quot;</span> &lt;&lt; std::endl;<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>&#125;<br>std::cout &lt;&lt; <span class="hljs-string">&quot;Client connected&quot;</span> &lt;&lt; std::endl;<br></code></pre></td></tr></table></figure><p>UDP does not support accept, so we will exit the program if theprotocol is UDP.</p><p>if the protocol is TCP, we will accept a connection with the accept()system call, the second parameter is the address of the client, thethird parameter is the length of the address of the client.</p><h5 id="send-and-receive-data.">1.5. Send and receive data.</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>-&gt;protocol_ == <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-keyword">if</span> (::<span class="hljs-built_in">send</span>(<span class="hljs-keyword">this</span>-&gt;client_fd_, message, <span class="hljs-built_in">strlen</span>(message), <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;Failed to send message&quot;</span> &lt;&lt; std::endl;<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>-&gt;protocol_ == <span class="hljs-number">1</span>)&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">sendto</span>(<span class="hljs-keyword">this</span>-&gt;server_fd_, message, <span class="hljs-built_in">strlen</span>(message), <span class="hljs-number">0</span>, (<span class="hljs-keyword">struct</span> sockaddr *) &amp;<span class="hljs-keyword">this</span>-&gt;client_addr_, <span class="hljs-built_in">sizeof</span>(<span class="hljs-keyword">this</span>-&gt;client_addr_)) &lt; <span class="hljs-number">0</span>) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;Failed to send message&quot;</span> &lt;&lt; std::endl;<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>if the protocol is TCP, we will use send() to send the message to theclient.</p><p>if the protocol is UDP, we will use sendto() to send the message tothe client.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-built_in">memset</span>(<span class="hljs-keyword">this</span>-&gt;buffer_, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(<span class="hljs-keyword">this</span>-&gt;buffer_));<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>-&gt;protocol_ == <span class="hljs-number">0</span>)&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">recv</span>(<span class="hljs-keyword">this</span>-&gt;client_fd_, <span class="hljs-keyword">this</span>-&gt;buffer_, <span class="hljs-built_in">sizeof</span>(<span class="hljs-keyword">this</span>-&gt;buffer_), <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;Failed to receive message&quot;</span> &lt;&lt; std::endl;<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>-&gt;protocol_ == <span class="hljs-number">1</span>)&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">recvfrom</span>(<span class="hljs-keyword">this</span>-&gt;server_fd_, <span class="hljs-keyword">this</span>-&gt;buffer_, <span class="hljs-built_in">sizeof</span>(<span class="hljs-keyword">this</span>-&gt;buffer_), <span class="hljs-number">0</span>, (<span class="hljs-keyword">struct</span> sockaddr *) &amp;<span class="hljs-keyword">this</span>-&gt;client_addr_, &amp;<span class="hljs-keyword">this</span>-&gt;client_addr_len_) &lt; <span class="hljs-number">0</span>) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;Failed to receive message&quot;</span> &lt;&lt; std::endl;<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>&#125;<br><span class="hljs-keyword">this</span>-&gt;buffer_size_ = <span class="hljs-built_in">strlen</span>(<span class="hljs-keyword">this</span>-&gt;buffer_);<br><span class="hljs-keyword">return</span> buffer_size_;<br></code></pre></td></tr></table></figure><p>if the protocol is TCP, we will use recv() to receive the messagefrom the client.</p><p>if the protocol is UDP, we will use recvfrom() to receive the messagefrom the client.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">char</span>* <span class="hljs-title">Server::GetBuffer</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>-&gt;buffer_;<br>&#125;<br></code></pre></td></tr></table></figure><p>we will return the buffer pointer to the client for stringprocessing.</p><h5 id="close-the-connection.">1.6. Close the connection.</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Server::Close</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-built_in">closesocket</span>(<span class="hljs-keyword">this</span>-&gt;client_fd_);<br>    <span class="hljs-built_in">closesocket</span>(<span class="hljs-keyword">this</span>-&gt;server_fd_);<br>    <span class="hljs-built_in">WSACleanup</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>Just close the client_fd and server_fd, and cleanup the WSA.</p><h4 id="main-function">~ main function</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;winsock2.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;server.h&quot;</span></span><br><br><span class="hljs-type">int</span> protocol = <span class="hljs-number">1</span>;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Lowercase2Uppercase</span><span class="hljs-params">(<span class="hljs-type">char</span> *str)</span> </span>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; str[i] != <span class="hljs-string">&#x27;\0&#x27;</span>; i++) &#123;<br>        <span class="hljs-keyword">if</span> (str[i] &gt;= <span class="hljs-string">&#x27;a&#x27;</span> &amp;&amp; str[i] &lt;= <span class="hljs-string">&#x27;z&#x27;</span>) &#123;<br>            str[i] -= <span class="hljs-number">32</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-function">Server <span class="hljs-title">server</span><span class="hljs-params">(<span class="hljs-number">8080</span>, protocol)</span></span>;<br>    server.<span class="hljs-built_in">Start</span>();<br>    <span class="hljs-type">int</span> msg_size = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)&#123;<br>        <span class="hljs-keyword">if</span>(protocol == <span class="hljs-number">0</span>)&#123;<br>            server.<span class="hljs-built_in">Accept</span>();<br>        &#125;<br>        msg_size = server.<span class="hljs-built_in">Receive</span>();<br>        <span class="hljs-keyword">if</span>(msg_size)&#123;<br>            <span class="hljs-keyword">if</span>(server.<span class="hljs-built_in">GetBuffer</span>()[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;q&#x27;</span> &amp;&amp; server.<span class="hljs-built_in">GetBuffer</span>()[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;\0&#x27;</span>)&#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>            std::cout &lt;&lt; <span class="hljs-string">&quot;Client: &quot;</span> &lt;&lt; server.<span class="hljs-built_in">GetBuffer</span>() &lt;&lt; std::endl;<br>            <span class="hljs-built_in">Lowercase2Uppercase</span>(server.<span class="hljs-built_in">GetBuffer</span>());<br>            server.<span class="hljs-built_in">Send</span>(server.<span class="hljs-built_in">GetBuffer</span>());<br>            std::cout &lt;&lt; <span class="hljs-string">&quot;Server: &quot;</span> &lt;&lt; server.<span class="hljs-built_in">GetBuffer</span>() &lt;&lt; std::endl;<br>        &#125;<br>    &#125;<br>    server.<span class="hljs-built_in">Close</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>we create a server object with the port and protocol we choose, thenstart the server.</p><p>then we use a while loop to receive the message from the client, ifthe message is 'q', we will break the loop.</p><p>if the message is not 'q', we will print the message from the client,convert the lowercase letters to uppercase letters, send the message tothe client, and print the message from the server.</p><p>finally, we close the server.</p><h4 id="client-side">2.Client side</h4><p>We have just finished the server side with c++, now we will start theclient side with python.</p><h5 id="create-a-socket-with-the-socket-system-call.-1">2.1. Create asocket with the socket() system call.</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># protocol = socket.SOCK_STREAM # TCP</span><br>protocol = socket.SOCK_DGRAM <span class="hljs-comment"># UDP</span><br>server = <span class="hljs-string">&#x27;127.0.0.1&#x27;</span><br>port = <span class="hljs-number">8080</span><br><br>s = socket.socket(socket.AF_INET, protocol)<br><span class="hljs-keyword">if</span> protocol == socket.SOCK_STREAM:<br>    s.connect((server, port))<br></code></pre></td></tr></table></figure><p>we can choose the protocol of the socket, socket.SOCK_STREAM meansTCP, socket.SOCK_DGRAM means UDP.</p><p>Then we create a socket with the socket() system call, the firstparameter is the family of the socket, the second parameter is theprotocol of the socket.</p><p>if the protocol is TCP, we will connect to the server with theconnect() system call.</p><h5 id="send-and-receive-data.-1">2.2. Send and receive data.</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>message = <span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;Enter your message: &#x27;</span>)<br><span class="hljs-keyword">if</span> protocol == socket.SOCK_DGRAM:<br>    s.sendto(message.encode(), (server, port))<br>    <span class="hljs-keyword">if</span> message == <span class="hljs-string">&#x27;q&#x27;</span>:<br>        <span class="hljs-keyword">break</span><br>    response, addr = s.recvfrom(<span class="hljs-number">1024</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;server: &#x27;</span>+response.decode())<br>    <span class="hljs-keyword">continue</span><br>s.send(message.encode())<br><span class="hljs-keyword">if</span> message == <span class="hljs-string">&#x27;q&#x27;</span>:<br>    <span class="hljs-keyword">break</span><br>response = s.recv(<span class="hljs-number">1024</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;server: &#x27;</span>+response.decode())<br></code></pre></td></tr></table></figure><p>if the protocol is UDP, we will use sendto() to send the message tothe server, and use recvfrom() to receive the message from theserver.</p><p>if the protocol is TCP, we will use send() to send the message to theserver, and use recv() to receive the message from the server.</p><h5 id="close-the-connection.-1">2.3. Close the connection.</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">s.close()<br></code></pre></td></tr></table></figure><p>Just close the socket.</p><h3 id="d.-results-and-analysis">D. Results and Analysis</h3><h4 id="tcp">1. TCP</h4><h5 id="server-side-1">1.1. Server side</h5><figure><img src="/img/experiment-of-socket/server.png" alt="server" /><figcaption aria-hidden="true">server</figcaption></figure><h5 id="client-side-1">1.2. Client side</h5><figure><img src="/img/experiment-of-socket/client.png" alt="client" /><figcaption aria-hidden="true">client</figcaption></figure><h4 id="udp">2. UDP</h4><h5 id="server-side-2">2.1. Server side</h5><figure><img src="/img/experiment-of-socket/server-udp.png" alt="server-udp" /><figcaption aria-hidden="true">server-udp</figcaption></figure><h5 id="client-side-2">2.2. Client side</h5><figure><img src="/img/experiment-of-socket/client-udp.png" alt="client-udp" /><figcaption aria-hidden="true">client-udp</figcaption></figure><h3 id="e.-conclusion">E. Conclusion</h3><p>In this experiment, we have realized the communication between theserver and the client with socket programming.</p><p>We have used TCP and UDP respectively, and the results show that thecommunication is successful.</p><h3 id="f.-code">F. Code</h3><p>you can find the code <ahref="https://github.com/symcreg/experiment_socket">here</a>.</p><p>or the code is as follows:</p><h4 id="server.h">server.h</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">//</span><br><span class="hljs-comment">// Created by symc on 2024/11/21.</span><br><span class="hljs-comment">//</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> NET_SOCKET_SERVER_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NET_SOCKET_SERVER_H</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;winsock2.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(lib, <span class="hljs-string">&quot;ws2_32.lib&quot;</span>)</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Server</span> &#123;<br><span class="hljs-keyword">private</span>:<br>    <span class="hljs-type">int</span> protocol_;<br>    <span class="hljs-type">int</span> port_; <span class="hljs-comment">// server port_</span><br>    <span class="hljs-type">int</span> server_fd_; <span class="hljs-comment">// server file descriptor</span><br>    <span class="hljs-type">int</span> client_fd_; <span class="hljs-comment">// client file descriptor</span><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">sockaddr_in</span> server_addr_;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">sockaddr_in</span> client_addr_;<br>    <span class="hljs-type">int</span> client_addr_len_;<br>    <span class="hljs-type">char</span> buffer_[<span class="hljs-number">1024</span>];<br>    <span class="hljs-type">int</span> buffer_size_ = <span class="hljs-number">1024</span>;<br><br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">Server</span>(<span class="hljs-type">int</span> port = <span class="hljs-number">8080</span>, <span class="hljs-type">int</span> protocal = <span class="hljs-number">0</span>);<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Start</span><span class="hljs-params">()</span></span>;<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Accept</span><span class="hljs-params">()</span></span>;<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Send</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *message)</span></span>;<br>    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">Receive</span><span class="hljs-params">()</span></span>;<br>    <span class="hljs-function"><span class="hljs-type">char</span>* <span class="hljs-title">GetBuffer</span><span class="hljs-params">()</span></span>;<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Close</span><span class="hljs-params">()</span></span>;<br>    ~<span class="hljs-built_in">Server</span>()&#123;<br>        <span class="hljs-built_in">Close</span>();<br>    &#125;<br>&#125;;<br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">//NET_SOCKET_SERVER_H</span></span><br></code></pre></td></tr></table></figure><h4 id="server.cpp">server.cpp</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">//</span><br><span class="hljs-comment">// Created by symc on 2024/11/21.</span><br><span class="hljs-comment">//</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;server.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;winsock2.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(lib, <span class="hljs-string">&quot;ws2_32.lib&quot;</span>)</span><br><br><br>Server::<span class="hljs-built_in">Server</span>(<span class="hljs-type">int</span> port, <span class="hljs-type">int</span> protocal) &#123;<br>    <span class="hljs-keyword">this</span>-&gt;protocol_ = protocal;<br>    WORD version = <span class="hljs-built_in">MAKEWORD</span>(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>);<br>    WSADATA data;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">WSAStartup</span>(version, &amp;data) != <span class="hljs-number">0</span>) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;Failed to start WSA&quot;</span> &lt;&lt; std::endl;<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    <span class="hljs-keyword">this</span>-&gt;port_ = port;<br>    <span class="hljs-comment">//protocol: 0 means TCP, 1 means UDP</span><br>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>-&gt;protocol_ == <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-keyword">this</span>-&gt;server_fd_ = <span class="hljs-built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);<br>    &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>-&gt;protocol_ == <span class="hljs-number">1</span>)&#123;<br>        <span class="hljs-keyword">this</span>-&gt;server_fd_ = <span class="hljs-built_in">socket</span>(AF_INET, SOCK_DGRAM, <span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>-&gt;server_fd_ == <span class="hljs-number">-1</span>) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;Failed to create socket&quot;</span> &lt;&lt; std::endl;<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">this</span>-&gt;server_addr_.sin_family = AF_INET; <span class="hljs-comment">//sin means socket internet</span><br>    <span class="hljs-keyword">this</span>-&gt;server_addr_.sin_addr.s_addr = INADDR_ANY;<br>    <span class="hljs-keyword">this</span>-&gt;server_addr_.sin_port = <span class="hljs-built_in">htons</span>(<span class="hljs-keyword">this</span>-&gt;port_);<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">bind</span>(<span class="hljs-keyword">this</span>-&gt;server_fd_, (<span class="hljs-keyword">struct</span> sockaddr *) &amp;<span class="hljs-keyword">this</span>-&gt;server_addr_, <span class="hljs-built_in">sizeof</span>(<span class="hljs-keyword">this</span>-&gt;server_addr_)) &lt; <span class="hljs-number">0</span>) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;Failed to bind socket&quot;</span> &lt;&lt; std::endl;<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">this</span>-&gt;client_addr_len_ = <span class="hljs-built_in">sizeof</span>(<span class="hljs-keyword">this</span>-&gt;client_addr_);<br><br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Server::Start</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>-&gt;protocol_ == <span class="hljs-number">0</span>) &#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;[TCP]&quot;</span> &lt;&lt; std::endl;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">listen</span>(<span class="hljs-keyword">this</span>-&gt;server_fd_, <span class="hljs-number">10</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>            std::cerr &lt;&lt; <span class="hljs-string">&quot;Failed to listen&quot;</span> &lt;&lt; std::endl;<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>        &#125;<br>    &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>-&gt;protocol_ == <span class="hljs-number">1</span>)&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;[UDP]&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    std::cout &lt;&lt; <span class="hljs-string">&quot;Server started on port &quot;</span> &lt;&lt; <span class="hljs-keyword">this</span>-&gt;port_ &lt;&lt; std::endl;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Server::Accept</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>-&gt;protocol_ == <span class="hljs-number">1</span>)&#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;UDP does not support accept&quot;</span> &lt;&lt; std::endl;<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    <span class="hljs-keyword">this</span>-&gt;client_fd_ = ::<span class="hljs-built_in">accept</span>(<span class="hljs-keyword">this</span>-&gt;server_fd_, (<span class="hljs-keyword">struct</span> sockaddr *) &amp;<span class="hljs-keyword">this</span>-&gt;client_addr_, &amp;<span class="hljs-keyword">this</span>-&gt;client_addr_len_);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>-&gt;client_fd_ &lt; <span class="hljs-number">0</span>) &#123;<br>        std::cerr &lt;&lt; <span class="hljs-string">&quot;Failed to accept client&quot;</span> &lt;&lt; std::endl;<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    std::cout &lt;&lt; <span class="hljs-string">&quot;Client connected&quot;</span> &lt;&lt; std::endl;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Server::Send</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *message)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>-&gt;protocol_ == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">if</span> (::<span class="hljs-built_in">send</span>(<span class="hljs-keyword">this</span>-&gt;client_fd_, message, <span class="hljs-built_in">strlen</span>(message), <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>            std::cerr &lt;&lt; <span class="hljs-string">&quot;Failed to send message&quot;</span> &lt;&lt; std::endl;<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>        &#125;<br>    &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>-&gt;protocol_ == <span class="hljs-number">1</span>)&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">sendto</span>(<span class="hljs-keyword">this</span>-&gt;server_fd_, message, <span class="hljs-built_in">strlen</span>(message), <span class="hljs-number">0</span>, (<span class="hljs-keyword">struct</span> sockaddr *) &amp;<span class="hljs-keyword">this</span>-&gt;client_addr_, <span class="hljs-built_in">sizeof</span>(<span class="hljs-keyword">this</span>-&gt;client_addr_)) &lt; <span class="hljs-number">0</span>) &#123;<br>            std::cerr &lt;&lt; <span class="hljs-string">&quot;Failed to send message&quot;</span> &lt;&lt; std::endl;<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">Server::Receive</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-built_in">memset</span>(<span class="hljs-keyword">this</span>-&gt;buffer_, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(<span class="hljs-keyword">this</span>-&gt;buffer_));<br>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>-&gt;protocol_ == <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">recv</span>(<span class="hljs-keyword">this</span>-&gt;client_fd_, <span class="hljs-keyword">this</span>-&gt;buffer_, <span class="hljs-built_in">sizeof</span>(<span class="hljs-keyword">this</span>-&gt;buffer_), <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>            std::cerr &lt;&lt; <span class="hljs-string">&quot;Failed to receive message&quot;</span> &lt;&lt; std::endl;<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>        &#125;<br>    &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>-&gt;protocol_ == <span class="hljs-number">1</span>)&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">recvfrom</span>(<span class="hljs-keyword">this</span>-&gt;server_fd_, <span class="hljs-keyword">this</span>-&gt;buffer_, <span class="hljs-built_in">sizeof</span>(<span class="hljs-keyword">this</span>-&gt;buffer_), <span class="hljs-number">0</span>, (<span class="hljs-keyword">struct</span> sockaddr *) &amp;<span class="hljs-keyword">this</span>-&gt;client_addr_, &amp;<span class="hljs-keyword">this</span>-&gt;client_addr_len_) &lt; <span class="hljs-number">0</span>) &#123;<br>            std::cerr &lt;&lt; <span class="hljs-string">&quot;Failed to receive message&quot;</span> &lt;&lt; std::endl;<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">this</span>-&gt;buffer_size_ = <span class="hljs-built_in">strlen</span>(<span class="hljs-keyword">this</span>-&gt;buffer_);<br>    <span class="hljs-keyword">return</span> buffer_size_;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">char</span>* <span class="hljs-title">Server::GetBuffer</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>-&gt;buffer_;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Server::Close</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-built_in">closesocket</span>(<span class="hljs-keyword">this</span>-&gt;client_fd_);<br>    <span class="hljs-built_in">closesocket</span>(<span class="hljs-keyword">this</span>-&gt;server_fd_);<br>    <span class="hljs-built_in">WSACleanup</span>();<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="main.cpp">main.cpp</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;winsock2.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;server.h&quot;</span></span><br><br><span class="hljs-type">int</span> protocol = <span class="hljs-number">1</span>;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Lowercase2Uppercase</span><span class="hljs-params">(<span class="hljs-type">char</span> *str)</span> </span>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; str[i] != <span class="hljs-string">&#x27;\0&#x27;</span>; i++) &#123;<br>        <span class="hljs-keyword">if</span> (str[i] &gt;= <span class="hljs-string">&#x27;a&#x27;</span> &amp;&amp; str[i] &lt;= <span class="hljs-string">&#x27;z&#x27;</span>) &#123;<br>            str[i] -= <span class="hljs-number">32</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-function">Server <span class="hljs-title">server</span><span class="hljs-params">(<span class="hljs-number">8080</span>, protocol)</span></span>;<br>    server.<span class="hljs-built_in">Start</span>();<br>    <span class="hljs-type">int</span> msg_size = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)&#123;<br>        <span class="hljs-keyword">if</span>(protocol == <span class="hljs-number">0</span>)&#123;<br>            server.<span class="hljs-built_in">Accept</span>();<br>        &#125;<br>        msg_size = server.<span class="hljs-built_in">Receive</span>();<br>        <span class="hljs-keyword">if</span>(msg_size)&#123;<br>            <span class="hljs-keyword">if</span>(server.<span class="hljs-built_in">GetBuffer</span>()[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;q&#x27;</span> &amp;&amp; server.<span class="hljs-built_in">GetBuffer</span>()[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;\0&#x27;</span>)&#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>            std::cout &lt;&lt; <span class="hljs-string">&quot;Client: &quot;</span> &lt;&lt; server.<span class="hljs-built_in">GetBuffer</span>() &lt;&lt; std::endl;<br>            <span class="hljs-built_in">Lowercase2Uppercase</span>(server.<span class="hljs-built_in">GetBuffer</span>());<br>            server.<span class="hljs-built_in">Send</span>(server.<span class="hljs-built_in">GetBuffer</span>());<br>            std::cout &lt;&lt; <span class="hljs-string">&quot;Server: &quot;</span> &lt;&lt; server.<span class="hljs-built_in">GetBuffer</span>() &lt;&lt; std::endl;<br>        &#125;<br>    &#125;<br>    server.<span class="hljs-built_in">Close</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>we should also add the ws2_32.lib in the CMakeLists.txt file.</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake"><span class="hljs-keyword">target_link_libraries</span>(net_socket ws2_32)<br></code></pre></td></tr></table></figure><h4 id="client.py">client.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> socket<br><br><span class="hljs-comment"># protocol = socket.SOCK_STREAM # TCP</span><br>protocol = socket.SOCK_DGRAM <span class="hljs-comment"># UDP</span><br>server = <span class="hljs-string">&#x27;10.136.12.124&#x27;</span><span class="hljs-comment"># 10.136.12.124</span><br>port = <span class="hljs-number">8080</span><br><br>s = socket.socket(socket.AF_INET, protocol)<br><span class="hljs-keyword">if</span> protocol == socket.SOCK_STREAM:<br>    s.connect((server, port))<br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    message = <span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;Enter your message: &#x27;</span>)<br>    <span class="hljs-keyword">if</span> protocol == socket.SOCK_DGRAM:<br>        s.sendto(message.encode(), (server, port))<br>        <span class="hljs-keyword">if</span> message == <span class="hljs-string">&#x27;q&#x27;</span>:<br>            <span class="hljs-keyword">break</span><br>        response, addr = s.recvfrom(<span class="hljs-number">1024</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;server: &#x27;</span>+response.decode())<br>        <span class="hljs-keyword">continue</span><br>    s.send(message.encode())<br>    <span class="hljs-keyword">if</span> message == <span class="hljs-string">&#x27;q&#x27;</span>:<br>        <span class="hljs-keyword">break</span><br>    response = s.recv(<span class="hljs-number">1024</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;server: &#x27;</span>+response.decode())<br><br>s.close()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>计算机网络</category>
      
    </categories>
    
    
    <tags>
      
      <tag>socket</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>high order control barrier functions with time varying output constraints</title>
    <link href="/2024/09/28/high-order-control-barrier-functions-with-time-varying-output-constraints/"/>
    <url>/2024/09/28/high-order-control-barrier-functions-with-time-varying-output-constraints/</url>
    
    <content type="html"><![CDATA[<span id="more"></span><p>记录一下拖了一周的HOCBF设计过程。</p><h2 id="问题描述">问题描述</h2><p>给定一个非线性系统：<br /><span class="math display">\[\dot{x} = f(x) + g(x)u\]</span></p><p>其中<spanclass="math inline">\(x\in\mathbb{R}^n\)</span>是系统状态，<spanclass="math inline">\(u\in\mathbb{R}^m\)</span>是控制输入，<spanclass="math inline">\(f(x)\)</span>和<spanclass="math inline">\(g(x)\)</span>是已知的连续函数。</p><p>CBF：<br /><span class="math display">\[h(x) \geq 0\]</span> 其约束为：<br /><span class="math display">\[L_fh(x) + L_gh(x)u \geq -\alpha(h(x))\]</span></p><p>其中<span class="math inline">\(h(x)\)</span>是已知的连续函数。</p><p>设h(t,x)是时间t的函数，其相关度为<spanclass="math inline">\(\lambda\)</span>，则HOCBF约束为：<br /><span class="math display">\[L_f^{\lambda}h(t,x) + L_gL_f^{\lambda-1}h(t,x)u +\frac{\partial^{\lambda} h(t,x)}{\partial t^{\lambda}} \geq-K_{\alpha}(\mu(t,x))\]</span> 其中：<br /><span class="math display">\[K_{\alpha} = \left[\begin{matrix} \alpha_0 &amp; \alpha_1 &amp; \cdots&amp; \alpha_{\lambda-1} \end{matrix} \right]\]</span> <span class="math display">\[\mu(t,x) = \left[\begin{matrix} h(t,x) &amp; L_fh(t,x)+\frac{\partialh(t,x)}{\partial t} &amp; \cdots &amp; L_f^{\lambda-1}h(t,x)+\frac{\partial^{\lambda-1} h(t,x)}{\partial t^{\lambda-1}} \end{matrix}\right]^T\]</span></p><p>确定<spanclass="math inline">\(\alpha_i\)</span>的值，使得HOCBF约束成立。</p><p><span class="math inline">\(\alpha_i\)</span>应满足：<br /><span class="math display">\[s^{\lambda} + \alpha_{\lambda-1}s^{\lambda-1} + \cdots + \alpha_1s +\alpha_0\]</span> <span class="math display">\[\gamma_i &lt; 0\]</span> 其中<spanclass="math inline">\(\gamma_i\)</span>是系统的特征值。</p><h2 id="设计过程">设计过程</h2><p>以三维空间的障碍物避障为例，系统状态为：<br /><span class="math display">\[x = \left[\begin{matrix} x &amp; y &amp; z \end{matrix}\right]^T\]</span> 仿射系统：<br /><span class="math display">\[\dot{x} = f(x) + g(x)u\]</span> 障碍物位置：<br /><span class="math display">\[p_{obs} = \left[\begin{matrix} x_{obs} &amp; y_{obs} &amp; z_{obs}\end{matrix}\right]^T\]</span> 定义CBF：<br /><span class="math display">\[h(x) = (x-x_{obs})^T(x-x_{obs}) - r^2\]</span> 其中r是障碍物半径。</p><p>设相关度<spanclass="math inline">\(\lambda=2\)</span>，则HOCBF约束为：<br /><span class="math display">\[L_f^{2}h(t,x) + L_gL_fh(t,x)u + \frac{\partial^{2} h(t,x)}{\partialt^{2}} \geq -K_{\alpha}(\mu(t,x))\]</span> 其中：<br /><span class="math display">\[K_{\alpha} = \left[\begin{matrix} \alpha_0 &amp; \alpha_1 \end{matrix}\right]\]</span> <span class="math display">\[\mu(t,x) = \left[\begin{matrix} h(t,x) &amp; L_fh(t,x)+\frac{\partialh(t,x)}{\partial t} \end{matrix} \right]^T\]</span></p><p>分别计算<span class="math inline">\(L_f^{2}h(t,x), L_gL_fh(t,x),\frac{\partial^{2} h(t,x)}{\partial t^{2}}\)</span>：<br /><span class="math display">\[L_fh(t,x) = \nabla h(x) \cdot f(x) = 2(x-x_{obs}) \cdot f(x)\]</span> <span class="math display">\[L_f^{2}h(t,x) = \nabla L_fh(x) \cdot f(x) = 2f(x) \cdot f(x) +2(x-x_{obs}) \cdot \nabla f(x) \cdot f(x)\]</span> <span class="math display">\[L_gL_fh(t,x) = \nabla L_fh(x) \cdot g(x) = 2f(x) \cdot g(x) +2(x-x_{obs}) \cdot \nabla f(x) \cdot g(x)\]</span> <span class="math display">\[\frac{\partial h(t,x)}{\partial t} = 2(x-x_{obs}) \cdot \dot{x}\]</span> <span class="math display">\[\frac{\partial^{2} h(t,x)}{\partial t^{2}} = 2(\dot{x} \cdot \dot{x} +(x-x_{obs}) \cdot \ddot{x})\]</span> 此处<span class="math inline">\(\cdot\)</span>都是点乘。</p><p>代入HOCBF约束中，得到：<br /><span class="math display">\[2f(x) \cdot f(x) + 2(x-x_{obs}) \cdot \nabla f(x) \cdot f(x) + 2f(x)\cdot g(x) + 2(x-x_{obs}) \cdot \nabla f(x) \cdot g(x) \cdot u +2(\dot{x} \cdot \dot{x} + (x-x_{obs}) \cdot \ddot{x}) \geq-K_{\alpha}(\mu(t,x))\]</span></p><h2 id="qp问题">QP问题</h2><p>标准QP问题：<br /><span class="math display">\[x = argmin \frac{1}{2}x^THx + F^Tx\]</span> <span class="math display">\[s.t. Ax \geq b\]</span> 将HOCBF约束转化为QP问题：<br /><span class="math display">\[u = argmin \frac{1}{2} ||u - u_{ref}||^2\]</span> <span class="math display">\[s.t. L_f^{2}h(t,x) + L_gL_fh(t,x)u + \frac{\partial^{2} h(t,x)}{\partialt^{2}} \geq -K_{\alpha}(\mu(t,x))\]</span> 其中<spanclass="math inline">\(u_{ref}\)</span>是控制输入的参考值。<br />对于正定矩阵H和常数项F，由于：<br /><span class="math display">\[||u - u_{ref}||^2 = (u - u_{ref})^T(u - u_{ref}) = u^Tu - 2u^Tu_{ref} +u_{ref}^Tu_{ref}\]</span> 忽略常数项，得到：<br /><span class="math display">\[H = I\]</span> <span class="math display">\[F = -2u_{ref}\]</span></p><p>再对QP进行求解，得到控制输入u。</p>]]></content>
    
    
    <categories>
      
      <category>控制</category>
      
    </categories>
    
    
    <tags>
      
      <tag>理论</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>franka cartesian impedance control example</title>
    <link href="/2024/09/18/franka-cartesian-impedance-control-example/"/>
    <url>/2024/09/18/franka-cartesian-impedance-control-example/</url>
    
    <content type="html"><![CDATA[<span id="more"></span><h1 id="代码">1.代码</h1><p>franka官方给出的笛卡尔空间下的阻抗控制例程。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// Copyright (c) 2023 Franka Robotics GmbH</span><br><span class="hljs-comment">// Use of this source code is governed by the Apache-2.0 license, see LICENSE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;array&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cmath&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;functional&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br> <br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Eigen/Dense&gt;</span></span><br> <br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;franka/duration.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;franka/exception.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;franka/model.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;franka/robot.h&gt;</span></span><br> <br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;examples_common.h&quot;</span></span><br> <br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>** argv)</span> </span>&#123;<br>  <span class="hljs-comment">// Check whether the required arguments were passed</span><br>  <span class="hljs-keyword">if</span> (argc != <span class="hljs-number">2</span>) &#123;<br>    std::cerr &lt;&lt; <span class="hljs-string">&quot;Usage: &quot;</span> &lt;&lt; argv[<span class="hljs-number">0</span>] &lt;&lt; <span class="hljs-string">&quot; &lt;robot-hostname&gt;&quot;</span> &lt;&lt; std::endl;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  &#125;<br> <br>  <span class="hljs-comment">// Compliance parameters</span><br>  <span class="hljs-type">const</span> <span class="hljs-type">double</span> translational_stiffness&#123;<span class="hljs-number">150.0</span>&#125;;<br>  <span class="hljs-type">const</span> <span class="hljs-type">double</span> rotational_stiffness&#123;<span class="hljs-number">10.0</span>&#125;;<br>  <span class="hljs-function">Eigen::MatrixXd <span class="hljs-title">stiffness</span><span class="hljs-params">(<span class="hljs-number">6</span>, <span class="hljs-number">6</span>)</span>, <span class="hljs-title">damping</span><span class="hljs-params">(<span class="hljs-number">6</span>, <span class="hljs-number">6</span>)</span></span>;<br>  stiffness.<span class="hljs-built_in">setZero</span>();<br>  stiffness.<span class="hljs-built_in">topLeftCorner</span>(<span class="hljs-number">3</span>, <span class="hljs-number">3</span>) &lt;&lt; translational_stiffness * Eigen::MatrixXd::<span class="hljs-built_in">Identity</span>(<span class="hljs-number">3</span>, <span class="hljs-number">3</span>);<br>  stiffness.<span class="hljs-built_in">bottomRightCorner</span>(<span class="hljs-number">3</span>, <span class="hljs-number">3</span>) &lt;&lt; rotational_stiffness * Eigen::MatrixXd::<span class="hljs-built_in">Identity</span>(<span class="hljs-number">3</span>, <span class="hljs-number">3</span>);<br>  damping.<span class="hljs-built_in">setZero</span>();<br>  damping.<span class="hljs-built_in">topLeftCorner</span>(<span class="hljs-number">3</span>, <span class="hljs-number">3</span>) &lt;&lt; <span class="hljs-number">2.0</span> * <span class="hljs-built_in">sqrt</span>(translational_stiffness) *<br>                                     Eigen::MatrixXd::<span class="hljs-built_in">Identity</span>(<span class="hljs-number">3</span>, <span class="hljs-number">3</span>);<br>  damping.<span class="hljs-built_in">bottomRightCorner</span>(<span class="hljs-number">3</span>, <span class="hljs-number">3</span>) &lt;&lt; <span class="hljs-number">2.0</span> * <span class="hljs-built_in">sqrt</span>(rotational_stiffness) *<br>                                         Eigen::MatrixXd::<span class="hljs-built_in">Identity</span>(<span class="hljs-number">3</span>, <span class="hljs-number">3</span>);<br> <br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">// connect to robot</span><br>    <span class="hljs-function">franka::Robot <span class="hljs-title">robot</span><span class="hljs-params">(argv[<span class="hljs-number">1</span>])</span></span>;<br>    <span class="hljs-built_in">setDefaultBehavior</span>(robot);<br>    <span class="hljs-comment">// load the kinematics and dynamics model</span><br>    franka::Model model = robot.<span class="hljs-built_in">loadModel</span>();<br> <br>    franka::RobotState initial_state = robot.<span class="hljs-built_in">readOnce</span>();<br> <br>    <span class="hljs-comment">// equilibrium point is the initial position</span><br>    <span class="hljs-function">Eigen::Affine3d <span class="hljs-title">initial_transform</span><span class="hljs-params">(Eigen::Matrix4d::Map(initial_state.O_T_EE.data()))</span></span>;<br>    <span class="hljs-function">Eigen::Vector3d <span class="hljs-title">position_d</span><span class="hljs-params">(initial_transform.translation())</span></span>;<br>    <span class="hljs-function">Eigen::Quaterniond <span class="hljs-title">orientation_d</span><span class="hljs-params">(initial_transform.rotation())</span></span>;<br> <br>    <span class="hljs-comment">// set collision behavior</span><br>    robot.<span class="hljs-built_in">setCollisionBehavior</span>(&#123;&#123;<span class="hljs-number">100.0</span>, <span class="hljs-number">100.0</span>, <span class="hljs-number">100.0</span>, <span class="hljs-number">100.0</span>, <span class="hljs-number">100.0</span>, <span class="hljs-number">100.0</span>, <span class="hljs-number">100.0</span>&#125;&#125;,<br>                               &#123;&#123;<span class="hljs-number">100.0</span>, <span class="hljs-number">100.0</span>, <span class="hljs-number">100.0</span>, <span class="hljs-number">100.0</span>, <span class="hljs-number">100.0</span>, <span class="hljs-number">100.0</span>, <span class="hljs-number">100.0</span>&#125;&#125;,<br>                               &#123;&#123;<span class="hljs-number">100.0</span>, <span class="hljs-number">100.0</span>, <span class="hljs-number">100.0</span>, <span class="hljs-number">100.0</span>, <span class="hljs-number">100.0</span>, <span class="hljs-number">100.0</span>&#125;&#125;,<br>                               &#123;&#123;<span class="hljs-number">100.0</span>, <span class="hljs-number">100.0</span>, <span class="hljs-number">100.0</span>, <span class="hljs-number">100.0</span>, <span class="hljs-number">100.0</span>, <span class="hljs-number">100.0</span>&#125;&#125;);<br> <br>    <span class="hljs-comment">// define callback for the torque control loop</span><br>    std::function&lt;franka::Torques(<span class="hljs-type">const</span> franka::RobotState&amp;, franka::Duration)&gt;<br>        impedance_control_callback = [&amp;](<span class="hljs-type">const</span> franka::RobotState&amp; robot_state,<br>                                         franka::Duration <span class="hljs-comment">/*duration*/</span>) -&gt; franka::Torques &#123;<br>      <span class="hljs-comment">// get state variables</span><br>      std::array&lt;<span class="hljs-type">double</span>, <span class="hljs-number">7</span>&gt; coriolis_array = model.<span class="hljs-built_in">coriolis</span>(robot_state);<br>      std::array&lt;<span class="hljs-type">double</span>, 42&gt; jacobian_array =<br>          model.<span class="hljs-built_in">zeroJacobian</span>(franka::Frame::kEndEffector, robot_state);<br> <br>      <span class="hljs-comment">// convert to Eigen</span><br>      Eigen::Map&lt;<span class="hljs-type">const</span> Eigen::Matrix&lt;<span class="hljs-type">double</span>, <span class="hljs-number">7</span>, <span class="hljs-number">1</span>&gt;&gt; <span class="hljs-built_in">coriolis</span>(coriolis_array.<span class="hljs-built_in">data</span>());<br>      Eigen::Map&lt;<span class="hljs-type">const</span> Eigen::Matrix&lt;<span class="hljs-type">double</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>&gt;&gt; <span class="hljs-built_in">jacobian</span>(jacobian_array.<span class="hljs-built_in">data</span>());<br>      Eigen::Map&lt;<span class="hljs-type">const</span> Eigen::Matrix&lt;<span class="hljs-type">double</span>, <span class="hljs-number">7</span>, <span class="hljs-number">1</span>&gt;&gt; <span class="hljs-built_in">q</span>(robot_state.q.<span class="hljs-built_in">data</span>());<br>      Eigen::Map&lt;<span class="hljs-type">const</span> Eigen::Matrix&lt;<span class="hljs-type">double</span>, <span class="hljs-number">7</span>, <span class="hljs-number">1</span>&gt;&gt; <span class="hljs-built_in">dq</span>(robot_state.dq.<span class="hljs-built_in">data</span>());<br>      <span class="hljs-function">Eigen::Affine3d <span class="hljs-title">transform</span><span class="hljs-params">(Eigen::Matrix4d::Map(robot_state.O_T_EE.data()))</span></span>;<br>      <span class="hljs-function">Eigen::Vector3d <span class="hljs-title">position</span><span class="hljs-params">(transform.translation())</span></span>;<br>      <span class="hljs-function">Eigen::Quaterniond <span class="hljs-title">orientation</span><span class="hljs-params">(transform.rotation())</span></span>;<br> <br>      <span class="hljs-comment">// compute error to desired equilibrium pose</span><br>      <span class="hljs-comment">// position error</span><br>      Eigen::Matrix&lt;<span class="hljs-type">double</span>, <span class="hljs-number">6</span>, <span class="hljs-number">1</span>&gt; error;<br>      error.<span class="hljs-built_in">head</span>(<span class="hljs-number">3</span>) &lt;&lt; position - position_d;<br> <br>      <span class="hljs-comment">// orientation error</span><br>      <span class="hljs-comment">// &quot;difference&quot; quaternion</span><br>      <span class="hljs-keyword">if</span> (orientation_d.<span class="hljs-built_in">coeffs</span>().<span class="hljs-built_in">dot</span>(orientation.<span class="hljs-built_in">coeffs</span>()) &lt; <span class="hljs-number">0.0</span>) &#123;<br>        orientation.<span class="hljs-built_in">coeffs</span>() &lt;&lt; -orientation.<span class="hljs-built_in">coeffs</span>();<br>      &#125;<br>      <span class="hljs-comment">// &quot;difference&quot; quaternion</span><br>      <span class="hljs-function">Eigen::Quaterniond <span class="hljs-title">error_quaternion</span><span class="hljs-params">(orientation.inverse() * orientation_d)</span></span>;<br>      error.<span class="hljs-built_in">tail</span>(<span class="hljs-number">3</span>) &lt;&lt; error_quaternion.<span class="hljs-built_in">x</span>(), error_quaternion.<span class="hljs-built_in">y</span>(), error_quaternion.<span class="hljs-built_in">z</span>();<br>      <span class="hljs-comment">// Transform to base frame</span><br>      error.<span class="hljs-built_in">tail</span>(<span class="hljs-number">3</span>) &lt;&lt; -transform.<span class="hljs-built_in">rotation</span>() * error.<span class="hljs-built_in">tail</span>(<span class="hljs-number">3</span>);<br> <br>      <span class="hljs-comment">// compute control</span><br>      <span class="hljs-function">Eigen::VectorXd <span class="hljs-title">tau_task</span><span class="hljs-params">(<span class="hljs-number">7</span>)</span>, <span class="hljs-title">tau_d</span><span class="hljs-params">(<span class="hljs-number">7</span>)</span></span>;<br> <br>      <span class="hljs-comment">// Spring damper system with damping ratio=1</span><br>      tau_task &lt;&lt; jacobian.<span class="hljs-built_in">transpose</span>() * (-stiffness * error - damping * (jacobian * dq));<br>      tau_d &lt;&lt; tau_task + coriolis;<br> <br>      std::array&lt;<span class="hljs-type">double</span>, 7&gt; tau_d_array&#123;&#125;;<br>      Eigen::VectorXd::<span class="hljs-built_in">Map</span>(&amp;tau_d_array[<span class="hljs-number">0</span>], <span class="hljs-number">7</span>) = tau_d;<br>      <span class="hljs-keyword">return</span> tau_d_array;<br>    &#125;;<br> <br>    <span class="hljs-comment">// start real-time control loop</span><br>    std::cout &lt;&lt; <span class="hljs-string">&quot;WARNING: Collision thresholds are set to high values. &quot;</span><br>              &lt;&lt; <span class="hljs-string">&quot;Make sure you have the user stop at hand!&quot;</span> &lt;&lt; std::endl<br>              &lt;&lt; <span class="hljs-string">&quot;After starting try to push the robot and see how it reacts.&quot;</span> &lt;&lt; std::endl<br>              &lt;&lt; <span class="hljs-string">&quot;Press Enter to continue...&quot;</span> &lt;&lt; std::endl;<br>    std::cin.<span class="hljs-built_in">ignore</span>();<br>    robot.<span class="hljs-built_in">control</span>(impedance_control_callback);<br> <br>  &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> franka::Exception&amp; ex) &#123;<br>    <span class="hljs-comment">// print exception</span><br>    std::cout &lt;&lt; ex.<span class="hljs-built_in">what</span>() &lt;&lt; std::endl;<br>  &#125;<br> <br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="说明">2.说明</h1><p>记录一下关键代码的部分。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">franka::Robot <span class="hljs-title">robot</span><span class="hljs-params">(argv[<span class="hljs-number">1</span>])</span></span>;<br><span class="hljs-built_in">setDefaultBehavior</span>(robot);<br><span class="hljs-comment">// load the kinematics and dynamics model</span><br>franka::Model model = robot.<span class="hljs-built_in">loadModel</span>();<br><br>franka::RobotState initial_state = robot.<span class="hljs-built_in">readOnce</span>();<br></code></pre></td></tr></table></figure><p>使用<code>franka::Robot</code>类初始化机械臂，设置默认行为，加载机械臂的运动学和动力学模型，读取机械臂的初始状态。<br />官方文档给的ip是172.16.0.2。<br />这里有个坑是，如果用apt安装libfranka和franka_ros库的话，examples_common.h头文件会找不到，需要在libfranka的GitHub仓库手动下载examples_common.h和对应的cpp文件，放到工程目录下。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">Eigen::Affine3d <span class="hljs-title">initial_transform</span><span class="hljs-params">(Eigen::Matrix4d::Map(initial_state.O_T_EE.data()))</span></span>;<br><span class="hljs-function">Eigen::Vector3d <span class="hljs-title">position_d</span><span class="hljs-params">(initial_transform.translation())</span></span>;<br><span class="hljs-function">Eigen::Quaterniond <span class="hljs-title">orientation_d</span><span class="hljs-params">(initial_transform.rotation())</span></span>;<br></code></pre></td></tr></table></figure><p>将机械臂的初始位姿转换为Eigen的Affine3d类型，分别提取出位置和四元数表示的姿态。<br />这里需要注意initial_state.O_T_EE.data()，libfranka提供的机械臂状态数据是全部是以列优先的array数组。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp">std::function&lt;franka::Torques(<span class="hljs-type">const</span> franka::RobotState&amp;, franka::Duration)&gt;<br>    impedance_control_callback = [&amp;](<span class="hljs-type">const</span> franka::RobotState&amp; robot_state, franka::Duration <span class="hljs-comment">/*duration*/</span>) -&gt; franka::Torques &#123;&#125;<br></code></pre></td></tr></table></figure><p>前面的function是cpp11的函数容器，后面的lambda表达式是函数体。<br />简单说明function的用法，&lt;&gt;中间外层是函数的返回值类型，内层是参数类型（括号内）。<br />lambda表达式的写法是<code>[capture](parameters) -&gt; return_type &#123;body&#125;</code>。<br />其中capture是捕获列表，parameters是参数列表，return_type是返回值类型，body是函数体。<br />capture可以是<code>[]</code>，<code>[&amp;]</code>，<code>[=]</code>，<code>[this]</code>，<code>[&amp;a, b]</code>等。<br /><code>[&amp;]</code>表示引用捕获，<code>[=]</code>表示值捕获，<code>[this]</code>表示捕获当前对象的this指针。<br /><code>-&gt; return_type</code>是返回值类型，可以省略。<br /><code>&#123;body&#125;</code>是函数体，可以省略。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">error.<span class="hljs-built_in">head</span>(<span class="hljs-number">3</span>) &lt;&lt; position - position_d;<br></code></pre></td></tr></table></figure><p>对于位移的误差，直接相减即可。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// &quot;difference&quot; quaternion</span><br><span class="hljs-keyword">if</span> (orientation_d.<span class="hljs-built_in">coeffs</span>().<span class="hljs-built_in">dot</span>(orientation.<span class="hljs-built_in">coeffs</span>()) &lt; <span class="hljs-number">0.0</span>) &#123;<br>orientation.<span class="hljs-built_in">coeffs</span>() &lt;&lt; -orientation.<span class="hljs-built_in">coeffs</span>();<br>&#125;<br><span class="hljs-comment">// &quot;difference&quot; quaternion</span><br><span class="hljs-function">Eigen::Quaterniond <span class="hljs-title">error_quaternion</span><span class="hljs-params">(orientation.inverse() * orientation_d)</span></span>;<br>error.<span class="hljs-built_in">tail</span>(<span class="hljs-number">3</span>) &lt;&lt; error_quaternion.<span class="hljs-built_in">x</span>(), error_quaternion.<span class="hljs-built_in">y</span>(), error_quaternion.<span class="hljs-built_in">z</span>();<br><span class="hljs-comment">// Transform to base frame</span><br>error.<span class="hljs-built_in">tail</span>(<span class="hljs-number">3</span>) &lt;&lt; -transform.<span class="hljs-built_in">rotation</span>() * error.<span class="hljs-built_in">tail</span>(<span class="hljs-number">3</span>);<br></code></pre></td></tr></table></figure><p>首先判断两个四元数的点积是否小于0，如果小于0，说明两个四元数的方向相反，需要取反。</p><p>然后通过orientation.inverse() *orientation_d计算姿态误差，这里可以通过旋转矩阵来理解，以<spanclass="math inline">\(^{0}{R}_{c}\)</span>(代表当前姿态)和<spanclass="math inline">\(^{0}{R}_{d}\)</span>(代表目标姿态)举例，都是相对于基坐标系的表示，那么姿态误差可以表示为<spanclass="math inline">\(^{c}{R}_{d} = ^{0}{R}_{c}^{-1} \cdot^{0}{R}_{d}\)</span>，也就是目标姿态相对于当前姿态的表示，四元数应该也是一样（的吧？）。</p><p>最后通过左乘旋转矩阵将姿态误差转换到基坐标系下。</p><p>chatgpt给出了另一种做法：<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">Eigen::AngleAxisd <span class="hljs-title">angle_axis_error</span><span class="hljs-params">(error_quaternion)</span></span>;<br>error.<span class="hljs-built_in">tail</span>(<span class="hljs-number">3</span>) &lt;&lt; angle_axis_error.<span class="hljs-built_in">axis</span>() * angle_axis_error.<span class="hljs-built_in">angle</span>();<br></code></pre></td></tr></table></figure></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp">tau_task &lt;&lt; jacobian.<span class="hljs-built_in">transpose</span>() * (-stiffness * error - damping * (jacobian * dq));<br>tau_d &lt;&lt; tau_task + coriolis;<br></code></pre></td></tr></table></figure><p>计算力矩，左乘雅可比矩阵的转置将末端力转换为关节力，然后计算阻抗控制力矩，最后加上科里奥利力。<br />这里的例子没有乘以质量矩阵，大概是为了简化。</p><h1 id="links">3. Links</h1><ul><li><ahref="https://frankaemika.github.io/docs/installation_linux.html">libfranka</a></li><li><ahref="https://frankaemika.github.io/docs/installation_linux.html">franka_ros</a></li><li><ahref="https://frankaemika.github.io/libfranka/0.14.1/examples.html">libfranka_examples</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>控制</category>
      
    </categories>
    
    
    <tags>
      
      <tag>franka</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>配置franka</title>
    <link href="/2024/09/12/%E9%85%8D%E7%BD%AEfranka/"/>
    <url>/2024/09/12/%E9%85%8D%E7%BD%AEfranka/</url>
    
    <content type="html"><![CDATA[<span id="more"></span><h1 id="创建catkin工作空间">0. 创建catkin工作空间</h1><p>创建一个新的catkin工作空间：<br /><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> -p ~/catkin_franka_ws/src<br></code></pre></td></tr></table></figure> 切换到工作空间的src目录：<br /><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> ~/catkin_franka_ws/src<br></code></pre></td></tr></table></figure> 初始化工作空间：<br /><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">catkin_init_workspace<br></code></pre></td></tr></table></figure> 编译一下：<br /><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> ~/catkin_franka_ws<br>catkin_make -j$(<span class="hljs-built_in">nproc</span>)<br></code></pre></td></tr></table></figure></p><h1 id="安装libfranka和franka_ros">1. 安装libfranka和franka_ros</h1><p>根据<ahref="https://frankaemika.github.io/docs/installation_linux.html">官方文档</a>安装libfranka和franka_ros即可。<br />注意选择对应的版本。</p><p>实测在Ubuntu18.04下，可直接使用apt安装ros-melodic-libfranka和ros-melodic-franka-ros。</p><h1 id="创建新项目并配置">2. 创建新项目并配置</h1><h2 id="创建软件包">0. 创建软件包</h2><p>在工作空间的src目录下创建一个新的软件包：<br /><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> ~/catkin_franka_ws/src<br>catkin_create_pkg symc_test<br></code></pre></td></tr></table></figure>理论上catkin_create_pkg需要给出软件包的依赖，但是我们可以后面手动在package.xml中添加依赖。</p><h2 id="添加依赖">1. 添加依赖</h2><p>在package.xml中添加依赖：<br /><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">package</span> <span class="hljs-attr">format</span>=<span class="hljs-string">&quot;2&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>symc_test<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>The symc_test package<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">maintainer</span> <span class="hljs-attr">email</span>=<span class="hljs-string">&quot;gsymcreg@gmail.com&quot;</span>&gt;</span>symc<span class="hljs-tag">&lt;/<span class="hljs-name">maintainer</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">license</span>&gt;</span>Apache 2.0<span class="hljs-tag">&lt;/<span class="hljs-name">license</span>&gt;</span><br><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">buildtool_depend</span>&gt;</span>catkin<span class="hljs-tag">&lt;/<span class="hljs-name">buildtool_depend</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">build_depend</span>&gt;</span>message_generation<span class="hljs-tag">&lt;/<span class="hljs-name">build_depend</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">build_depend</span>&gt;</span>eigen<span class="hljs-tag">&lt;/<span class="hljs-name">build_depend</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">build_export_depend</span>&gt;</span>message_runtime<span class="hljs-tag">&lt;/<span class="hljs-name">build_export_depend</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">depend</span>&gt;</span>controller_interface<span class="hljs-tag">&lt;/<span class="hljs-name">depend</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">depend</span>&gt;</span>dynamic_reconfigure<span class="hljs-tag">&lt;/<span class="hljs-name">depend</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">depend</span>&gt;</span>eigen_conversions<span class="hljs-tag">&lt;/<span class="hljs-name">depend</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">depend</span>&gt;</span>franka_hw<span class="hljs-tag">&lt;/<span class="hljs-name">depend</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">depend</span>&gt;</span>franka_gripper<span class="hljs-tag">&lt;/<span class="hljs-name">depend</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">depend</span>&gt;</span>geometry_msgs<span class="hljs-tag">&lt;/<span class="hljs-name">depend</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">depend</span>&gt;</span>hardware_interface<span class="hljs-tag">&lt;/<span class="hljs-name">depend</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">depend</span>&gt;</span>joint_limits_interface<span class="hljs-tag">&lt;/<span class="hljs-name">depend</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">depend</span>&gt;</span>tf<span class="hljs-tag">&lt;/<span class="hljs-name">depend</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">depend</span>&gt;</span>tf_conversions<span class="hljs-tag">&lt;/<span class="hljs-name">depend</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">depend</span>&gt;</span>libfranka<span class="hljs-tag">&lt;/<span class="hljs-name">depend</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">depend</span>&gt;</span>pluginlib<span class="hljs-tag">&lt;/<span class="hljs-name">depend</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">depend</span>&gt;</span>realtime_tools<span class="hljs-tag">&lt;/<span class="hljs-name">depend</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">depend</span>&gt;</span>roscpp<span class="hljs-tag">&lt;/<span class="hljs-name">depend</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">depend</span>&gt;</span>urdf<span class="hljs-tag">&lt;/<span class="hljs-name">depend</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">depend</span>&gt;</span>visualization_msgs<span class="hljs-tag">&lt;/<span class="hljs-name">depend</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">exec_depend</span>&gt;</span>franka_control<span class="hljs-tag">&lt;/<span class="hljs-name">exec_depend</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">exec_depend</span>&gt;</span>franka_description<span class="hljs-tag">&lt;/<span class="hljs-name">exec_depend</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">exec_depend</span>&gt;</span>message_runtime<span class="hljs-tag">&lt;/<span class="hljs-name">exec_depend</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">exec_depend</span>&gt;</span>rospy<span class="hljs-tag">&lt;/<span class="hljs-name">exec_depend</span>&gt;</span><br><br><br>  <span class="hljs-comment">&lt;!-- The export tag contains other, unspecified, tags --&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">export</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- Other tools can request additional information be placed here --&gt;</span><br><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">export</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">package</span>&gt;</span><br></code></pre></td></tr></table></figure>主要变动是在depend中添加了libfranka和franka_ros的依赖，其他信息是对该软件包的描述。<br />这里build和exec的配置是从franka_ros的package.xml中抄过来的。</p><h2 id="编写cmakelists.txt">2. 编写CMakeLists.txt</h2><p>首先在src目录下创建一个symc_test_node.cpp文件。 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> ~/catkin_franka_ws/src/symc_test/src<br><span class="hljs-built_in">touch</span> symc_test_node.cpp<br></code></pre></td></tr></table></figure>然后编辑symc_test目录下的CMakeLists.txt文件： <figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs cmake"><span class="hljs-keyword">cmake_minimum_required</span>(VERSION <span class="hljs-number">3.0</span>.<span class="hljs-number">2</span>)<br><span class="hljs-keyword">project</span>(symc_test)<br><br><span class="hljs-keyword">find_package</span>(catkin REQUIRED COMPONENTS<br>  controller_interface<br>  dynamic_reconfigure<br>  eigen_conversions<br>  franka_hw<br>  franka_gripper<br>  geometry_msgs<br>  hardware_interface<br>  joint_limits_interface<br>  tf<br>  tf_conversions<br>  message_generation<br>  pluginlib<br>  realtime_tools<br>  urdf<br>  visualization_msgs<br>  roscpp<br>  rospy<br>  std_msgs<br>)<br><br><br><span class="hljs-keyword">find_package</span>(Eigen3 REQUIRED)<br><span class="hljs-keyword">find_package</span>(OsqpEigen REQUIRED)<br><span class="hljs-keyword">find_package</span>(Franka <span class="hljs-number">0.9</span>.<span class="hljs-number">0</span> QUIET)<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">NOT</span> Franka_FOUND)<br>  <span class="hljs-keyword">find_package</span>(Franka <span class="hljs-number">0.8</span>.<span class="hljs-number">0</span> REQUIRED)<br><span class="hljs-keyword">endif</span>()<br><br>list_insert_in_workspace_order(catkin_INCLUDE_DIRS <span class="hljs-variable">$&#123;Franka_INCLUDE_DIRS&#125;</span> <span class="hljs-variable">$&#123;catkin_INCLUDE_DIRS&#125;</span>)<br><br><br><span class="hljs-comment">###################################</span><br><span class="hljs-comment">## catkin specific configuration ##</span><br><span class="hljs-comment">###################################</span><br>catkin_package(<br>  INCLUDE_DIRS <span class="hljs-keyword">include</span><br>  LIBRARIES symc_test<br>  CATKIN_DEPENDS<br>    controller_interface<br>    dynamic_reconfigure<br>    eigen_conversions<br>    franka_hw<br>    franka_gripper<br>    geometry_msgs<br>    hardware_interface<br>    joint_limits_interface<br>    tf<br>    tf_conversions<br>    message_runtime<br>    pluginlib<br>    realtime_tools<br>    roscpp<br>    urdf<br>    visualization_msgs<br>  DEPENDS Franka<br>)<br><br><span class="hljs-comment">###########</span><br><span class="hljs-comment">## Build ##</span><br><span class="hljs-comment">###########</span><br><br><br><span class="hljs-keyword">add_executable</span>(<span class="hljs-variable">$&#123;PROJECT_NAME&#125;</span>_node src/symc_test_node.cpp)<br><br><span class="hljs-keyword">target_include_directories</span>(<span class="hljs-variable">$&#123;PROJECT_NAME&#125;</span>_node PUBLIC<br>  <span class="hljs-variable">$&#123;catkin_INCLUDE_DIRS&#125;</span><br>)<br><span class="hljs-keyword">target_link_libraries</span>(<span class="hljs-variable">$&#123;PROJECT_NAME&#125;</span>_node<br>  <span class="hljs-variable">$&#123;catkin_LIBRARIES&#125;</span><br>  <span class="hljs-variable">$&#123;Franka_LIBRARIES&#125;</span><br>  OsqpEigen::OsqpEigen<br>)<br><br></code></pre></td></tr></table></figure>同样是从franka_ros的CMakeLists.txt中抄过来的，主要是添加了Franka的依赖，但是另外加了OsqpEigen库。<br />要根据实际情况修改CMakeLists.txt中的内容，你也可以根据自己的需求添加其他的依赖。</p><p>这里的OsqpEigen库是用于求解QP问题的库，可以在<ahref="https://github.com/robotology/osqp-eigen">这里</a>找到。</p><h1 id="测试">3.测试</h1><h2 id="编辑symc_testsrcsymc_test_node.cpp文件">0.编辑symc_test/src/symc_test_node.cpp文件：</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;ros/ros.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;franka/robot.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;OsqpEigen/OsqpEigen.h&quot;</span></span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv)</span></span><br><span class="hljs-function"></span>&#123;<br>    ros::<span class="hljs-built_in">init</span>(argc, argv, <span class="hljs-string">&quot;symc_test_node&quot;</span>);<br>    <span class="hljs-function">franka::Robot <span class="hljs-title">robot</span><span class="hljs-params">(<span class="hljs-string">&quot;robot_ip&quot;</span>)</span></span>;<br>    OsqpEigen::Solver solver;<br>    std::cout &lt;&lt; <span class="hljs-string">&quot;Hello, world!&quot;</span> &lt;&lt; std::endl;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>这里的robot_ip是franka机器人控制柜的IP地址，官方文档给的示例是172.16.0.2，我们这里只是为了测试环境配置，所以随便写一个IP地址即可。</p><h2 id="编译">1. 编译</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> ~/catkin_franka_ws<br>catkin_make -j$(<span class="hljs-built_in">nproc</span>)<br></code></pre></td></tr></table></figure><h2 id="运行">2. 运行</h2><p>打开一个终端，运行roscore：<br /><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">roscore<br></code></pre></td></tr></table></figure> 切换另一个终端，运行symc_test_node：<br /><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">source</span> ~/catkin_franka_ws/devel/setup.bash<br>rosrun symc_test symc_test_node<br></code></pre></td></tr></table></figure> 其中source~/catkin_franka_ws/devel/setup.bash是为了加载环境变量，rosrun symc_testsymc_test_node是运行symc_test_node节点。<br />symc_test是软件包名，symc_test_node是节点名。</p><p>为了方便，可以将source<sub>/catkin_franka_ws/devel/setup.bash添加到</sub>/.bashrc文件中，这样每次打开终端都会自动加载环境变量。<br /><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;source ~/catkin_franka_ws/devel/setup.bash&quot;</span> &gt;&gt; ~/.bashrc<br></code></pre></td></tr></table></figure> 这样就可以直接运行rosrun symc_testsymc_test_node了。<br />上述代码运行时会报错，因为我们没有配置机器人的IP地址，这里只是为了测试环境配置是否成功，只要编译通过就可以了。<br />将franka::Robotrobot("robot_ip");注释掉或者修改为真实franka控制柜的IP地址即可正常运行输出HelloWorld!。</p><h1 id="optional">- Optional</h1><p>如果要用vscode进行开发，可以安装vscode的ros插件，这样可以方便的进行代码补全和调试。</p><p>另外如果不对vscode进行配置代码可能会报错无法找到头文件，也无法补全，我们需要手动配置：</p><p>在.vscode/c_cpp_properties.json中添加所需的头文件路径。<br />这里给出我的配置文件：<br /><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;configurations&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>      <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;browse&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;databaseFilename&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;$&#123;default&#125;&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;limitSymbolsToIncludedHeaders&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;includePath&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>          <span class="hljs-string">&quot;/home/symc/catkin_ws/devel/include/**&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-string">&quot;/opt/ros/melodic/include/**&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-string">&quot;/usr/include/**&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-string">&quot;/usr/local/include/**&quot;</span><br>        <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ROS&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;intelliSenseMode&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;gcc-x64&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;compilerPath&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;/usr/bin/gcc&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;cStandard&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;gnu11&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;cppStandard&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;c++14&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4</span><br>  <span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>/home/symc/catkin_ws/devel/include是我们的工作空间的include路径，/opt/ros/melodic/include是ros的include路径，其他的路径是系统的include路径。<br />通过apt安装的libfranka和franka_ros的头文件被安装在了/opt/ros/melodic/include/目录下，如果是源代码安装的则可能在其他目录下。</p><h1 id="links">4. Links</h1><ul><li><ahref="https://frankaemika.github.io/docs/installation_linux.html">libfranka</a></li><li><ahref="https://frankaemika.github.io/docs/installation_linux.html">franka_ros</a></li><li><ahref="https://github.com/robotology/osqp-eigen">osqp-eigen</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>环境配置</category>
      
    </categories>
    
    
    <tags>
      
      <tag>franka</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>impedance control</title>
    <link href="/2024/09/08/impedance-control/"/>
    <url>/2024/09/08/impedance-control/</url>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="9db11c8ebc96188606038206d5845b1a16946d5bc094fd614ad1fd7884ee90bc">f4d17b6e54c9db009151813feaa7e958b60d19ccc6e9a21e463bff15e54148dd35850439c6fc1a5ce2158d11febc888ca78b6e26f389c6d28b2b3fee0249d65c522121937ed8b41c9c89745e704e231ded74ca581249b8d373fd4ba82f2f978dba80f1df7f2c84c954a2dcd09cb5fcb6bb68f7ca11df0f07f50fac1996d954fddb5e7046a251e879aaa7bd10c1f2f8b323cd08e2af1e90303e5197e6a3036ccc567fde3b92c3ad43fe97a1271e5b426abcdca03bb92d82d1f2e803f9afcf2a2a70ed3c59979d6067d34f3114e9566dec4543dc7007bd7432e387218d1e3dc793f26b452c20fdd921f8065dab4abbfb21f81a7d69849d660e06abde2ab639c39b92ec749d179ffa0c14f6c9ba41a35e295e4e5483f341601ed517c71c0e717e970f50b799d59667a532ca9b5498b50fd24fd3ec334741139013467d6645d2f184157f0b85086b4fa0f081a1a786505a2b38dd44eddfbccbdd9870d389f818f292d39f0ca6ff83983d697828d3ab96de6ff588680bb8917a9bd5dd3c21178d4f5f39e790c8f2c3ba2a1b6ea3c27c750f2d6cb5b6a2c9d0f3ff60c268af0c113febb878e98b0102eea4da1b89950615014e2bb3f3a916bb114ce08253145902bf5743b253d74271e2ca65937548dfdb6b7dca05f8cdf7e1f741b0703de402e8e505ce917ec3d4500de582f1d60a081464e424b42ca220194c309b2f12cd0bfb8983bd76e9b5821a13828e6c2fe8e774072207408717c8a141c894055f1470176b666d0989438c267f028fec2bdb79629d131e2a14670a5a35bd6f908b4343732428dd79eff5b3fd322801a56621539529b97f42e6b2c26dd331ea9e16542f3c290212421beefe90d003986318e49c0ad16f04b3d9ec6b345b105259ad52ee4477cc7893cc37386f06425333b8cec190396e0af622ee6a60908df531cb476ddab0b32772abe0246b86ee55a299fc3ed09f1e8ee5328c460089b9ad69eed445032cd58bd8f4ec6b0561a20229153c0d7aa3792ee67cdf41dacabef19205ee2b0435c4f47cd46ef0d1f86da50a0983170d1af8dfb8ab27d9cb82ceb764c3023e89f9a39bc39b619984bd7ddc74a38235660e8aae3ff11b243397e3cb45ea402fe93e96ea83e10bc17a838c46100624b72452868b909b085726eca8425f5ef82136dae5deb752d2cecc21ef43862ff98f29cca565783d6b3350efa5fafc3bdd29aee384e619acba3b785b5f28ef44e9e252eba257132bcdeda5742f48126b25216bb4e06cd34c2ee1f097de17a97f7ab72b880ebd286de996b666d5cbf863c98738b3bfb94655bc3d3e9537bff47d7b6ba3a18315e52b953c8865635ea60e4ee6acd6b8991a8f95f965497ce6920b08ee7c99551ebcd964356b282a31e7576ca2572d16d5c68785cb5bae3d2442abd72bd874cfaed078d4390a9abab40e23ac4b1177480adb6e04a866a4610c65de1007ea99799bd35970258e397b7bcdf670977b3300edfd925133ba759bd005b7ad706c5c93ac1607a42e7fce53d481ac6d35e123e405f6c1b05364b2d74afb6a895abb24847a8b856dc4b229f6a067df2ef89bee082482a119640c2de75569e2009296f3a9152432a83aacd386adae4b56850f63a5d720aaf26d2da860fc37d46ef6632a285b33adb6491a9d54606e1e00ca80d5b81bade6e8ebe77c56fc7d3833369a33bfb214a3ae00fbc4cd3c1452e419b43f81f7c5905c02a2f7ce27ac33f8e7e928e8b7479eb8a3b094168d3d11f7e3bcc3110490ebcbf162f08f6f6274334002f12f69a2fc9939863d27172d621e16a9a4fb772a337b37e5e509814891f18b82b7a630c4a341755fb696e75df1ab971b4a2a3445db0c17db26f31201ca3a52c5174687f8010243efae1c4d5cd3a63a83f8e6e9f8a56062cd8e5dd4e49171279c6480a51bfc682fb1bc581c80e4548e0d10af8d0e7105b4f41fb34fddac1ad21649a353768b0e0e09239e56fa51d0b9e733fab5dc2fc15916f57e18e2509a2e10563bd6d3ecb24afb6a27053867f75e42afa5ed1d8ed97420e230fb253e3c905f1abb90265ac99d30f6aa03ef0b5913ab4c41abb18b3c074a39c979723f415ab6a45440d9dc8041201e2090acbf5786b1ade95668f73a54d44db8f1a9a5bf5deaf4496c3ee217c67a3aea24815fb1ee44564e7de75218b5ee20c7fd5a553923656534fbf49e425ddb9399bec52ee038f1d646b3fcd60373d4008fe3df667f88bb204ecde71fc0db3359ff3181f033f445d2a51d3270adf37d2cc962aad7b16f518a9e6ba028f5eed4bd119d8ac490969dbfea4bc4fec01386207dacb54b121e80ac972676ad358eb8d9781b787c45f400429e66cb6b2531cd4a5ca18eae8facfd5046a9eadd89fdcf51a1776af3824b68dbcb00efde10baa40ae61bd0a7dedfc387487b799ed1f41f1af4b6c430b809383e795a336c8c487e167b8f1e15a85661fc0efc192952c58d456f04207eaebb2cbc250ff3a47b1a8520c05584c719c9de60a59d4f290e2cedd4f7cd10282c12b97d0ef335872ff7cb7d482ca022730547af7d3deae7ad6a6b3e7195d761cfdb2d6f3dd6d0eec57ff955e507407eec146f8707aa46f63e67ea1ff1a1ebe4b1f6ab5808fe801eb2df56836baed7850d7e14f3d0aef2dfa9e64ea5fcf77510bea576b103eab3b5a6cfc8fd7ee0b2327b3a41980b5e27ffb42e539ec4c3e1306916fb05318cc8051310fa1c25abf2e8abba64c68be062603fddcdbc1e2b82f8d4effec656c79d57b43098a067a43ebb378874f91fe29b6421e9ef913840eca394221cfc99d7bdb49853441e72e4dc80f85e63e1fbaf58c24fc1d277126018a06d03f90b88b5c5866efc5701c633e1f5874589bda9e5df8e6e6bfffa2c0a5e714a414160f277d4afc80d97d7e53626830da2c34fcddff8b79d3b338255a3ae5af831947bb4a90906c29ff85736bc2f67bf8d4bb748dab38090db1f7840ca23c971a315a6008318d2f3aea27b8d3cc30640844c88ad35913cd0fc1a446534462218f1480da22f677c8b92e0387762ce81e624d2e8087a06a35a9ef9b98ef010b27c148c9a6c289c202feceab82129e0280aeba21a80ae991e85eac928ae16b8036fb4cf485f8ec6a9a67fe1129c374b3d819796717e70e3bf0fd2b03fe23b62079d13109a87ff22563ea7864fb17fed1a8ce483f1a199d4e4b64c4770f7b0bc5fbc27c1e0a2c59cde1ad0e0581734f4a3b599c425db3989ec8daabc2f1e750bedf08fb143051180998c7fe16f4dd4472d34c66322ea010ef61f2dbe7dae73495ebc42fb782069b2b1d9a47ad06898b57e658f36d6155635d5c3c9e00079125092db3c090e65aaeb087e64dfdd314a7966977fd95a21d93eb8fc4b0eb440542e5dda8c9e1391491a58ca440e5c95c5b482df6d06190697b3509a122a486f5a231756f742cbbfddf31723b0c01436f68ca34d3bec6e81f5380f5094520da12a4e8d2ab5f20933726b3a780f5da065a437df09b22eeb83553dbb2250ae82147072fef138d4130cb09b047841d307de0b794f605714a6f6bd9141b44014aae39299b49c23b9a7c5ea161920c95f5a0711092f560b35e989d0682a897b1b14b338b21b1060a3a3e131c841c163ac8a8fe1560bf82305d4a25fbd68c41db30160bdf3e00a8545db56e9523aafc4112fd004deca3dd32c105d2967bea418b50603a329a56e3f89c26745058fbd7e1ec788159d2b99295aec53f71a73e49b39ae4184a772001e1643933486b5822103fce3efc8c6f69b62643234538fc670a6ca1ad6c49c76f1c353a84c89f386d9a89170fd8b6be277723e11350ac4749281bde61f74693048c5b3a0d7ef3af998c22da3939c9816c79791f4e49f47d0194f08d91fed4ec19b684cc87b7c37ffb52403602567ff4009b872cad460c13480925a78329d89ebb277dbdfbd6b8301b793df319f779e15d0542f744f3263af5ce2904dada2e88c86ab309a4eb514825bd963a689c3b186dcf865ec763ab1ccdf3c2f312e0ab0788107ddf218d2b95be3526ac35a854123365d7a12d48b9c02c6026a6472165deca4e0beb1a755e8b5004f5b94b6de2779aaa4fd16bd01c6dcb01788381433618499e0e6d924487eee5d7ac8669c6f5988d4c3885df94d5bb67d818321398a11bdfdeca2719e16a82d85e8b70c6df719cd145cf46eb1b67cdc07f3dfef0869ce260fdad55d147e1685ff8101975739f352304981c5c84354a719e500651b528eca82c1bbdf599ddaa94e7b36e93764a1990e8ed698f3bef8eb41d34f38175120ad0dad31ca7a88c1e1d0a8a4e006f1a967bf20b8aa073cea8add1b69bd2cc811b5732033f323749b2f53a06ee1e2475c605d6c03f2191e48df9ca01520b23ffa2ebfa2d3536f287a0ac8db0752773cd062ac048e6ebdc57c1a8eaf2404335a0480f31ed3a881fc7d002e6982f76f226bf81854da291b8e477443a619783d9599995d32ab9747b7580c34622064a980467032bb2d2bd93e64b8fe7369b299ed73f231a7665dd3cacb70a989916140697bae0cebc57efb6dd51c2d64f183636118149a46493b769554c2b2c4de43a2094cb18bb6575ed6016941e1ba071ee4f9e1ad6c59abaeeec6179e9a839233cdac60015f6e61cfa0b2da6926842679f992de4bfa2c79bc32305abeda9ce28771fe9591d6a8086b1bdd3729a0cc03e289b10820bb918676168c9b4632c1f52c9ce0e150a8f3f335b2cb67117c290137fcba199a73b468beb98edf68b3af7a320d846c47f2f5b022854491b7d6730b1e6f209c3a3ace013b94dcb60cacb86b36c0a01ef4737a1c801a192bfed0750cb13eae4445be690461c3cc3a2f13981951703a5af52c1994ca1d0c15806eef08c3d4b53759601eb09bd8cef2cb3323f0468e8fc3066035f2bd8422d41c742dea02a78708ca31df256c0ceae5c38a1ed42b03135ec1926d3d3ae609170528f27da3de8f31795c15ae2668a71b24f31b96093bdfaa738358e0e2ce6269bd45051297e285be5416ecb36a51f5c7feb02de299cec322f66095a561309ec37f76deb60ff434023c290b2920c393c1a6f51ee9dc87da54728351c6d781be5c7a6615ccbf44f519d66534c372d5620c5b769495c9768b67a624a1b577cc921e1ed636725407eedd43dfb405953ed4287eedc521500bfd28b2d5a8946b5360dbbc612fe33f098787261aaa51bead62c2dc57efd44d97c96b72922a381c359cd827b9379b4e58b3c6b6b377f225399d1a5c453a92066045ccedb0c6923254d3287420bd1ced3c699bc0a411bdad845fb21b9f5ac518ebab45ce6404965f562504243a7f22d47b5f896690bb47e4dbeb1cf960cdc8aa27abc281683769e84b383dbb6889b4107ded7078467e167e68de14f768164537216ffaf55bb5c841c15a4eeb3fabbeab6c0f55b6de6171010bf6ddccc9f07c9d33439944831c0a597322206158f74ec2fb02583a133363fd867db1a256d3777476e688d911759d12a8a2456886dc09e608c7b5eb8c39669dba892a0e97bde88952087517a7fce2eabf2453ddcfe6a7e226de67ae752961df0cf7aed0a7e53fefc9dde5cee1b4e2672ab9b4cc0b1e595d3fd74362bad1451533f3051e7ca29d4230be28529b10635f6e755fea449b7dcba66bcef15bd158541d2394104606a36de174c051d7bea8eb0784e6bd3bacb4e4764bfc1110814017e801202341dfb3c771277835d83959e77888a0b87c529ecd64ac667005ef01d6c638a568eb6776bb6a20bcb16167727f8055e8006b08eceaf34bb2a38472ab93bbad59298cb14b9e051b0dfce8b41063b0c5b19b6bd57b93cbd78f39377d24bde2243d5ed4e3f86976335daa67e355c013c148839010a4d7d801c9269cf629100a7032d62b1a305c73cbad8c60b15f892d6d4be1a31af1e398dbec11ba05acbee3773d36e2c27e04fce30d34f53e35c3c1f10135506dc3d746e00d492b9af6f158903b77aca6581307dd7c24d17dc5df431f69048c234656135e1bc7cf523f79f5b1ad6d537bd7caf47b0ee7663a4df49e9f117b7a6e939a963008297b1b35f273d0e9bacfff2dd023007b90e4b4bf1e0df7119fdb83c0de84715268ab350c6fbcf25e422318bc335280e613e50fd38832c786c21b8e6bf2c36f2de1e25b1d5cd8ccdf85a17db545a400d8853e3edbe91cb6f5f5099c42db4e92dccf71ab6505972ef6b84825147e9123f5f81bf692b85518f8f3127ce35a66f75c370a01b6a43c1ad36843dc097dc5deba2a8b88749a0155ada0c992329bba4bcaad7d8b738c85899178348e751703e150f5f64b6060e3bd7619e15e8aa41671836c993c9c60eaa582526d2700e15f09fda8a2a60d3e6fddf71aba5d6ce53d2867d167d60b3239bf47600bb8152db5f38251516c34f8c4414701f8c5be985cb9670c27d781eb89a970249a26e3cdfb43eaeddd078264fbc2f23be8e91f5866498a5f30a30a17b7392b45ffa0479506e275a6487228958e6b0b2667d95538f075d237472b580b1a90e6634ace3579afc4c9c5d150042b9587d7766485b20fe06036102637b860cf15b4d660e885373312b9207e111875637da63f46f212f9f15993603a85a859d8bd607282a534d461dc2cb85cb4e251365bb414b067c8a6914cd1420f7e649ba85c588521a6b04dbf3fb21ca61a48b238e5e378925738903406c95656dd9d454bf42c9ba452d780837b238ed4fd8cebe5be4dc195e643896262518214f21082091c8d61a13faaf79d754e4a1a0e6731ffe7a4f23bad667caf151feb9ea554cdcd491e84b553d40e9ec5b1cf85d68c06acbdbdc4251cf640a4efd0487c931ec2e6c05668fc6b2e33822d53b6b445ae8964c0b9e16e17e05a75185eeb82de6318b7e46d50b8d69ed2e7650fc56b6627de8e317bf33569fb3f1f5b8d3190841e3386a28f131d7df01c8c70701514df822b30bff98d5afcaf560883abfe6b10b6c17da1cd5120e9e2e993a2a438449ddeb2ae8fd9d87f9b1bdea7fcc7c685b12741b7d32555516604cdf64be6f4e86c8488339c6d5ee83c3d03d4274800617a01484ec5d31f52969d7ab86247651f1b0e7cf5d9fc6cfcc5bb9dbb2772500a3fae405047b5b24a0f34c0a0f2da047a43a797fc1a6178ae39462ccacf818eb0b04c3d04d08552e25ce8ac47b18be47335e2bc861189e96a94088157546fd33eb731ac96b29ea1f1d21b6dbade3948ecfb1079af7e02b08b59ebc45aa5bab600e326a9e777e5729695f3d5ae77e044e60328e62328b1b05291c8ce119600a11db8e8d1733ff80f2d42b5dd117c89d89bff814a121d92ab426252b181042d32f68da67e69b14edbb561657f65d34cc451de6de791c6757a55d5c01f0802f9384b52e414aafb3ca6e15952787c9748c3984b1c30b59deeb4c392434f0b8d95b38903cc0563e5187f9166bcf94f14905bf0bb39635db5f8a7ae9b150c6145b40d7c07155f6ffd0b1d0f3cc20b9b07d70c311062ad331c1969e2f386bbf74918282bdddacf4cb291a04f7bbf925d0612931f6504959d2af9fde36e928758f2fbc25940991cd1cce132586ccc221b2a7556a0ff7bd080ee3e94b87859c86ed1930ebd7f852bf01ac9f2e35e2cc9c09531a55c3e4dc2e3db37cc8d8a13bd669e676e05c51a0d069ebb7781077aaf74734028441a17edef4eb09cce2521b1dab8deb67a7671844567bd908ae803e99b5e96e9e03df884583e9c3461aa7714a839becebb93532b91588bbed03515890f62e8b73e7d59f57318418b26e7a7227cc901b1321979cbc92e039c72c461c10c3dfc8e8aa8ca4a43a712d5b3d30483378ecce8ca4e025a56a4f2f34d0f8f671f88b00800fa292c094e7205fcce487af4438a17c39cb75d63757d0b207ab5ac96c9a35f8dc0ce632cbb4bf111fa0c5ddcae4d9c573344e8372fad5d9508f008bd4c25b171c3e0ac682a9af62a6cb4d328861b3784f1af2c42df20179a6a52012018a124bd31273a10775f334ebbd906e686b0baa96f616556434d16e549097746018173dd53107d502d654e7115b2d351882955d60cabebe00a4429bd7ed85acba36230d51a27657fe38b37712e888be241c3a7eae54d3819b4315cd0fe9923e39ac85acda4581dc64be6a062413454572e0f7a7bcaa3a1238808818946ab9448f061dab87a6f7c1a5b851a84f191f68700fb9ca6fa781f12ecf516b90f718ee64d342390e79576cfc1670f27991b2bbfe4bb9d9c5cfa8adc6fd45a0992dcc85fdfe8669b44fe290e9f95cd17bcebaa8d02bf0b39a341e5014d2908dc1efdb36de4692a6d6e427561e44205a11d8a059ca294ec32a0f2cbf0387f2b1ce63dd2346d0009327b864720511857a62f778df755db5e94d418e95cc196da5f3a719c7b0c1e95c814f2c293dae39a331795eac8ba16ac1285c0b10d9feff8ca55e7ce2d3ad12455be89b08f7be4313255cf7aa5fe82753390baa09b5addc0f7ce419baccd5e6a209819b9336992468f26e556c1206b5dbd22da1df7c970ba5ebb5424fc15055fd2f5d152a77a96a1ca1ba38d212d1a1c970691d0bc3c8b9d91014f626365314c699cff7d404332e43ca7218af012b3b346a508e0a2fcbf58bad5c28172e6cf2e40583a25a43544069633cb38cce5febe471292396032110abe21145e2b044db8a9bfd099c21c467f506a528a35666529ea02ee6ec75d4f3b966a9a7d2b353ab3eb1f40211001ac371809906fa536f757cb66e35656474d0dfddd42c6c5e157ee5eba0ffd0d8360f63047cfee44e50f53af7b29b541012073b243ec48fad25d469214ed69352042d7b3794145fe849c0323c91929787f4ab1f47b38fe85ad943410bac08c49b5c162fffadafaac43414817d59f1671ca4108832a195743241da4d87e19ccd75c25c4c66840dbf2a0ff19b379c16ebf8f906c8490e0d7f6a12e1692734537f98d412b2e6a9d6f4a5778a3852f4566b4c9f9d1a03301eac958e33a24d697f18a90a98146d14bafeffc3d0ea3a53efc9eebe526a7dffbc5cf3955648284f9de1831e1946f84d5ff85e794a0d5f0f186c5d23548e5e4f691abde2097314e8ebcef9898fdff9f4b5939a291e17afc83e15385d7261514c9bf5f45ad13b58150488bf3408260045e68d42fec4c6aed3540bf321a728f8eb334a027f593c6314f47dc3d7f052d368d4f7098e8476063086431e0f7c1faa76415254cd8b63f8c4c3ab994f5be7c6b9498a1312752620515a4af72cdbb46ad0b40aa7c3c8d2e4fbc9b13e5e21ee0f4e75148946b2304009afca4e29ee013e6b48b67b924fc2306ae9d9e9c16ab441d86cd849e61dfaad2d0fa54ea2033834cf4f3f29fc00a842e0274cbe69d03263006cfea5ab9bf42fb3038ae5dc28c9d51ba77d1d9f70d8b271f47b996644284f14e50080ff3ee6e140ec6470eade4a907b40adf093ab8bee6618f158413571d45b8991f94f614e3dc002f4f14e7181e3b6b60164db71f1be9f55edfd216502b988654732290d664bf6df3b8530b0ac57f0dd16bb5b159bb8bbc945e62d9296bfb5b7bb2ffde4646cbdbca76602ab67fcca7a3a8e784855564f8010cb0f09b05e230f5b8707c63f1a47fa8028990ff744a2233208301fba602a34566870dcd59ee1321b26803ceb20bf2516d51b4cbe6c2302e3fa2ce6035b1b2c6fd599b51519b5679e549e95ebe1e736687c7fa69229e74663986ef3a2c029f5a5d85c4405a06cce5d6fe47da2d29fef7c5530ca17caeb907b7576e364700e4d4ce395369bf916db86935a53b472021bbc54f461c95aaf797eee654e2fa21455224d608e2fce0a1bb7110f036846fb659ec54b24020dc08c38adb82eb2f346643fd120bc3985f0761eaeb5a38d276c6bddcc8379ca4582e4255651e7b85bc40836a892bd61456685bda27b8886dbfe099ce56394b950f244f49b2046d9deab28dde2ab5657fbdef8806e36c63c71499040cfb7fde1dfba754829b262896b066e46f3464da546ea4e111ed4b9304e0d11ba49b3eaf36cf7370aab1d34acf4407ef284e5910b28b1276859523ea9ec38d0109cd5286f95fee2dd4b7013ba6b75e54a209c11b31ef8a0daddfbebf16da4c778010eb86284a7a1501f4e056c35db91719891d57990279fe45dfc22b53be522ea3c0a7f7fcdb5de330e2cef000d897c4ad835d560283a1426b40e97fb7267422ac2f565dcffffd0181a1742d8f4ab53474a01556350b4146fb595586f5eebd3960777b7851d3e11ab6b10f4b434a048667d7ab3563e51d0b46f1a6f8be7fb1e8cc5d9cbb6d4cca1eda7a70617b89a5527d24152ea86e1904b66ec12cf07ec50137c57e8b8e97eaa92e675af13771014970d3a588311d271975f935e72cbd881e0595227eb1183030a50173f66b02219ed3c80ec41c754bd9e151cbe76702d25a22b065a6eba566a7f0416e84b1824eab5d19279de021e3edbbaa124a79b0d683c9d437a6f1d189c5a8721c7acc67c231f8adad5185b159055b48747768e67b58f6f4f5a7b4a778b340d35ad5bf918fa49e2b0c86105bc6327723490de06c18f311de4c2cb8c79ff4587dba0e08fdb20314a77ddad3a42fda9593751d613ac6435eb501ee3e1637015b75aa59c11dcfabad2972a14bb23da2afaea9936eb036112e26a4aecc16c988c2634ea7bcfe2b0c174a9e3b0f2ba1e91a8ba88ec08cb9a5cd57d6847b08cb0fb084eb6b5075b334be3fb175505d869330a3fa58eb0d2219f65df403a45b1816df49bcb14ffb41db9b1422a667f77ec589df064632b123ecc8fd77fed74d4ad9d2b2d83ad91c58a7623cb10279cd26fc58f191edaa99708e796c84be11e961f34879141d530bc3e22d461a70bf2b9116b5c86d36eb9ee14d1abcc7dde4ade6b7be6e729aaefe7ce3632da7552ad2dcbb0edc3ffdaa5c56838e47c8be4a8b4294539a52cf9ba640eacc27e897097fe2430525c109753443f978785271db84c98f178e59bc915c439870102da637abfd408fc8adcb73c36f1f2ba24fdb170dae3dda6a027ef8cbd3f84d659b9716d3508e1b69c8634b726ffb405170b15da32847df19476b13d5abeb8309b34ace3f31409c13eef8c3b0ecfa3aa89839fd0a5cbec81661f68a64c442de696fec8ac2856936178d690a8fcf2f5617c4445397b858836dffd0effa8f28c5910638179f1c5cad6c00ef195887914d320b45abb6dbeba22a308b5eb05403a81a8749bffd2261f714221be909ff6b1571a95b4545148ad4ce9626434dac50c441f4b8742f0a03c4572be7c6e86fcf3fe40fe6ad89cf8af75a06899acb850cb809204ecb65ff6ffe4947d3f2dd558aceb30fc121c43fcc5bcf179210d00a565593a173ef04725976b86a1f62001ce9ce2e8bbad300be9c007d6f6bebf9c5f135852203eb57e59be8114063785031fe119144bf05e84f8fe6eb6bae4fcf1eca9e6a421e6915ccacf106e921a53b11ee693e5f377a2690e22c564fa6d76ee4dd2a10b01899ea378bf6488e4948345a903192890c513c5f7de3e25a030d901aa1c16a793b26872d8831a5a3f755b682a86ca69ebeebe8dc0a2db7aeffca00c371ce730dff8641fec1945669da987223d7e1a7d8741fe4eebd108d99eedac15e782696af2f3ca32d6e24fe66462874733d7cf47dad77729689e0d9fd8164db231cb9840d32db99c3a778270a85d80d2896baf0992ee5f3d3d6ca153a3ba8e3c0c4ecdd9223169d0e0fccf69dc1c0d4a71673f0ce1904729ea33f90a0a503c14741c362f7313d1669aff699baf85a1237ee03cf4ec84012d0596571c761318c7e6cbfaf23f7a6ea6594de3248fb6536602199a137c78afa043e4aaef0f84b2f8d412ff1a244f7274f1d9ac53fd9b5a5ceb2ab67ed750880563d5d7d080b46e176fd67345d1141272c1b962b82e4a1bb2e4e9b18ab844847b94a1ccffc81adb47b04aec09b731c33f1c5683708e18195b65fbf66cf88496814b7db3bfad1709282262e94d59bdd2d1f7ad5c05c965e1fe15cd8931386decfe36d50d3300b7570c55142386f52272557962322f6b5db793e6be7e4a8e3f393d82beb9fbcbd54ad9eacf05aa5d32a99dfcd1d21acd523a5e3fa56cfb45387c4040633d68d1774436a66a566abf51200af324a1e8f58fc531e792b0008427a0403469a33ed4d2b06278ca03bb5b2ea0f24143ab2e85d094c5e7af0c64374086c66c13e88346b0e7ac308cc3ea7aa1e08ec0eb6d33924377aaca3adeeb3025ff5133b8c13bdc7ddd789850f6c499e48680a43a7a60146ffdb57824ae4f1e8d3889db164838c7117ad9baffad7f67fad77e19769a5dcaf301700930537d1864afa47123274c8b41b0bceca477f07342443b5778f1169f07540b265f6afd46243fafb1c96aa209efd6a3fcdb4c5cb3b9926fb46819586e21928e16bcd14e104873c6e07e72b78a0591368618be88f5034fbf971aa83e9d3ed9b6d8f33c250d01e488468436fb9af35f074214a069c22d78a1f29d5571e7753843490a7c3580482a98e3c3fafb916ac79f041664711942f38e0aeb48b8f1c4c338fab1f2561ca9695624305df8f32111c4b36b3df3024884ff85eaaa08daecddb1e2ac450bf526af1a4a56382b0b7857451d8b8564f11fd41c94064aab99fc565233edd1a0515fc55450c320b6713b148937c488250d38f87cdc8d952fcfb7c5a74fb19ecb226c92686eba65a0dfa3ad2097b316ca4f6dd1aa03c456ed7a257a4d720d35be20848457e7d1d50b4f3da0855a4717ed1c181b512015bdc9156a03126cf654903a4d756e7b608bdd4a83d754e28578de326920e8429d7568b5e9aad0ff1878d6ad79084df2187b73789060ca761a1432d4773ad8a73348621573bebb59d731e79f5013e17bdecef09904699e8fd140c6f6a5f459fc9b38b675de57802fa642bdb86d71dabc975852d6ace274f3ae9a1cd3b4d04798328db013e00a486cab419c90d895f5a68e4da902be8e28bf0383ee70001d4191d8601809067dc0bc7d8c92bd5a594983614faeb6fc2722afe51d209ad0d7046bf429decf33fa9d14a108923a00eb241fbb2be0d16260b79f9e8fa7ed0a5a6162b6f4dd7dc34427671fd898d633a993f1e560a854bd86406e49a614f6b74e81bad1208dcfb79c33aab21de960fffaab4169bcd349c21b9f46ee8ce64e9a1d18bb9abc98bd531d5b3161b883b0cb9c9818b99f51dd5583f2345296155c93163274b20709b41e3db536cfa8b827c4beab3b3b1904d9ddd16367e10d6a8cf38eae00685756d95ad865da0d55944c4ce9d55ced2b327470a4d169c27d88eb6961460543a4056e7e0926c18fd329247e6386b7f30447a8c9cbe3a477a45131945c1449549d9936aa68e9af3511fbc95d83f0a40707def4b296971dbc349ad3cbe9c77f056e094ca5e1894d3fc29328abd1358ec901b83ca5d5f8e7d16ed8cbe927c0d90bcc2237a35f799b11b021c09e81919824822843a6c984496184dac82d49714af8e447714de221917fca66ca526124d0f090a23fcd1e52b38c38c25767c94d4bb80e3e51a494d5e3cdf3e22f01cbc3b658d708e6f8a367a23787155b5aba03b5791c5b6f39a2ac554a8c97e6dbbc358cc5e0486fd87112691dd5ba260c199889e355df43d2b0e6c864852bae620e3882f8e24b7297b8054fdd6be89a22a4b17bb25ebfd4f59e31cbe74c7d8775ad169cb1131a5a11d2590a8b9493cbd76f1f2b3a8ce3494983067e3837d6b2da8c5fb8174e0b44e4843c97dad2288943bc071f84d34d8e215443680ce7765fa2ae9ca18e8081d8ce53ab218b7467cefbe01ce996fc8f73b749f5b06bafa50d1b7f61cd4498cf683f8cfce2dec9706daea88baaf58bd4bed3d96a021368a4a275f80a5c3090d5cfc8f181d0503146f838af77a5f1da95736515a77fde44e1b391e58d78224b0c45aead623809d2ef235b1e0665297067f08110d32300c6afd4e9f7c5a57e62dc17ee128a378f4817a00dad2b080b0576d79af242514ea71d496895d8576ebef5f5bd4198b4ceff5ccbd99d9844c9ebbab72207f02fc4c7c58c6108980f098b41699d3dbb5281d28b0ace33617f8649cd7438353ebf4ead8f918fd8c94f8e2caddd2b66821b133dbc30f73ee5080a10dee71ae5d25676e4ea787540a366af142b1de277c96b83485282451a566e0422a6d5abcd6d60f03f16d24a7ed6d27d367c61b31e4fed7b7933f08d8f92184c34a09197e1a0deac93027b3459ffc9c8ffefe88420618543480b97cfd292d77fa2c858d8fdf112720976696d1330019591c7d35b70938293c9ed2980988991225616eb761cb1d6977464e174c0be9622be56a6cd50e1f52a95ab1c00a54c75641c145619ffc8b9887eb89b0714cf45d28fbbd0be2bd8394dd2a04246f4aca40a20b251081df9ba37c519eae26acd3b48f95f79cc6c01dc8d54865e519d7c1068c1d50c3a40ffc51e6687027a57a2f318fe68eb0d206acff246cf25226e5340defc70455fe1f057c4ea3ecebbe66b924be66709bb9e1f685833d27df7650e0e5d8e8dab346ca6813fbe85c9b2f3db0ea4e0d4e4dba896c15c3e3080b8bce58929100bc159731ece9697c96698526a5af6703872d8551dff6e7ca2adef20b634f3bc46c6836bdb24f83af44393043e39d27679362b17d3be7d03c7210a0c583b31b61c316d3bd487192416a2749827210c5241a90cd76d2a2251f7753ef722055f30d17fdf066d336fb93c234da6e6db2cfc4e6869e643bde413dd04f71f8d6c9125848bc37c0bb2dfd96803c3b9f3259bcd83ec116e74c4467fcfc8514c8b1b872cb3501d4c4e31c8934058f285dac5e9e076089d29a0160747b22c502f6acdd4c1368b9aeb1be6bfca1c5b46caa1d0f201b190c9b6f59679b7c9f6943fd369bec03d50033dd55c26828728074c045b679f2ef4496dfbab6c63c47e6fd8b8b2539f77554ed9cf031d8ae8db801add03630f1ff086230c961ee536318b89e4df1b62ef54cf9ca9761a769b9b54801b0ce6f82a9e4fbf5ffb9be4e3bd67efc668e03f893a30b8c1e2f9fe0c3274228e8ee32dd6950f98886a60fc612874da2dde1eb0a3516970d48b1215603fe8b3c6a168d08d059ff10f783a393f61841ec2f072637284a5c1500fb5e5084f5c944f6a31254120b96ec37a05d901af1137140c3487a9b454bf3743ff9cdaf5e5c715a8e25b89a73502ae61c4d2261a395e8145a128380c52f6566110269dd6f3262b7306649210416745bfd24f50febaf6b1e2413058356bf49aef87850b87fa3efea103797c2392621dc1c75ed246a1daa1d0095c4ff31e4b45f60860705c43b7536a944fb90d844ae45090f4c267baab56ab4bec23baecce2c7d2a6865df4a21f5fa12ddaf1246228247801e01c1143c8953ec1fb40260de9d268b9bb64312f629426cbe92eecd9354d700ea5fd33526f0e1e52db2c50ca470113964afed606f8c6fbe8ad0c057c78d9c0c34a62ceffb7b710ebf99fea4b5d7770b1cff7d39b90258928553924ee54dda82011bfebc6b7838fea7c6332f1632c29f3063d58dbfbc61b63350c3943f1b9b10a73284e969ea2bd0cf5cb287fb582e5c65cf7a295736c8f4a145425ad5de306c30858fa86d266b2cac57f85ec31bfdf42483587dea8566260e87745db70cf300aa16b01931c47754f2585c33af77adccc8e1cb4d201f629598f6fd310c75db90c116f0f242f0da848380b7608ffce11ddfae13b0b8141ba410c73b7948b188baf3b651b7a95bf3328650844e6d7ad75291c25d1d62cfcd865100079ed08b0684857fdc31b8719d72cee5f625c1cf2c82411c7301489c3fea5af9a191c01269e64f03780dd3f40895fbe0adeb70a1a98b825fc2145019aaed325fc8e690289c074cf3ab216d5dee95a30c40a8ae30b81da70ff08508dad3dde436a972e1d0d4fa5153952a4ede0e5aa11ef39f0f1b6f28510574e706762e5b897f420b6879a742a09d96a804587a07b7ebb057824b3db2f1058543a3f7130b972853b8c1b92a9f179e5f2bae2cddc3e7eafde40e06f24a614f79607e47ef68c2c53e37b695bc93d3c78c3fca67c6c25208a1d2690c7675cc0e5f111a7eacce5d49cf6ac914c9fc9e1f308a92b27d06f7bbf2b24911f06cd6dbc61b3bc6ac53b965352c0ed1844f94a412762d04c457f9183bedab34a00de33ce9010daa493365371e6de25d2afbacd9465e02044a8b5c8d71f50dc3e985b09cfd282b01f221c7338fb25e96b6553e9e1414f28bf4b6620bc630a9d5e9dadc0e63cd32af1c654b7bb1aef03dca2e1c4e95c6d311b77fad687038429171e75a46feb9a963cf68169ab99d3ec31b3c8ba7af97e1259b083c3f18b5e78589efdecaee5fba454224a325ca71d477a687ed84e6507e776cb9106d0b4c53360a388c0c7a967dc1524fe98ce04447915052c75f70dbe954c5f5f203807106877d78e01fe0054ad12a62db335ee0b9f1630d15f8ff25fe55768b9523eee4b495c51e5d1c5585ac2d5740be1d13c67ee308e45c7938cf7e59bb86841d8531c9845ccb0b43b457835d83b7c542c8b9c6bf1cd9b46a820548ae6cec991a993f7958b9256c254cae43bf80bf670ec2c351282487e8e7bccc6ce5bcef487b7d5ae17d8d2a133010237e36a9deb439719f24847183b09e0ac7f9db84bf3e87a3d6b71e3ed7de72672c7ac1c5776e29b2529519cbf57bec4573d9d3a9309cce3a47f716ac37b9acf1cb842002f9276aba1b43ac7cb8d91fb41fbe19519e3916c13490e6576d0a0956556af2d26597f3e47f703bdae256bce84da21a2c6b750f45f4df93335db1a4f6741867aade59c7cc472dc7615b79b8176453b0eb05f44448eb2e63649389968fd54f2781c7352c6efa8654eba27a56a59e4d75074a83ac66ab98cfe74437619566266aeb9e90c128231f950e7fa06ad0dca0b0e1c2c079b328ffa451cdadf6695d7eb29167220272711d2d9b9d344047d92e6b3d6f1f6cab7deb334b747fb1683cadcf091e642b592f148509c38033e1344005e0b27e58064ab480be14b1376fdb75a76c69372ebb862b17b30d060641be3d813e70177b2525593ba98bc48e28d141ade813e277b9ac803b726f07a30f96ae53bd14a638e480716ffc72ebf4b50465d82a09d7064d3c5992e6b8d1b6d9d4f51caadd6b4d402cfe6db1dc7fde2a4b627abd9685201ca104d15824aff93d6f3dc435f981ba676a40ea6d6bd8f4c1f4313de4967a27d094f5477b93abd076e489df79c9bdeb2871efe7322d0af40a30f4f340d4603a9667ed129393d46c81a7a8fcbb6641da56c6567f871f51310fa3e252f1f24160cb59e687d38bef3d57d151c126dd89d785534b35f8814ac153ff1b014b730abf5f75cfb7b6bf8570b4710ac56dedb72002b664efd8da24ad3f7160667ad46376327c8cffcb98e38421683413d3a9b78af4baaf80738153504af0e6dbe9bb0b592f038dcba40a6c6a0ab2a6d4c328fb6c7f882cd062e2b7a28feebb810a79c479a1e2bc7209fda0e2787296a779d4633fa3eefa238686d0b1371148f44c2db897495d3abccf96595af2cbe4b6a979efbdbf519253c17c01a2e7d4c462f666bf2c4bbf73b7589a6a2b63a0f0be9a6ef13287535613f2c0e08045b3730c064ba5725f19207f48a8ae1c50f475365bffd506270b5606b1b114a9e21547ec15f21a4a807b40ae1d32dac749447c38e117bc9ff46b73e3ddb0c3cf54f5a169646f984eaef91790caa4c4da9e5efff2c02136d5ae93b1332aff90daeb8360479f2a152270469af524df111646e8deba6de6b0fe77c628890abf46406e7ad6635cc61e252d35f80b9e3c367f0504b5a36e0419e1b0a66d4596ea38607b8ab3545a85d4bc4654cb5f9ca1999b90c1ce80f82794daadfc3a271b12da53787c5e422616a1f0fc4efd0518bd20d16cccb6dfc98fe26d12d7448c3fba098f4581782c4c1f3044710839f31d11afbd3e347b9a74722241ecf003ce3131adc0969e71e8b3bfbc128919802155882ec0d8156cec70316c9aad52d5c3d7617bdf068647c6dc7da532c1967cbc88a0b4f006643dfdda82e6aaf8fe23a2e5f40888c471741ab7ea24872c403e62d2b2eee99b77c0456cd814e0407040600de3ec6f30d198abbbf535437bed4f67694ead774858130f9141b7cd8baf08edd82ad36e3bb0c319dda7e4dd3a50f15b63b7f5fef9f5f07834e24b98a6dd9cc93ef2be4255a36c8601b9226c9dd802465cabf78eb7e8eac7d8c2a285eaade378a30ab4cf61ce525f55e00702c779aa8d456dec725c07fc03f7e3ec36b392515f4ddf7755af4ed53b08d8cc5c3d4393449d123c1c73761c0bdcbc5ecf9c7791e0a320f463078ebd83502fc48471fd1889b500e810f0223629dbf075ad7b96ea4549c8379e664cfc18237bbb52cc597111d9714194eb2acaf1594602b0f66ef98ab5db6ff93bbb55c15d03dbd0a4252d94929af238df31e68347bfa65f2d76e377c799df4a7f066a93f77694209b17080e78019a03c528f8a180ce44255a64df6c772cdecd4bec123dcb5da502fac90a1dc11aff17f9c8b1d0c47034198b262079513bc0f74391a7de7459c6ace589ca1c4ef4bb71577bd7219964b2bd76708d671a39bc920bcbd13906472060e718dc18bfb136c43671d35cdcdca40d4181acd871a8b6b22828ad2af52beae467023f34445aa6dc68da21296a4217c058b1b980d9c7fce2e3130cfb5b761bca07a47ae2ae556818c0efb7c552adbce9f5b9b9cf84b93857a8354ad7f4535a4499c2f1260716f68f99b7f013c70d0e3a62a982f1ecb42a71ae852921d9a6f3132bba54df590b07d20803851e4f5a6c7fe8417f6bc9942d8e866e16078b7316baad15970dc049bf81a22778d0cbfd7424382eb79a64f85776874ccf3d87539c807b2056da30009958e9896d9e21bfb8f5612fc10dbc399dabc40e3bc9aef299df216a2f306f4b7bb3fe0062827628ee1e97a606e787e1170562ac1f8ae015c02bca3e9342b940236d9c0c9d3a0daa9f0b206bb47a2df38298c98e3e2b2aa40cb3ddcbaef851efdfdc5bcb1667c6f30971d2a4f2b447c0440b9d22befb9b00acbeeb8bcf3307d1b19d52ce99f11f410b52e2c3dc6d6e85773f60a2846195fe09eaf50deeaecdf443da089d98f1d482a2d8fcd12536fdbef4cfe0bf20c8ef18f29d33d974913b9bbd677e084002426f31fd29961e6b8ec5f42bf87bef0fb1bff8e33c76ee6444c83f6e3ab4a65f1e33d4297f1017db0d34729acf736368685f8a87d2649aaff3eb36db3dda46169fd78ea633e9a96e56803cfacaa7653ba72e04bccfd1d78f61d41f2e8916bf53862ffe2424f058df2deffc56a5d9376ce9a8e1b74f5c087bcd03a7e567902f45e58e63194601c15f55840be9b6a956dc86cb484bb311b79d4c2666d0fb3d6399fb567b0e5a11a14a89ff962c9177370ecf803ec106c633bf811ec4bf7a6aa580932abdc22757ff245722b3845484beaf38622e991f10f891abe9448116fe7c352a452151051cb5a8d13357de18f8907383270e3b7fcd93a15358d71e231a8fa8c199a28569e79a422bccce3e39b83998b444663032b10ca18ed32bf10669621aac4247e7948d428758893c9308002f4da6d3105c7e06e59ed67c9ef0c19752f62bd4f745b20fe640dd1d7fd5ffe1aa1ca45939c303442b98b95ccfcda596e2935e290c0e009c1cd5b70f37d496219d65c6740bd73627a8043e04f435c99b5b9374eab77d68c694fc105f81368550edffd9de8617650fa5452d8939595bdab389190d916ce1f6b7508a4cbeb7ccd877d7967e0cd8ef28c418d25f33103dbec826ed4f99f18a42de969c5caf9f174744ad9104aba34b6b294193279798da16f41689cc576b7f007ae238c01dc964245649e52b6ef13dc39bb1023b57b6bf2acc958ba28e37882d71d451394c20643bf91dc830c4985d5009f501292c998cf6efd87f140ba8afcdb73fefeedc14f9cb607b5f507c128b58bfadc135592a6ad8c8b957212b14520f1584991c2b9e5329a337ba42c415b07503f707465223ac1892e6e893169e6f7e4d9b1881ea4352d741f2f66b4893c7de4bba6ffcd364a1dca4798303ba0dc748e9a21017861aaafb9302004b01892032e948bea70034ef347192944feebf1b7affca32263c188192eff96ba110e23d42d1af4e198367577846a409613e8c01fa873758c4e1fd860f19a572075daf66d3e05e023583e660dcc43b2df48564bb8b0234fadeec8073e038e5cfa8e2ddee1fc66d4b541c49ef0eb2c31c7cbffbf7eda780f884ffec07b28cab8e107dba3496a0d7c7ea8dbea3d524c5e13ebf38a2468de45beb4fe78d23fbc165ca50c900b1ae74de6a3ade70635a2e059e83eed9a8bccb5e0d9d91f7e890d35ed7b3a6257083885dad790fedb75aae1fbab68cecc2a08ed76a47f6ddf9edd6543dcb228ae12b6237e738239f2f2cddb245b4cad8221575ec61d529f6311ec041e90c694de384583a60e8b0ee3beff8d0ac5d562432e97fc2cc68e5576fcb31738df5ccd42a5694e2889c02d53e02f20790c3f11f2b04769a637a93f9a35e48dfd2fb5629e65fc7313a75e44e76ba03cc8ca1afb51459f18aa72df154f8652397d8da5cbc14597aa7ff0a42bfa548b052a1a094cb5b3038f6abc105d247d1bd3802d6e8740bc6bfd21c4417a2ff6f2ad0a22a35233ca81ea55e1c6cf984656d765eccfb97dc06ae9cdac3692f431a09f09c8c5b8680baeab5f5dcd2aa5d080253da790546e497e537c49c06339a5d9a8115a3dfbbd5fa2ed250060c91a389820b324b770d14407c102e20ff3b5924f7a7ea83612172e3a79fd759c8f4ecdd085b3b5511ab93b615cbdf1212de61a6c30d20af77da8e350d53bbc186298d045692fcb9c72536dcdf16baac7f9b9cb1f79cd17ec7f62f4576f62e710c4b4c226882faf58b442e007626aa5197f1e483f3b5fb35fe6a8a6589d47232a248b9004b524c6d1d661beab6f7aa3413989bd38c7ee420bd6f70a13530d11860a9c20336105786763f7599ef982238ddb3d56541d9f6cf3e0238a2e0fc35a46c85f4f9a8550bbe900e82cad83f4de12fb9c3c8dad75935a4ae034b87c49f385e2c5a3cf32daae3fbfc611835f91005b611b7c8f613656c8bfd59533b8d53f32cd5c53dbbc1447f00e9f0925aaf56b655e8d0d3b4eb53dfcfa3fbbc2eb73b31a1918c3f79526a24aa4fcd49371efb12a616359f8faa1bb4360548d01f4ed4c4836937a9b01c2279830d610d84c5c5f8d8678f6ec5ec993d698f7932d4f2dba9e793527e84c081fba81de279dcc3caded5cba99cdd335771db06409a46608a74de5a2d1407bd58f038c0c30f5e5106a9f1b2e4bbd38f4b76b979896a424b3a5467fc715abf4858b10623708b2b051605ef016d7e216cd20e4cd7c100d29949ff6cbf02e2405bac8642a122164b014e5a892f7e7b894dd9514b1606e8bd69c8a53e987a61071bc83ba793ab066b2248dc2de1819bfcbfefb4d660719849ac8b05f616dcbe217d06caf7ce64280f29c2f98fdac4124a337cc8abe83a483c08870757b7268540fa2effc66b4cf6d84e30e600ee5d571f6a5d1417222ffddeacb0ba253d4025877f3d036a37370c51d5cbd174abd07a048e19e01695e66ac7beffe5fdce01e67304aae6197a06f115c173d3f14d698595d63ffdcb6a6750b71646f11c92ec3a68e159675fd72dcdcdf0d4f8eb18ebc81e7226ecc6864f551e48ed37c56dbea03c1c04f7ec2e030db4266e6751eb77b35fa49d5ab8b5c9cd5d3cc84d8a1c9cbf8e4d82ad7441ed09d54015f67029c6d2c0ea0923b49574325d3add128258bd923567717728e9fe07d19463c8e7ce39b8d28597318f39013597ff20860eea414ad260c1d140f4273045389454996b69d5791f035e5ac55d91d9ca4f69dd1ec2c4992cfd21957da35a45df513d1ed4c0fd6c93aa96ba8f84a284561ca04864a30b81d89b791f3d2fff17e36f2011ceb8a39b4421a85085cae4cd61b737729f017f04ea0c86ce7ab5ccb957ba001b101c43d295b218680de3ac9a5c482b746a1d4d2fee77a3feb27e761b720742605bd7d4e978d623f9f230166ef76da88c948387160c235e201b95429e5a92bb012a4c84254e79d356116f7255ca887966eeca3a7cfc48a8a9f677c64ac9dc66a7472915d32650478066d5ab4f41c29a646e0a051631c0ba2541e4f010d5b424560e2aabf3c01e1ef11d64d7072d4643ab7fc5d072528afa6917c92180c3dec510356c8bdc3011c7b65e446c59234f557c8e53f18953ee4d430a50e33351988f8addb2490b0cb5fa5e7b318a7ea258ca6ec965e90883af230d0fed22b1a884b0748028e410bd20c1ee2855d95ff05a739c7ab1f9fd2e02848c0f1c6f6c1f62534ab6436b9fe29a04ef6592c61ff155ab702e26d28ca22c960ba629c85dd7119423e1910df88a750d99f5a8f6ca3905a828206d041707fa289522478da7f3a22e6da29dcb4bf381ea82efc460f9d6387355857f60978bab6551399dd3463a663ea4c77900b965ba5a3ad538e9f86470be8c47f75896c0895b9d9966ba6bcff40249392dfa26013f5d1d7d9ab613ec3933a795e4d6884c6faaa21897728f8237e47c8b80718f84c7ea4652d97d6abbe11d87d2d1e6e87e27a971ba26fe408e414f9904e4b612585b52735224d4e09ad5ae0ad3060a99f4926b97aef151b7c3e3e610788b972339694a4de8870524b98c0e79522986f6a58bb6574e43c7227d293b4b03d0b7965bf82dc3627bf06d4f5a9601336f9f07331268e30e91af0290deeae7d67fef196efe00fe2fed58e70525a524060257fc56fd71ca685fd3ebb2aded8f54dc711d35607995ade0677cb0c3cca26221fe63e9ec860f062454fc50caacf23e6ed159c9ebeb2cd1837f56efcbc784f49def32c911df08a81b56543ddbe1f58f93dbff5ed48c277d12e9f8c11c0f1817c7763a1a8afddae453eda4de103c24d1b7347a5d631ae2fef904ddc058332be707b1df8cc7a7fc8eb9cb555acdd4c598e3e02b0e77ea9e0f923326ee62e3b3aaabf3082246c81b9bc8942ff93420b2784b33e0ce96639e6c4682ccdf54cd06f84b705a84b1276cc3b39854c9b16250c5b577b3e43fb57b68a46be4ee723ca288aea68f7f94e54ecefe0583c77666a3fa5a7d4d25364f2c5df743af15ea71c45b6dbc5ce235768fa484173675a6f48bcf821c5a4d65162825ffffe690b79c954c23ab40171b88047f6ae02e30017e53e1923d93fe6ef6290f227e1b7695a95d5846717a6639b0a7ff56ab0e348ce2887430edbb6b3df42676023709850396b289def0a99b4d0ca3c5f5a94d3cef3dfcb459a3031e120423a5b39a32f0e10bb71493077d5b62f81e2b7e9be2991781cf3c044b92ee2f3a2d4ecd9cab001a467d678f4909627277891fbed5d0f2ec98b9ced6dc9e1017646d021a7c915c2fbacbd682009a69f38b3ca4b444b751321bbedfc96a4dfb757f16f52bc015f17b6ae818598b49c6a643ea1c2c18240ba6bd0d29c56e633a2b33d679975dcb647cf2e0a802db0430f6de3fd249026998cc029f1ac555a299dffa7a9eceaf115a1df11ba15203804af4111512607c04436ae308a14ce8baee5108802266f2eb9d479177308448607b1d9e84f3231e80fd9f3421efa750acba2357d2821a641bd68d0186600a9160d41fa171db88cbf19e5328f3a1a4cfb8b95b1df73c28cfa2798f3df1e5920ddde4c12c7022ca35489121f10da78c5a5c414b390d7feba825574d879c507528424b7aea513c66ddca39273001c0d9e1cbbcf3e3e0e1d46dc3dd200471afb612f9442c993f70ac6a31e4ce80fc88a17115ee1681aaca75fb738bf5f18b83bd52bca2c01a077a8bdc951c1a279ca86e70126f564212c5ebbbd715169f649ecb80ab20f8a5f4dddcdd164814c600383774b428f572ffd5ba56d4582e6a36d890b0c0967e2c0e9794cdb1cc487785c152b481d997df546d9edc8f59169f95d14250d8f0c27e458242fb19d860d34f935b1d6b6fd1853deba4c1c37d506a40e4c413cae16f62452ce36093ae90a2d2c8e8d34d90a75162e0f0c2a91945ba2ca907e9df2b2ae4f8e09af2104b51424c92914cc39f38f3abfad95257b08f10227cd25dbb7ad82778cbd0538b8c26bd7b9294fbf16fb05ac07539e5a51cb536b58e5b8a4f788a27d6c2bf49a7200dcd1b18b34a3c5dec6fdbd74b5b7f20716d6dd5dda8fc095cd6fa9d68c9f911691a674241b0ae75ff16cf9bb07c212323498f6b1f67a5a6736444f0218c8f4a7429a3d871c07c212063a44e322e11f32c1e608a1299804612aa6016609ce6817641479aefc6547980c0dabeb9f97c17dfa8348babea24052794683da9d5aec4f024f82f9505d7b3bfdd9145193d171cc8ab484952726cddd7db034f32fb9f7b089b5690a23f3b7deef7b8a2b070d842e37dbe3602068772f0f60e0dcd91a48dbe65c48809e6a72ba4f792a5ea19ab5491c9d2af3e748f7a1e66aa7b107eba968894c76bf47eb573d15992f974c63355c7b3ab20e3d987f9723e29fdf70ee00aa8ab563b19513919d92b70ddf381056724803301f27d046ee8884c2aa6f584bbd72113ca4382b960cbb3be1c624e5d20ce07acbcc74877d0bf5c582b25c42c6a00bb70c1e548bc041fb2fa500cd72265c330d5ce0d6d5e2e7fbfc6730cccc5c5136bbfd5ccbdce6b603c0049970cbbcd79e7d85926f5c26b1546344420e7adebf26e5b8abca575059f8a0e22856b69a159c47a7a5cdfb124449d3ae6676cb5080817cc012f0082380d726e8c10e0c7a5b51a2d0a9ecb647dbf34854c8dfc237fd8f3e2ba65f7dec61116e1d6898c3a43bb95a84be48a342d1e298022270c4c42cad58679644968af2196aed4e2c7c95a18d5414c3dabd4d22cf4b40180b9508bb86a73da67a63e565cc6c51ba5b630a9afa5c3c57319d2ecc4089cf27d53e10d54e026e695e60ece576443b3339eead645cc49df662371ccec8c00f9d35d33fe7b96c7570e07b8292a3ffbd17a2da6965caada793435a4da11a381543428f3579e883077372555c6d62b91859871038a8da4051b9c446bab2d975e25fdab4c05040dc0d08a85746021cf6264836d35f3a8e92e157ec781b6d0a3ec838003fa39a6bac42e9880da72aeb6c29728680ac7834a85c8f80d9a77c2db4e2d976bad8caa7372b1d8285e2af70ad7129f81468f540b1d5949fafba805ea2b8e5d71f90314cccc0df8ba6b8cb4971e7281c8dffb27c484783a7c09d402b5dacf11d441eafc2b0062dd7d238e269a076a713dbf8fec5164cebe1d1e0e57495a55864f68a3e522bfeaf76fdb331811f85ba62f5000a059b12f14d4806453570ff72d5510346b7f9950d6cada1dcf631154a6d45a51343cad3714dbc8679d8edd48963671d75934fa9649f05aa9f22fc58ff295d34990af87c164ad17cf2ac74c07bab715fd660d4ad70a7242ca4066f7859cc1ff61793f22e46f43b199682b92007a82a7020666d61f6cde87bdd3afd67959bb82d3863dfeeb7ea7cb461e9e04661736ed14895a95b223ab57fcc9c1c30ffddae87070686fc23d438a2107575feb8cbe2533c468022ee88869ebd6c71ddc4d77ed407a60ffe932811d69fd80e7845ef943fe1c5f5fc16fb92e3ea78f86677b0e9ec55307f6e01475843e0c47c4049c89ed0ca34dbdb3e76a57a79c0129b0670b70ba42c9f21be59a242fcd6aeb6a651e0d335972359485e90a6a8c186778881ed126175f258f43f0282c86980f3f3ee17387297a62867af985d5921763a83f48d8e9e6e7ada657d791291be5e3ed5a1e858b736b50870d33f2b6c433f834811dd04483e0f26a4a1b334d3cbc41be155ebf60a52629f5d87cb2b62ba2056df145c8e14fc6efd3545141a293e66ab525546f328c445aeef1ad709ea6314aaa046e18cabda89e98ce80bbd9cab7b53cacc221b5c1b2c8869513dc24aba8a3a14011cd5829f70f7f5aa6195dfac4f9775aa68cebdb58a10e2ee9671f89256c0cfdbce34be75fba9b505c2ce1bdae22ff067092df9adb96a63527b00a49812db96db5d89d2cbc654bd40770582c79c978f40430c49289af6d42265daa603a89cc8788c9ef8442144a5af3a13f14de417c85fb3a3eed61af3aa3b96f2f9dd3105993593be276496dc340b83e8eab1b96673676ff8ab9490a8a3c5691bb4f8fa1bdf55f2608b4b84b40ecce0fba911ae0ec7c5338f4d26e3acd3f7ed3a9280849343066e514441f349a6be719984d1ccbc44edcf1d1e8e569f967bef6026b71330341d56ee4037c14daeea820b5e7788369bd2e666c1b7f66725998db7a326c2f099f887c5674abe9f7b790fde0b91ba4265a0f8b01f3dd87fe73537152f5aebf1d9311c2d24a8fee9c1e4495e5cc83dffa6887a9c74f311a12bbf93c4f626a61c07517f45087b546a4f8942480e73fb6e1fe2b6e1cbbde43a30521dce8e58fef85e33fd9612dcfa45dc939df65ceaaafc704be02bd2ebea2a932bac4062ec19dea4bd945a3a024e970e41f62dc514fa3ac409328668d73d2a85e2d32395c345b9f40bb7124250234adb473569ae7d16c148202a739270db7aa3531662753e74b1eacea014f5c46002522bf2df61a1a83b8f6444634570b948a6739189c08e23895f8f89bf7f6211a5a49b3704126368b9fa091ac9ec2ac7cd83fe84eea21ead658973252fc4b74e4e834f4e2eba0220d8acee0088b2b9f2f784dc548521c62f81dad4b81586f0f8ffa42fed96bf1a05f627a1c8f4bddd37631061802c49538f84456367e760a748790139de94ac3f081e0a61a28b49a1aba9b125955c575cde9440046eb4804dfbbf4a25aedecdbbbb05d8e0f0343bddb935928caae8b8412218637486a037177b5d197de80872192225258813c5746db338666094b040f28910b4c5d5720bee0eabbc944d42322f635992046f55834ea8bc2f3bb7d849450b68d5b30b6546fbd1bee57838286b198166b46912a4b6f67fd19fcad8c51e2335107382d66a3d2b04dbfb19d5afa0e12e859a308d5dfb7accf8ba09e7d360a9b4a4ccf3a225bccfee23c83108f889fa7114c897d4ad8fb588b543907d4c480c68b82e25c533ef9a427fdfe3f1b6de44ae1d5322fb20d035152ad98bd936b3c369b4e0faad618c5aa11b6fbfbdc2b4aa1794f51413a92cc0c6be65781744df9ca6889f1ae28e3eecd2fad03e52021b29cdc0e01466b29a5016a848743cb4cd4f62cbe40dad872688f691aa910be44dd2a63bcd5a9664e27b424537b2fcd0e73e71460333d85239f4d6405b917aa62e10c5e68326450a6601288d2250eef297b1a385522757c6575e83e43cb50ef81bc0daf8acd753c85e01c1c8f0a018306090b8fbd616451a4d85dbf0b6f26e5066d3ec2a63c2450d1826b9e2af928b2bb402179cab2ab340abff74f526fcdff5c8275fdcdf663b07a92167a1b065f2f76de01a82cebb8213b1f40b2372398c0fde66c45b98af517505d993b8922be8548be93b3734ee22fe25d3696562f36afafe6ed862d6772d5082b6f220e501ae0ca6745eb2834ef62b790e460cff73c497461f420dd18d7b6244d07eefaa04d9d6beb48f04d5f3862fdb43e7901f6fc6b9765de4cba331d54855a372a7d3dbc2fdbf160375fee4d4927743eaa72fb3ae6bcfc4daf0d965a8dd2c95ec9bc717e66875424dca27ad0a0f41578526bdd2eb0f376a6efff298fc4e9e3f4c4f59a030a7ed605f3b11541f2fcc9c2fd141ed60101253e2193a2b60e3b0d7794d03466357b7faf584966d9cb841acb120c217fb854fc262f3a66cc49094acb25180c5e8d248f917c78bfa9d95e8e4e3c9de70d0bf2e0d55c47d761329a907e57acc3737f50f5a50595761055676837f5ab5a0438c8bf9e93382890631f166ff861332da035d9fe329b9adbab133905a714475875d80ad628d2ab057e51f4346524206001af983813e433039b0cbb739024bfbc16addb0dbca1d754bea14f41739576014ae6ab2c98749b92ee6fdf2501cf57a02abdcc59660462756168d7d77099f208683284b51b7db9492d3d56c23384cde03390d047e9f4c8cf2680f28bf913799482f4db89c87756b11f63ea76003ea64e711a320a78f4c80a9a80987902273182f31c89209de785165baaa2caabb8aacf85c778f9cc775640f6ba88ff7d7837e453daa70c976394eab9fa9a7372b43ef3ea229d3fe3055096963eaaae56de4e54c638e6b995434362a24bb75104efcc6b3b9562d1c6da7fea662ef30951163031ecd43d0bb1b593534d0d7a50055fb52d82ba7c01d14d574324d817642fdd88b7c293b6dcd48f05f432700f86204135638736df59a1bf992aedc0b95e0258d21fe8cb91dc8ae3764bbffcaf0cd602e9bece587a83884cbab87610041939013cb21fccc069dc5d8b78d73136fe3b86f3ae345bdf919bf0f7640a14e81a0aeeea7cce00ccddab8287c708d7498a85663b7018f7edb6a8c96d0b720d0376b15ca087d5c2c715e1eb0f04c8151b3cdbb63167b251734a0f64a1908c47295e2daef671f85ee670238ce646b779b84a2d8a9ac2114b78b36fe8d4a6a5e15e8baa691b42f094c2657135a82b40fd2daa44052820d8337be0db42fcfefe0d86edea4a92143ff9911c9956747e418956ae1789f2dd2bcb21408920f116210dc8bcecc3023b43784b59af04fdd98dde251130d190d1d4bd6a35b66b71baa8199724c477a09484196961c8623bf8f1fb4b7d405857440b0661338b36b34e2b1e4b742594799ce92191c2169856244927ed503bb198605b42a1f5b625db8e65e3d0f27400bba047aec485597913bf586f9147b8ba1f9093f31583d28d06e1fe3b76f20e6141b7a2a39d5eaaf4eb13b3d28f3b01d7cfa5b217a68113453ab9818dfa8011a498cc85f4ea519a5fd49b9700d4a65e61ca938cffbc70b7c17a14618c332ad2afda85757e297177feb223a0532bcc572286ac60a65d40407ba19d5e04d1d6362632589630a50b5cacfb3ee2fbe62b8387cda6137560a8df27e3352f3d894b64973c9ba9ad54eba7a00df020a85e9ad9ba23db7a960c0ca32e3c10d77ff43dd249b66b814db59f81ccc578376696b2821d66c43b7c2a1739a8f9822190323ca81fe4c96d214eba4124b25e906a935165044f3dc51c2bb79f25ae7f6ab4c714865b36361d95fa86fce34206bcd5e399b65f6e09e15674e2fbdbfa3dc361ab03f5ffcdcdf49b1025fe3533fb533d2885f872d22bac131ede24fe48038f89dd8eba57a612a093ad09ad00e142d0c4f00aa768585d47a195e086bfb39be753e7fbe786daf9697d163c5cd81920efb3fec67b3a64379281188681aadde677888148eb50bf6392e8c82950423a440a1d7e5e5a52c6ef308ab11cddd13090bb9c5f8f77e12467d49a080436b7e422d3218b4af353cdd5120c7f424b2ca70e1686510b6c2bdf077b15613a942405743d68034f0a73840fec7ccbe552d69ebbdb8d2757d16d3b6aceb347a97db1ebe37fdcef1347597f48e76cae346101552aaf0bf270c04f69a7f515087f31a6b55c27550a96ad180bbec6d5d6c9b783e6c5d3bd79c267d8de05dfdefbbfe5a2cb72dc286523a67fedf6de67a423d7baeb88e95171767bf310580d4a87e919de37c646641720d43c1f75a117f3e169c8553d15813430aac9d371a8e50391aecae79f3872771703fddc25b90953da51ec506aa9605703c6894848dfd602dae7cf02fe64c84478c440273ad7dce2e5de288cf538a3bb1a5d1fc6e8d1bdbbe967c000f9c0f0e7d7b778ed12998413af7936940212f53a963127b2f9f0651fdf48f22049bb314255092269d6a0bc55a23ca0fd779740e69d8aa07dfec9127ca5fe640051c618926bd61665dd053a85c0d2505de70244cbec6a44a1ed261f7aadc5e7591ef23a845cda9c4b1f086de8a059c8615bab61970851afa6727fa7cd6aa1fc2002c2e41920d66d92b94eab31ad83641ceb127503bf14e481a1bf353d3152bc48a6638ea1b03993f08cef777e912b52205cbe53e71a19a01b6bcef4faae461d2d1a018931ea33f3f588c0d7da7ed0fbe2ec87213fe3fa8a5145e3a08c0737bab972bba5bec567ab05064f5be500f88aea80bfac44d84348afcd26fd7e4c5b5596674154b7a90c205c9edaee54bebf902fe8a79ef8b2fd8bf32711b6cd986bd5ecd01ec9c8cd9c66edcfe763a26b69517650cddecacc73ea57fcb97c6221a145aab4b912dec78907d5bc09feeba0446bd425cc19a5cd07fa3893feec2c7a9c086b19dd9fdf4435cd4e0a5b94d57f6bdb198db3a0ecc383d59ddca591dbcd0f4463da850694ceb603e766e953e129b940b4148d4a02c05bcb20815d4c07170a859eec2f05b28f689b9eaeced0f1e3752192e05756184134e564821d037ec779a880a85094df6ae56db01ed50625f82406b3556825579388fad701ee8be36b04ae9499a05ea288c0c4494f77b10008a77f253f187a42189b223f2079beddd49b76a51951e08a7d216c70450b431e3e09c7590f02e59a7216bf43dfdd55c09517ce4ebd94990f11ca3103c40faef6efa2d04b2f17afe8c036946cc1b1f39196eae7deceb7075c407ad70eaa33219d0ce775313cfccff7e2816b8e73e24effbd8721771565fb1eb5465d0006f0cca0b6137f31b0b36c3550ec111e108f652aad7801ab56d7b81d0ed7a8a1e91cb9059c4c5e89c88cdd22163360ed80abbc25d8a30c893857317df63c01ba1650794a6d84115fac073094a8836159ed85802d0c4f5bd8bb3c44d2583f8360e1d4f6b3fbf9f7ba0ae5a7d0ac5c3caca9ab2265ba63a5d9021d2b45b10db3e13e0efbe34c2e134c0691daaee48d68ae4d78d8fb1857746b5d12bcab319fda90392acc5b8f280b6ed700e702ff027690f34d57b058c73cd1634b000094aec733c040610ba00098c551fd483ac09f96c7a52f15f0754b732fb61ee29bf8a21a3ff96b920297d984138c62164b4c4d85180a1089b42ec24ab36bf7cff0a7da252c6dc8c9cca57c23daf7163fac5f25af6a76be7d90a073f3d26f23a3d4f19008610fd1a2c3cabf6d7a139239916288585577d4b905c308b6f6957a39de1bbbb9ef4fbcbb2989abf3102b483f4329ed27d626d3acf18ccd93caf089c7a2b069179cdc887ee451ad01ccc9076039506bde0ae6dd6f42f2efc5eb66d70c6358e5ec7f132c1d917d7341c24be8bbae88955b6c8f3f6ede4c14832d1ff7a10fec2c3f4f02aae585d22d9dbc5127188fe2e2185bb77cd2e24819ee075db64c86f9a6304bbeb8ec4dca40a0b8cb7eed0edb2d4db9480612579455d9b66dd0dcdda3a92c0db7c0ee827785cc6be76d9bdc69727cf2308c1f6cd7a61ba22bb57043af586f239b08cecf1920e9dd8111767e7fed7f5198a6c55db2c2262267839d6e77b85c7da51aa6406faff9bdc40f7f1e40c6fae3465a70071c07dbb43dfbea74294faad5fbc0e07ee42707da27744a3dc885fa060c88a5405fb59fd0b5acce3f41e88e0ad62f38157d708a8e269b07669989136f2668d87af40a2e1fc18448ff6ffaba3817bbe77bbdd57550dbf3f8960a1ad7720e757fe1394ea0e67c66d5b06048ae9ced4063e940924e032a32d27ea1282041a74166e55bc4a3c8009ab1a4d259f777db68844efef53a59401dfb6806e361f4fa1db269cdd9d5ac1920c0c5515109beed62b6ddbcdd76f36ae50d0565a9b18b3e2cf5f666d65b8357fe8da0e56c57565a9daee7879350cfd7ebb593d07d1e8c36dc3de210ae5a4db09656339cadf1e51e131f128abea1018404cecd84c6538a35d004d10f0d57b3dc6a08ce8237eda674d99df525f17598e92dd5d014f896645b96b6ebd871a2b9566c87a31cc6910303d1d5827a823e4c7ecf618f618907e14c086877c60dca5d2c7ee01620bfa3950a59a3cf4dfafb4d9de05bc111c8911e4fa8489ad69b0ec8d0d2b2bbd3dacbce8c5059a4d4b679498c9b4f15bf8ebbd116e916b58b2d9304040439c1767cd59bace90e27c155832aa4402322668b3889c6af411db153b0cf541876a20eccf1b99db268c4d2ec7673ab1d79a4eca1742d76f448146479b18586741fe4b368bb8558c543ec4c904d43f32bc120a985203b5618a68334313f0f3ca2967fdec0c52282eee147e43717718db5c352071f0e823ed0431e04c0f777e026ad632a9af7bf96bc7f4240a3c6f02b122f44618daf8bea72158362f793dabe2f8750483b7292391f43cd6aa4ae270843118b90eb497fcabe4bde14927429291b0aa46737a9f117d3ece6c61bcfbd4d18c29437195317646c804d1952dffe7c13b579f1aaa83ddae6d871c103fa90af438dde192c160c6ecd32056e4c2f1ed91586d374d4c972bed1d22a7a04b80004fdc8839b927013d4e2a96a3e3da15bf453d2675a84087558e9b31a5fb5eef925ae4616b859b86c06f5a825e2bad8319377bf4b7a7dd89fd31c5926bb320fc3437cf41141b54d9d40ed984043187ecd42364b49484764ffe3245cb597f58a1b8590be0e4925fbbe671f1e82a0455c5633c014e7c53560c030867aaa4984ce67b13704463aea8d0c6fdd5e04e2e4dd4de8633bf87a328a8721c8878e33f585c95fc5f2973d384877508fa422d270746df9fc24e1190b3aff599794829f42ddbde84e1d7ac10d3a672e7bad8e2a93bb01dff2001c4bcbfb8427d99e80cb3e20677991b83e798fbe3af9044be698d20ac54401812674d00b7ba19f352175440edaaf377bb40817d22e503ec4222359cb00b6de189d7e32b2c3e2894fa89dd5aece7ed281e3dd00cb28818486f700500fea1ff696eb5eb20d71653d9dc0e801d6529b8470ee29ac7510cb4e9f8a6585df557fc8880e14e0ae7508beeb425c0f68383f76d5fafc710c874caac3703c37e60a1a5ad76941e7a813c3e3685dad8d114df738023313b020c2750bcadd8a20bd9fad2b01b8745d71640303260476d5ed812b6f6ac354361dddf3d90581d09ca60b1ba0e41ae592cab83c94e7196d1680c4dba974549c46c3616df1ddcab76d80b5543deb411fe6adbdd3791818bf488d13a9562a42af0c47ad9df1a7a5447a7046adfcfdd871aaaec3af8527ea61b01d24b242cfdb4d04e21b8cf19606038a66c74e8f465ef3d9818107c967535da6fdda470758c7e67772df46e2123b7a5002582198656009f97b3df4ef0ed7b5c325b79f66fbebdce79fa02643d6fd7ebf2be3a47384a8e8bb29a00ea29dcf579a7d9591ac29f3c31f559b653744a6b343034f6a183c3f7f7325a2590b5389dbb79caad61c820593fa933696db495fe3780e9e206066a4a4610a672c611ec0c229f3ea61b03f77c894ddeb89527ee24c33fa044895aa4ae152d483df87b0f1e7f74b06a40813f056e63fe007084b3ec51715501eb57623ff1067d2dae9eb9bca3cfc8f08bedbb13df6ab86cc4fdea8ae60efcfbb9e0890750b8332ea2aa43820c731974e5729fe43a66ceb16f33d24c28f221155f9de4fc64083a12816dd60cc6cb179dbc253b4d1d59ee434f79fe6bb2e3557db2de5df88c23fa599cc0f715738ee5907c21480c7a85f93dca41ca25ffb43c74542e3395d5431b2ba61e3d2fa9bd9d87a45ac718b5eb38221acdae463b1d7e6e1941c27e28641fe66e5a03fd5f9a54ecfe40d4b4e7adcac0b909ad4b5a7e5eb5e59ffb61f2343fa920956760c3fffdc07969662a14438c920d2be34a29b25db83a69b0ca517673aa235605892301ef7008b3962d4896114802aea62d4e473c8115e4ebacff2c771a992b4f04ddb33a47d4a42bec3bacdfdbe8ac1bf7655be17ef5340052862b2fc2a4c800092a20c68a88f14241850827c53af845956232d2f311c1314a8d2afe90dc3db5ed80dd8fb5ae63e66b61d169e5715ec721e333c33b5ed1360ef3e8363ae73bf7854e3ae6c471257ce13e89e5d47cd4832feea0f8f63a8c3be5e0c0e118407cc2b88bdb9e0ac8308c1edf12639ac041aec080b3acadc4bc56275cf3f6fb2062d9a811b47006584c248bc101a3451edfc38d469a9f67d60b7df4af8f5e2701631ad7026ee97396a215550cbde02018c88dcb640bc8b5678efab4fd2dede39ce545170c685eeafe0e21c00e51687a84968f26ca0ac7c75d22292b892b240652d1d1d06ae46b71e38f145241dce288aea423855188544724f840f12cdda14cae5030ca9f70de01fba13baa4e4bee136358c82a2d9c308e2b2b3d453878462fa75913f75585b9c5c18d8a87585d8d40e53a31fea8ca2e349cb33994a477b2186d7417a8e0973a32e146ea2beaf2285d37b8394f024e9d5946490381d1f9a052f0a0028c658d12c225385d58eb636b21e7c7a4186be487373830088ea331ff8e0aeb21305be71f838070509aaae994239bbe3f34f5d864fc0a8b37986f3ab5368eb437894456c1af779df9bf81fc33a24f97eb452d9d17c14ed5cfbbb8d965d075e8425aa49a3a5798b10034363becfcd20d79bbd010f31110710c8c90e76034cd5d7daec8ca55355b021d25059a13271ef18ff793f7d8fb6464dd22c09f7d285afcb4df381e3f50d0761753652b6ac79faa42e34299554a4c3ccd1d0ce4825f4e5a53d8e1692ea7a7d7bcd1c4b44294e2a5da0bf732324347d0133d3fd3c3fe2f581de57f6da1a7503f0c06bb5281d81c1ca60a7087290d5922e9bac37a6573fcccabfc37f13acd40223957cf65ef945a467fadc5e9172a6953f5ddfd3548f56e28fd20488a8e0250de6bbcf1092cd834e0241537dcd6ad8a45d8934760b07a0976930c1c47872649f76af8230220b85fb33caf1e8c67ab1779d5da7cee563482ea23fb37755ce8913049689cdaff136bc6d9135cba62319e0f7462d3941ae1b94ebe3b340aca6431332850a229dd928dc2e1141da61a4fa8d27dc7b72ba40c4f68f91641babb90ac37709fc65eeab935b3f9c450d733c48b489a894eb83e744ca9c43f7a1b335c9080f24421b65a289a04ab1b35472ba4b0177f904f90d07d77d006ba367527e08f1d64a6a749c23f50bbb2ace4389b653881460794e68643f57373f5af1484b0155ccef785e53f32ab910045479d21d2977d7c2196fc4090e2ff78893bedddb39ab12760761cc3eeff44cc266b999b5518a56ca9eee2b7fcdd28a758feac726bf82fe3778df513c83e2f2473f3849da80d6f4e0b3ad810bf9e75b93a8d0459e465323bbc3f664fd23b0a3f3a4395f9c3ecc452a333470a6c1d7cf75442de78db3296389b76aac888ec8da87bba810702dc04a92b14af0f05daa90a43a9c9420c6701f2f108f342287e4ea78e5424c357e695b509d9328b49eead1b3e8635f1dbde47563a2e597699dfb517c7cd603b64b808bd3cedb89b234b9945789ead9744ad6db4df89ea4de1fcab4b90aafd02d8b54b8dfcbfab9fed2a3579e914e72c458887b0414d68009462b45989e22cfd5e9a92d08c9b17a3e2beb1bd4acc44f9dfb0923a095f6a7243badad55ac7a232edf04742998ccc83b0b2c3e5ccaec22c5f0948da94484a4940abbf827a730ec5fc4b962e526bf3e74ac666d90309d6b62cb8ec8f79108f01a48748d3c4a9679431947d82bd6a166dad029cb93a31c916675b98721a056bc76bc06f5f3a4b23f31e150b21587ae23f19e731a3b0c07940ccb4b57d612a37abe4f4013ed5672623be9553d4b906c029611ae7c31cddc2c3343ed5a997f931020d6331b941f204897e1a0af1150512c42bc3432bd8e65b2cbed46e93c28c0caf50676138c47f96fe2f18c4c1b23763bed5879aeb3e2520b39d864f3c3721898edb0938ca6e96cdc9907476dd22772098d6e0296da5fb7e710c632eee9c115e73ac924bed857c3e57f416055ce15702846eeeffbcc7727c7b13d8f5b3fb28894a24244e31c1d1adeb08a18f7ba029221f6505be40a32eacdc77d606ae5117025eca00bf9e260139f34229e6022b5309f825c93fce049c872d37b9318fdfbae40ab881e9da0d15d7a83502cdc243bf8ea2c13f82ca12ca12a67989e300711ffb90b8adfef0b4ebcf2f580202ce52d1a5284bdc33989e6d3aca8cc74fc2</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <categories>
      
      <category>控制</category>
      
    </categories>
    
    
    <tags>
      
      <tag>仿真</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>impedance control with visp_ros</title>
    <link href="/2024/09/06/impedance-control-with-visp-ros/"/>
    <url>/2024/09/06/impedance-control-with-visp-ros/</url>
    
    <content type="html"><![CDATA[<span id="more"></span><h2 id="代码">代码</h2><p>先把代码贴上来，后面进行总结，同时结合chatgpt记录一下其中的数学原理。<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;visp_ros/vpROSRobotFrankaCoppeliasim.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;base_tool_func.h&quot;</span></span><br><br>symc::SystemInfo sys_info;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>** argv)</span></span>&#123;<br>    symc::OptSettings opt_settings;<br>    <span class="hljs-keyword">if</span>(symc::<span class="hljs-built_in">ArgHandle</span>(argc, argv, opt_settings) == <span class="hljs-number">1</span>)&#123;<br>        <span class="hljs-keyword">return</span> EXIT_SUCCESS;<br>    &#125;<br>    symc::SignalManager::<span class="hljs-built_in">RegisterSignalHandlers</span>();<br>    vpROSRobotFrankaCoppeliasim robot;<br>    <span class="hljs-keyword">try</span>&#123;<br>        ros::<span class="hljs-built_in">init</span>(argc, argv, <span class="hljs-string">&quot;visp_ros&quot;</span>, ros::init_options::NoSigintHandler);<br>        ros::NodeHandlePtr n = boost::<span class="hljs-built_in">make_shared</span>&lt;ros::NodeHandle&gt;();<br>        <span class="hljs-function">ros::Rate <span class="hljs-title">loop_rate</span><span class="hljs-params">(<span class="hljs-number">1000</span>)</span></span>;<br>        ros::<span class="hljs-built_in">spinOnce</span>();<br>        robot.<span class="hljs-built_in">setVerbose</span>(opt_settings.verbose);<br>        robot.<span class="hljs-built_in">connect</span>();<br>        symc::<span class="hljs-built_in">ResetSimulation</span>(robot);<br><br>        <span class="hljs-function">vpColVector <span class="hljs-title">q_init</span><span class="hljs-params">( &#123; <span class="hljs-number">0</span>, vpMath::rad( <span class="hljs-number">-45</span> ), <span class="hljs-number">0</span>, vpMath::rad( <span class="hljs-number">-135</span> ), <span class="hljs-number">0</span>, vpMath::rad( <span class="hljs-number">90</span> ), vpMath::rad( <span class="hljs-number">45</span> ) &#125; )</span></span>;<br>        symc::<span class="hljs-built_in">InitRobotPosition</span>(robot, q_init);<br><br>        <span class="hljs-function">vpColVector <span class="hljs-title">q</span><span class="hljs-params">(<span class="hljs-number">7</span>,<span class="hljs-number">0</span>)</span></span>; <span class="hljs-comment">// joint position</span><br>        <span class="hljs-function">vpColVector <span class="hljs-title">q_dot</span><span class="hljs-params">(<span class="hljs-number">7</span>,<span class="hljs-number">0</span>)</span></span>; <span class="hljs-comment">// joint velocity</span><br>        <span class="hljs-function">vpColVector <span class="hljs-title">x_error</span><span class="hljs-params">(<span class="hljs-number">6</span>,<span class="hljs-number">0</span>)</span></span>; <span class="hljs-comment">// position error in cartesian space</span><br>        <span class="hljs-function">vpColVector <span class="hljs-title">x_dot_error</span><span class="hljs-params">(<span class="hljs-number">6</span>,<span class="hljs-number">0</span>)</span></span>; <span class="hljs-comment">// velocity error in cartesian space</span><br>        <span class="hljs-function">vpColVector <span class="hljs-title">x_dot_desired</span><span class="hljs-params">(<span class="hljs-number">6</span>,<span class="hljs-number">0</span>)</span></span>; <span class="hljs-comment">// desired cartesian velocity</span><br>        <span class="hljs-function">vpColVector <span class="hljs-title">x_dot_dot_desired</span><span class="hljs-params">(<span class="hljs-number">6</span>,<span class="hljs-number">0</span>)</span></span>; <span class="hljs-comment">// desired cartesian acceleration</span><br>        <span class="hljs-function">vpColVector <span class="hljs-title">C</span><span class="hljs-params">(<span class="hljs-number">7</span>,<span class="hljs-number">0</span>)</span></span>; <span class="hljs-comment">// Coriolis and centrifugal forces</span><br>        <span class="hljs-function">vpColVector <span class="hljs-title">F</span><span class="hljs-params">(<span class="hljs-number">7</span>,<span class="hljs-number">0</span>)</span></span>; <span class="hljs-comment">// friction forces</span><br><br>        <span class="hljs-function">vpColVector <span class="hljs-title">tau0</span><span class="hljs-params">(<span class="hljs-number">7</span>,<span class="hljs-number">0</span>)</span></span>; <span class="hljs-comment">// initial joint torque</span><br>        <span class="hljs-function">vpColVector <span class="hljs-title">tau</span><span class="hljs-params">(<span class="hljs-number">7</span>,<span class="hljs-number">0</span>)</span></span>; <span class="hljs-comment">// joint torque</span><br>        <span class="hljs-function">vpColVector <span class="hljs-title">tau_desired</span><span class="hljs-params">(<span class="hljs-number">7</span>,<span class="hljs-number">0</span>)</span></span>; <span class="hljs-comment">// desired joint torque</span><br>        <span class="hljs-function">vpColVector <span class="hljs-title">tau_cmd</span><span class="hljs-params">(<span class="hljs-number">7</span>,<span class="hljs-number">0</span>)</span></span>; <span class="hljs-comment">// joint torque command</span><br><br>        <span class="hljs-function">vpMatrix <span class="hljs-title">fJe</span><span class="hljs-params">(<span class="hljs-number">6</span>,<span class="hljs-number">7</span>)</span></span>; <span class="hljs-comment">// Jacobian matrix in operational frame</span><br>        <span class="hljs-function">vpMatrix <span class="hljs-title">Ja</span><span class="hljs-params">(<span class="hljs-number">6</span>,<span class="hljs-number">7</span>)</span></span>; <span class="hljs-comment">// Jacobian matrix in world frame</span><br>        <span class="hljs-function">vpMatrix <span class="hljs-title">Ja_dot</span><span class="hljs-params">(<span class="hljs-number">6</span>,<span class="hljs-number">7</span>)</span></span>; <span class="hljs-comment">// Jacobian matrix derivative</span><br>        <span class="hljs-function">vpMatrix <span class="hljs-title">Ja_old</span><span class="hljs-params">(<span class="hljs-number">6</span>,<span class="hljs-number">7</span>)</span></span>; <span class="hljs-comment">// old Jacobian matrix</span><br>        <span class="hljs-function">vpMatrix <span class="hljs-title">B</span><span class="hljs-params">(<span class="hljs-number">7</span>,<span class="hljs-number">7</span>)</span></span>; <span class="hljs-comment">// joint space inertia matrix in cartesian space</span><br>        <span class="hljs-function">vpMatrix <span class="hljs-title">I7</span><span class="hljs-params">(<span class="hljs-number">7</span>,<span class="hljs-number">7</span>)</span></span>; <span class="hljs-comment">// identity matrix</span><br>        <span class="hljs-function">vpMatrix <span class="hljs-title">Ja_pinv_B_t</span><span class="hljs-params">(<span class="hljs-number">7</span>,<span class="hljs-number">6</span>)</span></span>; <span class="hljs-comment">// pseudo-inverse of the Jacobian matrix multiplied by the inertia matrix</span><br>        I<span class="hljs-number">7.</span><span class="hljs-built_in">eye</span>();<br>        &#123;<br>            robot.<span class="hljs-built_in">getPosition</span>(vpRobot::JOINT_STATE, q);<br>            std::cout&lt;&lt;<span class="hljs-string">&quot;Initial joint position: &quot;</span>&lt;&lt;q.<span class="hljs-built_in">t</span>()&lt;&lt;std::endl;<br>        &#125;<br>        robot.<span class="hljs-built_in">setRobotState</span>(vpRobot::STATE_FORCE_TORQUE_CONTROL);<br>        robot.<span class="hljs-built_in">setCoppeliasimSyncMode</span>(opt_settings.coppeliasim_sync_mode);<br><br>        vpHomogeneousMatrix fMed, fMed0, fMe;<br>        fMed = fMed0 = robot.<span class="hljs-built_in">get_fMe</span>(); <span class="hljs-comment">// get end-effector pose</span><br><br>        <span class="hljs-function">vpMatrix <span class="hljs-title">K</span><span class="hljs-params">(<span class="hljs-number">6</span>,<span class="hljs-number">6</span>)</span></span>;<br>        <span class="hljs-function">vpMatrix <span class="hljs-title">D</span><span class="hljs-params">(<span class="hljs-number">6</span>,<span class="hljs-number">6</span>)</span></span>;<br>        <span class="hljs-function">vpMatrix <span class="hljs-title">edVf</span><span class="hljs-params">(<span class="hljs-number">6</span>,<span class="hljs-number">6</span>)</span></span>; <span class="hljs-comment">// rotation matrix from operational frame to world frame(linear velocity and angular velocity)</span><br><br>        <span class="hljs-type">double</span> wp = <span class="hljs-number">50.0</span>; <span class="hljs-comment">// position control gain</span><br>        <span class="hljs-type">double</span> wo = <span class="hljs-number">20.0</span>; <span class="hljs-comment">// orientation control gain</span><br><br>        K.<span class="hljs-built_in">diag</span>(&#123;wp*wp, wp*wp, wp*wp, wo*wo, wo*wo, wo*wo&#125;);<br>        D.<span class="hljs-built_in">diag</span>(&#123;<span class="hljs-number">2</span>*wp, <span class="hljs-number">2</span>*wp, <span class="hljs-number">2</span>*wp, <span class="hljs-number">2</span>*wo, <span class="hljs-number">2</span>*wo, <span class="hljs-number">2</span>*wo&#125;);<br>        <span class="hljs-type">double</span> mu = <span class="hljs-number">0.1</span>; <span class="hljs-comment">// friction coefficient</span><br><br>        std::cout&lt;&lt;<span class="hljs-string">&quot;--Init finished. Press ctrl c to exit--&quot;</span>&lt;&lt;std::endl;<br><br>        <span class="hljs-keyword">while</span>(!symc::SignalManager::<span class="hljs-built_in">ShouldExit</span>())&#123;<br>            robot.<span class="hljs-built_in">getPosition</span>(vpRobot::JOINT_STATE, q);<br>            robot.<span class="hljs-built_in">getVelocity</span>(vpRobot::JOINT_STATE, q_dot);<br>            robot.<span class="hljs-built_in">getMass</span>(B);<br>            robot.<span class="hljs-built_in">getCoriolis</span>(C);<br>            robot.<span class="hljs-built_in">getFriction</span>(F);<br>            robot.<span class="hljs-built_in">get_fJe</span>(fJe); <span class="hljs-comment">// get Jacobian matrix in operational frame</span><br>            robot.<span class="hljs-built_in">getForceTorque</span>(vpRobot::JOINT_STATE, tau);<br>            <br>            fMed[<span class="hljs-number">1</span>][<span class="hljs-number">3</span>] = fMed0[<span class="hljs-number">1</span>][<span class="hljs-number">3</span>] + (sys_info.is_trajectory_started_ ? ( <span class="hljs-number">0.1</span> * <span class="hljs-built_in">sin</span>( <span class="hljs-number">2</span> * M_PI * <span class="hljs-number">0.3</span> * (sys_info.time_current_ - sys_info.time_start_trajectory_))) : <span class="hljs-number">0</span> );<br>            fMed[<span class="hljs-number">2</span>][<span class="hljs-number">3</span>] = fMed0[<span class="hljs-number">2</span>][<span class="hljs-number">3</span>] - (sys_info.is_trajectory_started_ ? ( <span class="hljs-number">0.05</span> * <span class="hljs-built_in">sin</span>( <span class="hljs-number">2</span> * M_PI * <span class="hljs-number">0.6</span> * (sys_info.time_current_ - sys_info.time_start_trajectory_))) : <span class="hljs-number">0</span>) ;<br>            x_dot_desired[<span class="hljs-number">1</span>] = (sys_info.is_trajectory_started_ ? (<span class="hljs-number">2</span> * M_PI * <span class="hljs-number">0.3</span> * <span class="hljs-number">0.1</span> * <span class="hljs-built_in">cos</span>( <span class="hljs-number">2</span> * M_PI * <span class="hljs-number">0.3</span> * (sys_info.time_current_ - sys_info.time_start_trajectory_))) : <span class="hljs-number">0</span>) ;<br>            x_dot_desired[<span class="hljs-number">2</span>] = (sys_info.is_trajectory_started_ ? (<span class="hljs-number">-2</span> * M_PI * <span class="hljs-number">0.6</span> * <span class="hljs-number">0.05</span> * <span class="hljs-built_in">cos</span>( <span class="hljs-number">2</span> * M_PI * <span class="hljs-number">0.6</span> * (sys_info.time_current_ - sys_info.time_start_trajectory_))) : <span class="hljs-number">0</span>) ;<br><br>            x_dot_dot_desired[<span class="hljs-number">1</span>] = (sys_info.is_trajectory_started_ ? (<span class="hljs-number">-2</span> * M_PI * <span class="hljs-number">0.3</span> * <span class="hljs-number">2</span> * M_PI * <span class="hljs-number">0.3</span> * <span class="hljs-number">0.1</span> * <span class="hljs-built_in">sin</span>( <span class="hljs-number">2</span> * M_PI * <span class="hljs-number">0.3</span> * (sys_info.time_current_ - sys_info.time_start_trajectory_))) : <span class="hljs-number">0</span>) ;<br>            x_dot_dot_desired[<span class="hljs-number">2</span>] = (sys_info.is_trajectory_started_ ? (<span class="hljs-number">2</span> * M_PI * <span class="hljs-number">0.6</span> * <span class="hljs-number">2</span> * M_PI * <span class="hljs-number">0.6</span> * <span class="hljs-number">0.05</span> * <span class="hljs-built_in">sin</span>( <span class="hljs-number">2</span> * M_PI * <span class="hljs-number">0.6</span> * (sys_info.time_current_ - sys_info.time_start_trajectory_))) : <span class="hljs-number">0</span>) ;<br><br>            edVf.<span class="hljs-built_in">insert</span>(fMed.<span class="hljs-built_in">getRotationMatrix</span>().<span class="hljs-built_in">t</span>(), <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>            edVf.<span class="hljs-built_in">insert</span>(fMed.<span class="hljs-built_in">getRotationMatrix</span>().<span class="hljs-built_in">t</span>(), <span class="hljs-number">3</span>, <span class="hljs-number">3</span>);<br>            <br><br>            fMe = robot.<span class="hljs-built_in">get_fMe</span>(); <span class="hljs-comment">// get end-effector pose</span><br>            vpPoseVector pose_error = <span class="hljs-built_in">static_cast</span>&lt;vpPoseVector&gt;(fMed.<span class="hljs-built_in">inverse</span>() * fMe); <span class="hljs-comment">// get error in cartesian space</span><br>            <br><br>            vpMatrix La = symc::<span class="hljs-built_in">Ta</span>(pose_error); <span class="hljs-comment">// compute Lie algebra</span><br>            <span class="hljs-comment">//<span class="hljs-doctag">TODO:</span>La*edVf is the matrix that can transform the velocity in operational frame to the velocity in world frame?</span><br>            Ja = La*edVf*fJe; <span class="hljs-comment">// compute Jacobian matrix in world frame</span><br>            <span class="hljs-keyword">if</span>(!symc::<span class="hljs-built_in">IsEqual</span>(sys_info.dt_, <span class="hljs-number">0</span>))&#123;<br>                Ja_dot = (Ja - Ja_old) / sys_info.dt_;<br>            &#125;<span class="hljs-keyword">else</span>&#123;<br>                Ja_dot = <span class="hljs-number">0</span>;<br>            &#125;<br>            Ja_old = Ja;<br>            <span class="hljs-comment">// weighted pseudo-inverse of the Jacobian matrix</span><br>            <span class="hljs-comment">// to optimize the control performance ?</span><br>            <span class="hljs-comment">// or to avoid singularity ?</span><br>            <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span>the formula is from the paper:</span><br>            Ja_pinv_B_t = (Ja * B.<span class="hljs-built_in">inverseByCholesky</span>()*Ja.<span class="hljs-built_in">t</span>()).<span class="hljs-built_in">inverseByCholesky</span>()*Ja*B.<span class="hljs-built_in">inverseByCholesky</span>();<br>            <br>            <span class="hljs-comment">// compute desired joint torque</span><br>            x_error = <span class="hljs-built_in">static_cast</span>&lt;vpColVector&gt;(pose_error); <span class="hljs-comment">// compute error in cartesian space</span><br>            x_dot_error = La*edVf*(x_dot_desired - fJe*q_dot); <span class="hljs-comment">// compute velocity error in cartesian space</span><br>            <span class="hljs-comment">// formula: tau = M(q)*q_dot_dot + C(q,q_dot) + F(q_dot) + G(q)</span><br>            <span class="hljs-comment">// Ja.pseudoInverse is the inverse of the Jacobian matrix</span><br>            <span class="hljs-comment">// which can transform cartesian space to joint space</span><br>            vpMatrix control_law = (-K*(x_error)+D*(x_dot_error)-Ja_dot*q_dot + x_dot_dot_desired);<br>            tau_desired = B*Ja.<span class="hljs-built_in">pseudoInverse</span>()* control_law + C + F - (I7 - Ja.<span class="hljs-built_in">t</span>()*Ja_pinv_B_t)*B*q_dot*<span class="hljs-number">100</span>;<br>            <span class="hljs-comment">// tau_desired = B*Ja.pseudoInverse()* control_law + C + F;</span><br>            <span class="hljs-keyword">if</span>(sys_info.is_first_)&#123;<br>                tau0 = tau_desired;<br>            &#125;<br>            tau_cmd = tau_desired - tau0*std::<span class="hljs-built_in">exp</span>(-mu*sys_info.time_current_ - sys_info.time_start_trajectory_);<br><br>            <span class="hljs-comment">// apply the desired joint torque</span><br>            robot.<span class="hljs-built_in">setForceTorque</span>(vpRobot::JOINT_STATE, tau_cmd);<br><br>            <span class="hljs-keyword">if</span>(opt_settings.verbose)&#123;<br>                std::cout&lt;&lt;<span class="hljs-string">&quot;dt: &quot;</span>&lt;&lt;sys_info.dt_&lt;&lt;std::endl;<br>            &#125;<br>            robot.<span class="hljs-built_in">wait</span>(sys_info.time_current_, <span class="hljs-number">0.001</span>); <span class="hljs-comment">// Sync loop at 1000 Hz (1 ms)</span><br>            sys_info.<span class="hljs-built_in">UpdateTime</span>(robot);<br>        &#125;<br>        symc::<span class="hljs-built_in">StopSimulation</span>(robot);<br>    &#125;<span class="hljs-built_in">catch</span>(<span class="hljs-type">const</span> vpException&amp; e)&#123;<br>        std::cout&lt;&lt;<span class="hljs-string">&quot;Catch an exception: &quot;</span>&lt;&lt;e.<span class="hljs-built_in">what</span>()&lt;&lt;std::endl;<br>        symc::<span class="hljs-built_in">StopSimulation</span>(robot);<br>        <span class="hljs-keyword">return</span> EXIT_FAILURE;<br>    &#125;<br>    std::cout&lt;&lt;<span class="hljs-string">&quot;--Exited--&quot;</span>&lt;&lt;std::endl;<br>    <span class="hljs-keyword">return</span> EXIT_SUCCESS;<br>&#125;<br></code></pre></td></tr></table></figure></p><h2 id="总结及推导">总结及推导</h2><h3 id="说明">说明</h3><p>这里直接跳过不太重要的部分，从字面意思即可理解其作用，重点说明while循环内的内容。</p><ul><li><p>下面以base frame指代基坐标系（位姿），end-effectorframe指代末端执行器坐标系（位姿），因为Homogeneous TransformationMatrix既可以表示变换也可以表示位姿，所以后面就不特意说明是位姿还是变换操作了。</p></li><li><p>用task space(cartesianspace)指代任务空间（也就是笛卡尔空间），用jointspace指代关节空间。</p></li></ul><p>下面逐行进行解释。</p><h3 id="初始化">初始化</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp">robot.<span class="hljs-built_in">getPosition</span>(vpRobot::JOINT_STATE, q);<br>robot.<span class="hljs-built_in">getVelocity</span>(vpRobot::JOINT_STATE, q_dot);<br>robot.<span class="hljs-built_in">getMass</span>(B);<br>robot.<span class="hljs-built_in">getCoriolis</span>(C);<br>robot.<span class="hljs-built_in">getFriction</span>(F);<br>robot.<span class="hljs-built_in">get_fJe</span>(fJe);<br>robot.<span class="hljs-built_in">getForceTorque</span>(vpRobot::JOINT_STATE, tau);<br><br></code></pre></td></tr></table></figure><p>这里通过调用visp_ros的接口获取franka的信息，其中：<br />* <em>getMass()</em> 指获取质量矩阵(inertia matrix, 惯性矩阵)<br />* <em>getCoriolis()</em> 指获取科里奥利力矩阵<br />* <em>getFriction()</em> 指获取摩擦力矩阵<br />* <em>get_fJe()</em> 指获取雅可比矩阵(Jacobianmatrix)，注意这里是关节空间下的雅可比矩阵</p><p>其他根据字面意思理解即可。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp">fMed[<span class="hljs-number">1</span>][<span class="hljs-number">3</span>] = fMed0[<span class="hljs-number">1</span>][<span class="hljs-number">3</span>] + (sys_info.is_trajectory_started_ ? ( <span class="hljs-number">0.1</span> * <span class="hljs-built_in">sin</span>( <span class="hljs-number">2</span> * M_PI * <span class="hljs-number">0.3</span> * (sys_info.time_current_ - sys_info.time_start_trajectory_))) : <span class="hljs-number">0</span> );<br>fMed[<span class="hljs-number">2</span>][<span class="hljs-number">3</span>] = fMed0[<span class="hljs-number">2</span>][<span class="hljs-number">3</span>] - (sys_info.is_trajectory_started_ ? ( <span class="hljs-number">0.05</span> * <span class="hljs-built_in">sin</span>( <span class="hljs-number">2</span> * M_PI * <span class="hljs-number">0.6</span> * (sys_info.time_current_ - sys_info.time_start_trajectory_))) : <span class="hljs-number">0</span>) ;<br>x_dot_desired[<span class="hljs-number">1</span>] = (sys_info.is_trajectory_started_ ? (<span class="hljs-number">2</span> * M_PI * <span class="hljs-number">0.3</span> * <span class="hljs-number">0.1</span> * <span class="hljs-built_in">cos</span>( <span class="hljs-number">2</span> * M_PI * <span class="hljs-number">0.3</span> * (sys_info.time_current_ - sys_info.time_start_trajectory_))) : <span class="hljs-number">0</span>) ;<br>x_dot_desired[<span class="hljs-number">2</span>] = (sys_info.is_trajectory_started_ ? (<span class="hljs-number">-2</span> * M_PI * <span class="hljs-number">0.6</span> * <span class="hljs-number">0.05</span> * <span class="hljs-built_in">cos</span>( <span class="hljs-number">2</span> * M_PI * <span class="hljs-number">0.6</span> * (sys_info.time_current_ - sys_info.time_start_trajectory_))) : <span class="hljs-number">0</span>) ;<br><br>x_dot_dot_desired[<span class="hljs-number">1</span>] = (sys_info.is_trajectory_started_ ? (<span class="hljs-number">-2</span> * M_PI * <span class="hljs-number">0.3</span> * <span class="hljs-number">2</span> * M_PI * <span class="hljs-number">0.3</span> * <span class="hljs-number">0.1</span> * <span class="hljs-built_in">sin</span>( <span class="hljs-number">2</span> * M_PI * <span class="hljs-number">0.3</span> * (sys_info.time_current_ - sys_info.time_start_trajectory_))) : <span class="hljs-number">0</span>) ;<br>x_dot_dot_desired[<span class="hljs-number">2</span>] = (sys_info.is_trajectory_started_ ? (<span class="hljs-number">2</span> * M_PI * <span class="hljs-number">0.6</span> * <span class="hljs-number">2</span> * M_PI * <span class="hljs-number">0.6</span> * <span class="hljs-number">0.05</span> * <span class="hljs-built_in">sin</span>( <span class="hljs-number">2</span> * M_PI * <span class="hljs-number">0.6</span> * (sys_info.time_current_ - sys_info.time_start_trajectory_))) : <span class="hljs-number">0</span>) ;<br><br></code></pre></td></tr></table></figure><p>设定参考轨迹，也就是目标轨迹，fMed,fMed0均是<em>vpHomogeneousMatrix</em>类型fMed[4][4]的index先是行再是列，与矩阵表示习惯相同。<br />这里贴一下<em>vpHomogeneousMatrix</em>类型的部分源码注释：</p><p>The class provides a data structure for the homogeneous matrices aswell as a set of operations on these matrices.</p><p>The vpHomogeneousMatrix class is derived fromvpArray2D&lt;double&gt;.</p><p>An homogeneous matrix is 4x4 matrix defines as <spanclass="math display">\[\left[^a{\bf M}_b = \left(\begin{array}{cc}^a{\bf R}_b &amp; ^a{\bf t}_b \\{\bf 0}_{1\times 3} &amp; 1\end{array}\right)\right]\]</span><br />that defines the position of frame <em>b</em> in frame <em>a</em></p><p><span class="math inline">\(^a{R}_b\)</span> is a rotation matrix and<span class="math inline">\(^a{t}_b\)</span> is a translationvector.</p><h3 id="矩阵更新">矩阵更新</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp">edVf.<span class="hljs-built_in">insert</span>(fMed.<span class="hljs-built_in">getRotationMatrix</span>().<span class="hljs-built_in">t</span>(), <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>edVf.<span class="hljs-built_in">insert</span>(fMed.<span class="hljs-built_in">getRotationMatrix</span>().<span class="hljs-built_in">t</span>(), <span class="hljs-number">3</span>, <span class="hljs-number">3</span>);<br></code></pre></td></tr></table></figure><p>TODO:这个没懂是干啥的，后面待补充。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp">fMe = robot.<span class="hljs-built_in">get_fMe</span>();<br>vpPoseVector pose_error = <span class="hljs-built_in">static_cast</span>&lt;vpPoseVector&gt;(fMed.<span class="hljs-built_in">inverse</span>() * fMe);<br></code></pre></td></tr></table></figure><p>通过 <em>get_fMe()</em> 获取franka的姿态(Homogeneous transformationmatrix)，然后计算与目标位姿的误差，fMed是上面设置的目标位姿。<br />为什么 <em>fMed.inverse() * fMe</em>得到的就是位姿误差？这里我的理解是fMed的形式应该是<spanclass="math inline">\(^{B}T_{D}\)</span>(目标位姿相对基坐标系)，fMe的形式<spanclass="math inline">\({B}T_{E}\)</span>(末端执行器位姿相对基坐标系)，通过左乘变换矩阵将fMe转换到目标坐标系下，即末端执行器相对目标坐标系的位姿表示，得到的即是位姿误差。<br />//TODO:这里理解可能是错误的</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp">vpMatrix La = symc::<span class="hljs-built_in">Ta</span>(pose_error);<br>Ja = La*edVf*fJe;<br><span class="hljs-keyword">if</span>(!symc::<span class="hljs-built_in">IsEqual</span>(sys_info.dt_, <span class="hljs-number">0</span>))&#123;<br>    Ja_dot = (Ja - Ja_old) / sys_info.dt_;<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>    Ja_dot = <span class="hljs-number">0</span>;<br>&#125;<br>Ja_old = Ja;<br></code></pre></td></tr></table></figure><p>通过 <em>Ta</em>函数输入的齐次变换矩阵（代表末端执行器位姿），计算李代数，李代数是用来表示变换群（如SO(3)和SE(3)）的无穷小变换（即微分形式）。返回的是6x6 的李代数矩阵，它表示了当前末端执行器位姿对应的微分变换。<br /><strong>它的作用是用于将6维的刚体运动（速度、力）从一个坐标系转换到另一个坐标系</strong><br />然后计算雅可比矩阵（Ja），<strong>注意fJe是上面获取的关节空间下的雅可比矩阵</strong>，通过左乘La*edVf将其转换到笛卡尔空间下，得到笛卡尔空间下的雅可比矩阵Ja。<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">Ja_pinv_B_t = (Ja * B.<span class="hljs-built_in">inverseByCholesky</span>()*Ja.<span class="hljs-built_in">t</span>()).<span class="hljs-built_in">inverseByCholesky</span>()*Ja*B.<span class="hljs-built_in">inverseByCholesky</span>();<br></code></pre></td></tr></table></figure></p><p>没看懂，根据chatgpt的说法，Ja_pinv_B_t是加权伪逆雅可比矩阵，其公式就是：<br /><span class="math display">\[Ja\_pinv\_B\_t=(Ja \cdot {B^{−1}}\cdotJa^{T})^{-1}\cdot Ja\cdot B^{-1}\]</span><br />贴一下它的解释：<br />这个表达式 Ja_pinv_B_t 是计算 加权伪逆雅可比矩阵的一种方式。加权伪逆（weightedpseudoinverse）是用于解决欠定或超定系统中的伪逆运算，其中矩阵不一定是方阵，且需要考虑特定权重。<br />伪逆雅可比矩阵在控制和运动学中用于求解欠定或冗余系统的逆运动学问题。在这种情况下，加权伪逆通过矩阵通过矩阵B引入了权重，使得解空间能够根据特定的权重进行优化。<br />加权伪逆的常见应用：<br />* 关节空间中的优化控制。<br />* 处理机器人冗余度时平衡关节的不同能量消耗或限制。<br />* 最小化在任务空间中实现运动时，关节空间中的力或速度。</p><p>该表达式通过Cholesky分解计算了加权伪逆雅可比矩阵。其目的是：<br />* 利用矩阵𝐵对雅可比矩阵进行加权，优化运动控制或冗余度处理。<br />* 使用Cholesky分解提升了计算效率，适用于正定对称矩阵𝐵的情境。</p><p>最终，Ja_pinv_B_t是雅可比矩阵的加权伪逆，它在机器人控制和运动学求解中用于优化和解决欠定或冗余问题。</p><h3 id="计算控制律">计算控制律</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp">x_error = <span class="hljs-built_in">static_cast</span>&lt;vpColVector&gt;(pose_error);<br>x_dot_error = La*edVf*(x_dot_desired - fJe*q_dot);<br></code></pre></td></tr></table></figure><p>在笛卡尔空间计算位置姿态误差和速度误差。<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">vpMatrix control_law = (-K*(x_error)+D*(x_dot_error)-Ja_dot*q_dot + x_dot_dot_desired);<br></code></pre></td></tr></table></figure> 通过阻抗控制计算控制律。<br />K项为刚度控制项，对位置误差施加恢复力，类似于弹簧的作用，推动机器人回到期望位置。<br />D项阻尼控制项，利用速度误差来增加阻尼，抑制振荡和不稳定行为。<br />-Ja_dot*q_dot雅可比矩阵的变化影响项，考虑了机器人关节速度和雅可比矩阵随时间变化的耦合效应。<br />x_dot_dot_desired期望加速度，直接给出系统应该达到的加速度目标。<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">tau_desired = B*Ja.<span class="hljs-built_in">pseudoInverse</span>()* control_law + C + F - (I7 - Ja.<span class="hljs-built_in">t</span>()*Ja_pinv_B_t)*B*q_dot*<span class="hljs-number">100</span>;<br></code></pre></td></tr></table></figure> 计算期望力矩，其公式为：<br /><span class="math display">\[\tau = M(q)\cdot \ddot{q} + C(q,\dot{q}) +F(\dot{q}) + G(q)\]</span><br />control_law左乘 <em>Ja.pseudoInverse()</em>是将control_law从笛卡尔空间转换到任务空间。<br />后面的-(I7 -Ja.t()*Ja_pinv_B_t)*B*q_dot*100根据chatgpt的解释是误差校正项，没看懂。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp">tau_cmd = tau_desired - tau0*std::<span class="hljs-built_in">exp</span>(-mu*sys_info.time_current_ - sys_info.time_start_trajectory_);<br>robot.<span class="hljs-built_in">setForceTorque</span>(vpRobot::JOINT_STATE, tau_cmd);<br></code></pre></td></tr></table></figure><p>计算真正的控制力矩tau_cmd，后面加上exp指数项是为了在启动时控制力矩是光滑的。</p>]]></content>
    
    
    <categories>
      
      <category>控制</category>
      
    </categories>
    
    
    <tags>
      
      <tag>仿真</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Rotation Matrix</title>
    <link href="/2024/09/05/Rotation-Matrix/"/>
    <url>/2024/09/05/Rotation-Matrix/</url>
    
    <content type="html"><![CDATA[<span id="more"></span><h2 id="性质和结论">性质和结论</h2><p><strong>从B frame相对于A frame的旋转矩阵的转置即为A frame相对于Bframe的旋转矩阵，同时等于其逆矩阵：</strong> <spanclass="math display">\[^{A}_{B}R = ^{B}_{A}A^{T}=^{B}_{A}A^{-1}\]</span><strong>旋转矩阵可以将一个点(P)从一个frame(B)变换到另一个frame(A)：</strong><span class="math display">\[^{A}P=^{A}_{B}R \cdot ^{B}P\]</span><strong>用坐标轴绕参考坐标系旋转角度来确定旋转矩阵：</strong> <spanclass="math display">\[R_{Z_{A}}({\theta})=\left[\begin{matrix}cos{\theta} &amp; -sin\theta &amp; 0 \\ sin{\theta} &amp; cos{\theta}&amp; 0 \\ 0 &amp; 0 &amp; 1 \end{matrix}\right]=\left[\begin{matrix}c{\theta} &amp; -s\theta &amp; 0 \\ s{\theta} &amp; c{\theta} &amp; 0 \\0 &amp; 0 &amp; 1 \end{matrix}\right]\]</span> <spanclass="math display">\[R_{X_{A}}({\theta})=\left[\begin{matrix} 1 &amp;0 &amp; 0 \\ 0 &amp; cos{\theta} &amp; -sin{\theta} \\ 0 &amp;sin{\theta} &amp; cos{\theta} \end{matrix}\right]=\left[\begin{matrix} 1&amp; 0 &amp; 0 \\ 0 &amp; c{\theta} &amp; -s{\theta} \\ 0 &amp;s{\theta} &amp; c{\theta} \end{matrix}\right]\]</span> <spanclass="math display">\[R_{Y_{A}}({\theta})=\left[\begin{matrix}cos{\theta} &amp; 0 &amp; sin{\theta} \\ 0 &amp; 1 &amp; 0 \\-sin{\theta} &amp; 0 &amp; cos{\theta}\end{matrix}\right]=\left[\begin{matrix} c{\theta} &amp; 0 &amp;s{\theta} \\ 0 &amp; 1 &amp; 0 \\ -s{\theta} &amp; 0 &amp; c{\theta}\end{matrix}\right]\]</span> <em>A表示Aframe，参考坐标系，即世界坐标系，B表示Bodyframe，本地坐标系，即物体坐标系。</em></p><p><strong>描述一个frame(B)相对另一个frame(A)的姿态：</strong> <spanclass="math display">\[^{A}_{B}R=\left[\begin{matrix} | &amp; | &amp; |\\ ^{A}X_{B} &amp; ^{A}Y_{B} &amp; ^{A}Z_{B} \\ | &amp; | &amp; |\end{matrix}\right]\]</span> <em>其中<spanclass="math inline">\(^{A}X_{B}\)</span>，<spanclass="math inline">\(^{A}Y_{B}\)</span>，<spanclass="math inline">\(^{A}Z_{B}\)</span>分别代表B frame各坐标轴在Aframe投影的列向量。</em></p><h2 id="fixed-angles">Fixed Angles</h2><p><strong>针对空间中固定的坐标系XYZ进行旋转操作：</strong> <spanclass="math display">\[^{A}_{B}R_{XYZ}(\gamma,\beta,\alpha)=R_{Z}(\alpha)R_{Y}(\beta)R_{X}(\gamma)\]</span><span class="math display">\[=\left[\begin{matrix} c{\alpha} &amp;-s\alpha &amp; 0 \\ s{\alpha} &amp; c{\alpha} &amp; 0 \\ 0 &amp; 0 &amp;1 \end{matrix}\right]\left[\begin{matrix} c{\beta} &amp; 0 &amp;s{\beta} \\ 0 &amp; 1 &amp; 0 \\ -s{\beta} &amp; 0 &amp; c{\beta}\end{matrix}\right]\left[\begin{matrix} 1 &amp; 0 &amp; 0 \\ 0 &amp;c{\gamma} &amp; -s{\gamma} \\ 0 &amp; s{\gamma} &amp; c{\gamma}\end{matrix}\right]\]</span> <spanclass="math display">\[=\left[\begin{matrix}c{\alpha}c{\beta} &amp;c{\alpha}s{\beta}s{\gamma}-s{\alpha}c{\gamma} &amp;c{\alpha}s{\beta}c{\gamma}+s{\alpha}s{\gamma} \\ s{\alpha}c{\beta} &amp;s{\alpha}s{\beta}s{\gamma}+c{\alpha}c{\gamma} &amp;s{\alpha}s{\beta}c{\gamma}-c{\alpha}s{\gamma}  \\-s{\beta} &amp;c{\beta}s{\gamma} &amp;c{\beta}c{\gamma}\end{matrix}\right]=\left[\begin{matrix}r_{11} &amp;r_{12} &amp; r_{13} \\ r_{21} &amp; r_{22} &amp; r_{23} \\ r_{31} &amp;r_{32} &amp; r_{33}\end{matrix}\right]\]</span></p><p><em>先转的放在后面，转动的顺序（左乘）是不能互换的。</em></p><p><strong>通过R推算Angles：</strong> <spanclass="math display">\[^{A}_{B}R_{XYZ}(\gamma,\beta,\alpha)=\left[\begin{matrix}c{\alpha}c{\beta}&amp; c{\alpha}s{\beta}s{\gamma}-s{\alpha}c{\gamma} &amp;c{\alpha}s{\beta}c{\gamma}+s{\alpha}s{\gamma} \\ s{\alpha}c{\beta} &amp;s{\alpha}s{\beta}s{\gamma}+c{\alpha}c{\gamma} &amp;s{\alpha}s{\beta}c{\gamma}-c{\alpha}s{\gamma}  \\-s{\beta} &amp;c{\beta}s{\gamma} &amp;c{\beta}c{\gamma}\end{matrix}\right]=\left[\begin{matrix}r_{11} &amp;r_{12} &amp; r_{13} \\ r_{21} &amp; r_{22} &amp; r_{23} \\ r_{31} &amp;r_{32} &amp; r_{33}\end{matrix}\right]\]</span> <spanclass="math inline">\(if\space{\beta} \neq 90^{\circ}\)</span> <spanclass="math display">\[\beta=Atan2(-r_{31},\sqrt{r_{11}^2+r_{21}^2})\]</span><spanclass="math display">\[\alpha=Atan2(\frac{r_{21}}{c{\beta}},\frac{r_{11}}{c{\beta}})\]</span><spanclass="math display">\[\gamma=Atan2(\frac{r_{32}}{c{\beta}},\frac{r_{33}}{c{\beta}})\]</span><span class="math inline">\(if \space \beta=90^{\circ}\)</span> <spanclass="math display">\[\alpha=0^{\circ}\]</span> <spanclass="math display">\[\gamma=Atan2(r_{12},r_{22})\]</span> <spanclass="math inline">\(if \space \beta=-90^{\circ}\)</span> <spanclass="math display">\[\alpha=0^{\circ}\]</span> <spanclass="math display">\[\gamma=-Atan2(r_{12},r_{22})\]</span></p><h2 id="euler-angles">Euler Angles</h2><p><strong>Z-Y-X</strong> <spanclass="math display">\[^{A}_{B}R_{Z^{&#39;}Y^{&#39;}X^{&#39;}}(\alpha,\beta,\gamma)=^{A}_{B^{&#39;}}R^{B^{&#39;}}_{B^{&#39;&#39;}}R^{B^{&#39;&#39;}}_{B}R=R_{Z^{&#39;}}(\alpha)R_{Y^{&#39;}}(\beta)R_{X^{&#39;}}(\gamma)\]</span><em>先转的放在前面，转动的顺序（左乘）是不能互换的。</em> <em>对FixedAngle以XYZ的顺序转动，相当于对Euler Angle以ZYX的顺序转动。</em><em>Euler Angle的正转和Fixed Angle的反转会得到相同的解。</em></p><h2 id="刚体状态的表达">刚体状态的表达</h2><p><strong>Homogeneous transformation matrix (4x4):</strong> <spanclass="math display">\[^{A}_{B}T=\left[\begin{matrix}^{A}_{B}R_{3\times3}&amp; ^{A}P_{B_{org}3\times1} \\ 0_{1\times3} &amp;1\end{matrix}\right]\]</span> <spanclass="math display">\[=\left[\begin{matrix} | &amp; | &amp; | &amp; |\\ ^{A}X_{B} &amp; ^{A}Y_{B} &amp; ^{A}Z_{B} &amp; P_{B_{org}} \\ |&amp; | &amp; | &amp; | \\ 0 &amp; 0 &amp; 0 &amp; 1\end{matrix}\right]\]</span><em>左上角为旋转矩阵，右上角为移动状态。</em></p><p><strong>移动和转动复合运算：</strong> <spanclass="math display">\[^{A}P_{3\times1}=^{A}_{B}R^{B}P_{3\times1}+^{A}P_{B_{org}3\times1}\]</span><span class="math display">\[\left[\begin{matrix}^{A}P \\1\end{matrix}\right]=^{A}_{B}T\left[\begin{matrix}^{B}P \\1\end{matrix}\right]\]</span></p><p><strong>可连续操作：</strong> <spanclass="math display">\[^{A}_{B}T=^{A}_{C}T^{C}_{D}T^{D}_{B}T\]</span><em>"sequential transformation"</em></p><p><strong>Mapping and Operator:</strong></p><p>transformationmatrix既有Mapping（把向量从一个frame转换到另一个frame下来看）的功能也可当作Operator对向量（或点）进行移动或旋转（在同一个frame）。</p><p><span class="math display">\[\left[\begin{matrix}^{A}P_2 \\1\end{matrix}\right]=T\left[\begin{matrix}^{A}P_1 \\1\end{matrix}\right]\]</span></p><h2 id="homogeneous-transformation-matrix的三种用法">Homogeneoustransformation matrix的三种用法</h2><ol type="1"><li>描述一个frame（相对于另一个frame）的空间状态。 <spanclass="math display">\[^{A}_{B}T=\left[\begin{matrix} | &amp; | &amp; |&amp; | \\ ^{A}X_{B} &amp; ^{A}Y_{B} &amp; ^{A}Z_{B} &amp; P_{B_{org}}\\ | &amp; | &amp; | &amp; | \\ 0 &amp; 0 &amp; 0 &amp; 1\end{matrix}\right]\]</span></li><li>将point由某一个frame的表达转换到另一个frame来表达。 <spanclass="math display">\[\left[\begin{matrix}^{A}P \\1\end{matrix}\right]=^{A}_{B}T\left[\begin{matrix}^{B}P \\1\end{matrix}\right]\]</span></li><li>将point(vector)在同一个frame中进行移动和转动。 <spanclass="math display">\[\left[\begin{matrix}^{A}P_2 \\1\end{matrix}\right]=T\left[\begin{matrix}^{A}P_1 \\1\end{matrix}\right]\]</span></li></ol><h2 id="transformation-matrix运算">Transformation Matrix运算</h2><p><strong>逆矩阵：</strong></p><p><spanclass="math display">\[^{A}_{B}T^{B}_{A}T=^{A}_{B}T^{A}_{B}T^{-1}=I_{4\times4}\]</span></p><p><spanclass="math display">\[^{A}_{B}T^{-1}=\left[\begin{matrix}^{A}_{B}R^{T}&amp; -^{A}_{B}{R^{T}}^{A}P_{B_{org}} \\ 0_{1\times3} &amp;1\end{matrix}\right]\]</span> <strong>连续运算法则：</strong></p><ol type="1"><li>{B}对{A}的转轴旋转：用"premultiply"，先转的放在后面</li><li>{B}对{B}自身的转轴旋转：用"postmultiply"，先转的放在前面</li></ol><h2 id="links">links</h2><p><a href="https://www.coursera.org/learn/robotics1">機器人學一(Robotics (1))</a></p>]]></content>
    
    
    <categories>
      
      <category>控制</category>
      
    </categories>
    
    
    <tags>
      
      <tag>理论</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CLF-CBF</title>
    <link href="/2024/09/04/CLF-CBF/"/>
    <url>/2024/09/04/CLF-CBF/</url>
    
    <content type="html"><![CDATA[<span id="more"></span><h2id="动态控制仿射系统dynamics-control-affine-system">1.动态控制仿射系统(DynamicsControl Affine System)</h2><p>对于<span class="math inline">\(\dot{x} =F(t,x,u)\)</span>，其中系统状态<spanclass="math inline">\(x\in{\mathbb{R}^n}\)</span>，系统输入<spanclass="math inline">\(u \in{\mathbb{R}^m}\)</span>，如果<spanclass="math inline">\(F\)</span>对于<spanclass="math inline">\(x\)</span>和<spanclass="math inline">\(u\)</span>是Lipschitz连续的，时间<spanclass="math inline">\(t\)</span>是piecewise连续的，那么在给定的初始条件<spanclass="math inline">\(x_0\)</span>下，轨迹<spanclass="math inline">\(x(t)\)</span>是存在并且unique的。</p><p>一般写成如下形式：</p><p><span class="math display">\[\dot{x} = f(x) + g(x)u\]</span></p><p>其中<spanclass="math inline">\(f:\mathbb{R}^n\rightarrow{\mathbb{R}^n},g:\mathbb{R}^n\rightarrow{\mathbb{R}^{n*m}}\)</span>，<spanclass="math inline">\(x\)</span>是Lipschitz连续，<spanclass="math inline">\(x_e = 0\)</span>。</p><h2 id="clfcontrol-lyapunov-function">2.CLF(Control LyapunovFunction)</h2><p>Lyapunove Function数学定义如下：</p><p><span class="math display">\[V(x)\]</span> <spanclass="math display">\[s.t. V(x_e) = 0, V(x) &gt; 0 \ for \ x \neqx_e\]</span> <span class="math display">\[\dot{V(x)} = \frac{\partialV}{\partial x}f(x) &lt; 0 \ for \ x \neq x_e\]</span></p><p><spanclass="math inline">\(V(x)\)</span>是定义的Lyapunov函数，下面的是约束条件，当满足上述两个约束时，我们可以认为x渐近稳定。</p><p>将输入<span class="math inline">\(u\)</span>引入到LyapunoveFunction，得到新的方程。 使<spanclass="math inline">\(V(x):\mathbb{R}^n\rightarrow{\mathbb{R}}\)</span>是连续Differential函数，如果存在一个常数<spanclass="math inline">\(c&gt;0\)</span>使得<spanclass="math inline">\(V(x)\)</span>满足如下条件，那么<spanclass="math inline">\(V(x)\)</span>就是一个关于<spanclass="math inline">\(x\)</span>的Control Lyapunov Function。</p><p><span class="math inline">\(1)\ \Omega := \{x\in{\mathbb{R}^n}:V(x)\le{c}\}\)</span>，<spanclass="math inline">\(V(x)\)</span>是有界的</p><p><span class="math inline">\(2)\ V(x)&gt;0\)</span>，对于所有的<spanclass="math inline">\(s\in{R^n}\backslash \{x_e\}\)</span>，<spanclass="math inline">\(V(e_e)=0\)</span></p><p><span class="math inline">\(3)\inf_{u\in{U}}\dot{V}(x,u)&lt;0\)</span>，对于所有的<spanclass="math inline">\(x\in{\Omega_c}\backslash\{x_e\}\)</span></p><p>为了简化<spanclass="math inline">\(\dot{V}(x,u)\)</span>的表达，用Lie括号描述：</p><p><span class="math display">\[\dot{V}(x,u) = \nabla{V}(x) * \dot{x} =\nabla{V}(x) * f(x) + \nabla{V}(x) * g(x)*u = L_fV(x) +L_gV(x)u\]</span> <spanclass="math display">\[(L_pq(x):=\nabla{q(x)}*p(x))\]</span></p><p>CLF保证系统最终会稳定，但不能确定多快才能稳定，这时候引入指数稳定CLF(ESCLF)。</p><p>如果存在常数<span class="math inline">\(\lambda &gt;0\)</span>使得<span class="math inline">\(inf_{u\in{U}}\dot{V}(x,u)+{\lambda}{V(x)}\le0\)</span> ，那么<spanclass="math inline">\(V(x)\)</span>就是ESCLF。</p><p><img src="/img/CLF-CBF/ESCLF.png" /></p><h2 id="clf-qp">3.CLF-QP</h2><p>将CLF转化为QP问题，搜索满足CLF-QP问题的输入u。</p><p><span class="math display">\[argmin\  (u-u_ref)^{T}{H(u-u_ref)}+p\delta^2\]</span> <spanclass="math display">\[subject\ to :\L_fV(x)+L_gV(x)u+\lambda{V(x)}\le{\delta}\]</span></p><p>其中<span class="math inline">\(\delta\)</span>是松弛变量，<spanclass="math inline">\(p\)</span>是惩罚因子，设置松弛变量的目的是在实际搜索中，较难找到一个合适的解，增加松弛变量后会放松CLF条件，在允许的情况下不满足CLF约束，但获得一个解。</p><p>另外，这里的H是Hassian矩阵，表示二次项系数，将<spanclass="math inline">\((u-u_ref)^{T}{H(u-u_ref)}\)</span>理解为二次的cost函数(或者能量函数？)，是人为构建的，二次保证解的u的输入使系统收敛较快。</p><h2 id="cbf">4.CBF</h2><p>CLF约束确保系统渐趋稳定，而CBF的作用是确保系统安全，使系统处于规定的安全集合约束内。</p><pre><code class="hljs">//TODO:补充CBF原理</code></pre><p>当<span class="math inline">\(B(x):\mathbb{R}^n \rightarrow\mathbb{R}\)</span>是连续可微的，零超水平集(zero-superlevel)为<spanclass="math inline">\(C\)</span>，<spanclass="math inline">\(C=\{x|B(x)\ge0\}\)</span>，对于所有<spanclass="math inline">\(x\in{\partial{C}}\)</span>，<spanclass="math inline">\(\nabla{B(x)\ne0}\)</span>，如果存在一个扩展<spanclass="math inline">\(Class \ K_\infty\)</span>函数<spanclass="math inline">\(\alpha\)</span>（工程中一般使用正常数和<spanclass="math inline">\(B(x)\)</span>的线性组合获取，如：<spanclass="math inline">\(\gamma{B(x)},\gamma&gt;0\)</span>），存在一个集合<spanclass="math inline">\(D\subset{\mathbb{R}^n}\)</span>，使得<spanclass="math inline">\(C\subset{D}\)</span>满足：</p><p><spanclass="math display">\[sup_{u\in{U}}[L_f{B(x)}+L_g{B(x)}u]+\alpha({B(x)})\ge0\]</span></p><p>那么对于所有<span class="math inline">\(x\in{D}\)</span>，<spanclass="math inline">\(B(x)\)</span>是一个CBF。</p><p><img src="/img/CLF-CBF/CBF.png" /></p><h2 id="clf-cbf-qp">5.CLF-CBF-QP</h2><p>将CLF和CBF都转化为QP问题的约束条件，其中CLF保证控制器稳定，CBF保证控制满足安全条件。</p><p><span class="math display">\[argmin\  (u-u_ref)^{T}{H(u-u_ref)}+p\delta^2\]</span> <spanclass="math display">\[subject\ to :\]</span> <spanclass="math display">\[\L_fV(x)+L_gV(x)u+\lambda{V(x)}\le{\delta}\]</span> <spanclass="math display">\[L_f{B(x)}+L_g{B(x)}u]+\gamma{B(x)}\ge0\]</span></p><h2 id="links">links</h2><ul><li><em><ahref="https://zhuanlan.zhihu.com/p/568328445">根据自适应巡航系统(ACC)来理解CBF(ControlBarrier Function)-入门知识</a></em><br /></li><li><em><a href="https://zhuanlan.zhihu.com/p/277326421">CLF-CBFController</a></em><br /></li><li><em><ahref="https://github.com/HybridRobotics/CBF-CLF-Helper">HybridRobotics/CBF-CLF-Helper</a></em><br /></li><li><em><a href="https://www.youtube.com/watch?v=_Tkn_Hzo4AA">Jason Choi-- Introduction to Control Lyapunov Functions and Control BarrierFunctions</a></em></li></ul>]]></content>
    
    
    <categories>
      
      <category>控制</category>
      
    </categories>
    
    
    <tags>
      
      <tag>理论</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>反步控制</title>
    <link href="/2024/09/04/%E5%8F%8D%E6%AD%A5%E6%8E%A7%E5%88%B6/"/>
    <url>/2024/09/04/%E5%8F%8D%E6%AD%A5%E6%8E%A7%E5%88%B6/</url>
    
    <content type="html"><![CDATA[<span id="more"></span><h2 id="物理模型">1.1 物理模型</h2><p>令期望轨迹为<span class="math inline">\(sint\)</span>曲线：<br /><span class="math display">\[x_d = \sin{t}\]</span> <spanclass="math display">\[\dot{x_d} = \cos{t}\]</span></p><p>写出状态方程：<br /><span class="math display">\[\dot{x_1} = x_2 + f_1(x_1)\]</span> <spanclass="math display">\[\dot{x_2} = u + f_2(x_1,x_2) = u + \frac{(M * g *l)}{J} * \sin{x_1} - \frac{D}{J} * x_2\]</span></p><p><span class="math display">\[f_1(x_1) = 0\]</span> <spanclass="math display">\[f_2(x_1,x_2) = \frac{(M * g * l)}{J} * \sin{x_1}- \frac{D}{J} * x_2\]</span>其中第一项为重力对系统的影响，第二项为摩擦力对系统的影响。</p><p><em>其中M为质量，g为重力加速度，l为臂长，J为转动惯量，D为阻尼系数。</em><em><span class="math inline">\(\dot{x_1}\)</span>为角速度，<spanclass="math inline">\(\dot{x_2}\)</span>为角加速度，<spanclass="math inline">\(x_1\)</span>为角度，<spanclass="math inline">\(x_2\)</span>为角速度。</em></p><h2 id="知识补充">1.2 知识补充</h2><p>力矩<span class="math inline">\(M = |F| * |r| *\sin{\varphi}\)</span>力矩除以转动惯量可以描述一个物体收到的外部力矩对其角加速度的影响。阻尼系数除以转动惯量乘以角速度描述了在转动运动中由阻尼产生的转动摩擦力的效应。这个物理量通常被称为阻尼比。</p><p><em>*部分解释来自chatgpt</em></p><h2 id="反步控制">2.1 反步控制</h2><p>构造误差 <span class="math display">\[e_1 = x_1 - x_d\]</span> <spanclass="math display">\[e_2 = x_2 - \alpha_1\]</span> 其中<spanclass="math inline">\(\alpha_1\)</span>为虚拟控制律，即中间状态的控制量。</p><p>构造Lyapunov函数 <span class="math display">\[V_1 =\frac{1}{2}{e_1}^2\]</span> <span class="math display">\[V_2 =\frac{1}{2}{e_1}^2 + \frac{1}{2}{e_2}^2\]</span></p><p>由Lyapunov方法可知，需令<spanclass="math inline">\(\dot{V_1}\)</span> ,<spanclass="math inline">\(\dot{V_2}\)</span>负定使得系统渐趋稳定。</p><p><span class="math display">\[\dot{V_1} = {e_1}\dot{e_1} ={e_1}(\dot{x_1} - \dot{x_d}) = {e_1}(x_2 + f_1(x_1) -\cos{t})\]</span></p><p>故令<span class="math inline">\(\alpha_1 = \cos{t} - e_1 -f_1(x_1)\)</span>，注意此时<spanclass="math inline">\(\alpha_1\)</span>为虚拟控制律，<spanclass="math inline">\(x_2\)</span>为实际控制</p><p><span class="math display">\[\dot{V_1} = {e_1}\dot{e_1} ={e_1}(\dot{x_1} - \dot{x_d})\]</span> <span class="math display">\[ ={e_1}(x_2 + f_1(x_1) - \cos{t}) = {e_1}(e_2 + \alpha_1 + f_1(x_1) -\cos{t}) = {e_1}(e_2 - e_1)\]</span></p><p><span class="math display">\[\dot{e_2} = \dot{x_2} - \dot{\alpha_1} =u + f_2(x_1,x_2) - \dot{\alpha_1}\]</span></p><p><span class="math display">\[\dot{V_2} = e_1(e_2 - e_1) +{e_2}\dot{e_2} = -{e_1}^2 + {e_2}({e_1} + \dot{e_2})\]</span></p><p>需令<span class="math inline">\(\dot{V_2}\)</span>负定，令<spanclass="math inline">\(e_1 + \dot{e_2} = -e_2\)</span>即可，此时<spanclass="math inline">\(\dot{V_2} = -{e_1}^2 - {e_2}^2\)</span>负定 代入得<span class="math inline">\(e_1 + u + f_2(x_1,x_2) - \alpha_1 =-e_2\)</span> 得到最终控制量<span class="math inline">\(u = -e_1 - e_2 -f_2(x_1,x_2) + \dot{\alpha_1}\)</span></p><p>上面得到 <span class="math display">\[f_1(x_1) = 0\]</span> <spanclass="math display">\[f_2(x_1,x_2) = \frac{(M * g * l)}{J} * \sin{x_1}- \frac{D}{J} * x_2\]</span></p><p>所以<span class="math display">\[u = -e_1 - e_2 + \dot{\alpha_1} -(\frac{(M * g * l)}{J} * \sin{x_1} - \frac{D}{J} * x_2)\]</span></p><h2 id="links">links</h2><ul><li><em><ahref="https://haosutopia.github.io/2018/01/Backstepping-01/">Backstepping（反步控制）</a></em></li><li><em><ahref="https://zh.wikipedia.org/wiki/%E5%8F%8D%E6%8E%A8%E6%8E%A7%E5%88%B6">wiki反推控制</a></em></li></ul>]]></content>
    
    
    <categories>
      
      <category>控制</category>
      
    </categories>
    
    
    <tags>
      
      <tag>理论</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>裂痕</title>
    <link href="/2024/09/03/%E8%A3%82%E7%97%95/"/>
    <url>/2024/09/03/%E8%A3%82%E7%97%95/</url>
    
    <content type="html"><![CDATA[<span id="more"></span><center>裂痕</center><center>边缘纹路生长，</center><center>哭泣的笑容，</center><center>过去的完整再无有几分存在。</center><center>爱或未来，</center><center>自甘地遗忘。</center><center>燃烧一盎司灵魂也无法弥补这急转隔断，</center><center>都不足一千公里的时间长。</center><center>笨拙的花张口结舌，</center><center>眼泪流淌。</center><center>几缕薄影倏忽而过，</center><center>哀荣四泻。</center><center>破碎，</center><center>月和目光。</center><center>源头是廉价的情感理想，</center><center>尾流入地海。</center><center>二到一到二，</center><center>无到有到无。</center><center>过度或翼翼滋生裂隙，</center><center>自产怒火惊雷，</center><center>静静撕咬。</center><center>曾是永远完整永远一起，</center><center>无有输赢，</center><center>而今却是谢幕时光。</center><center>痛苦急速转换，</center><center>一道无形的裂痕悄然而生，</center><center>自此疾驰。</center><center>幻想和秋风，</center><center>由我亲手斩断，</center><center>显现的裂痕，</center><center>存于你我各自世界之间</center>]]></content>
    
    
    <categories>
      
      <category>发电</category>
      
    </categories>
    
    
    <tags>
      
      <tag>poem</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
